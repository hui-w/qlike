function AnchorPoint(parent,x,y,firstController){this.parent=parent;this.svgGroup=null;this.x=x;this.y=y;this.selected=false;this.captured=false;this.highlighted=false;this.savedPosition={x:x,y:y};this.shapeSize=Config.AnchorPoint.width;this.shapeElement=null;this.ghostSize=Config.AnchorPoint.width*4;this.ghostElement=null;this.bezierFirstCtrl=null;this.bezierLastCtrl=null;if(firstController!=null){this.bezierFirstCtrl=null;this.bezierLastCtrl=null;this.addBezierCtrl(firstController.x,firstController.y,
false)}this.onAnchorChanged=null;this.selectingCtrl=null}
AnchorPoint.prototype={render:function(){if(!this.hasUI())return;var that=this;var transform="translate({0},{1})".format(this.x,this.y);this.svgGroup=this.parent.svgGroup.createChildNS("g",{"data-label":"Anchor Point Group","transform":transform});this.shapeElement=this.svgGroup.createChildNS("circle",{"x":-this.shapeSize/2,"y":-this.shapeSize/2,"r":this.shapeSize/2,"fill":Config.AnchorPoint.fill,"stroke":Config.AnchorPoint.stroke,"stroke-width":Config.AnchorPoint.strokeWidth});this.ghostElement=
this.svgGroup.createChildNS("rect",{"x":-this.ghostSize/2,"y":-this.ghostSize/2,"width":this.ghostSize,"height":this.ghostSize,"fill":"RGBA(255, 255, 255, 0)","stroke":"none"});workspace.getEventManager(this.ghostElement).addListener("capture",function(e,args){that.savedPosition={x:that.x,y:that.y};if(workspace.painting.toolType==ToolTypes.Picker)that.setCaptured(true);else if(workspace.painting.toolType==ToolTypes.Pen)that.parent.selectingPoint=that}).addListener("release",function(e,args){if(workspace.painting.toolType==
ToolTypes.Picker)that.setCaptured(false);else if(workspace.painting.toolType==ToolTypes.Pen);}).addListener("drag",function(e,args){var frame=that.parent.transFrame;var mappedOffset=frame.getMappedOffset(args.begin,args.current);if(workspace.painting.toolType==ToolTypes.Picker){var newX=QStage.alignToGrid(that.savedPosition.x+mappedOffset.x);var newY=QStage.alignToGrid(that.savedPosition.y+mappedOffset.y);that.movePointTo(newX,newY,true,true)}else if(workspace.painting.toolType==ToolTypes.Pen);}).addListener("doubleTap",
function(e,args){that.captureOnSelected(e)});if(this.bezierFirstCtrl!=null){this.bezierFirstCtrl.render();this.bezierFirstCtrl.setDisplay(false)}if(this.bezierLastCtrl!=null){this.bezierLastCtrl.render();this.bezierLastCtrl.setDisplay(false)}},hasUI:function(){return this.parent.getType()!=ShapeTypes.Freeline&&this.parent.getType()!=ShapeTypes.Rectangle&&this.parent.getType()!=ShapeTypes.Ellipse},getIndex:function(){for(var i=0;i<this.parent.anchorPoints.length;i++)if(this.parent.anchorPoints[i]==
this)return i;return-1},getBezierCtrl:function(isFirst){var controller=isFirst?this.bezierFirstCtrl:this.bezierLastCtrl;if(controller!=null)return{x:controller.x+this.x,y:controller.y+this.y};else return null},hasBezierCtrl:function(){var hasCtrl=this.bezierFirstCtrl!=null||this.bezierLastCtrl!=null;return hasCtrl},addBezierCtrl:function(x,y,renderImmediately){var that=this;this.bezierFirstCtrl=new BezierController(this,x,y);this.bezierFirstCtrl.onControllerChanged=function(){if(typeof that.onAnchorChanged==
"function")that.onAnchorChanged(false)};this.bezierLastCtrl=new BezierController(that,-x,-y);this.bezierLastCtrl.onControllerChanged=function(){if(typeof that.onAnchorChanged=="function")that.onAnchorChanged(false)};if(renderImmediately){this.bezierFirstCtrl.render();this.bezierLastCtrl.render()}},deleteBezierCtrl:function(){this.bezierFirstCtrl.destroy();this.bezierLastCtrl.destroy();this.bezierFirstCtrl=null;this.bezierLastCtrl=null;if(typeof this.onAnchorChanged=="function")this.onAnchorChanged(false)},
prepareBezierCtrl:function(mappedOffset){if(this.bezierFirstCtrl==null){this.addBezierCtrl(0,0,true);this.bezierLastCtrl.setCaptured(true)}else if(this.bezierLastCtrl.captured){var newX=QStage.alignToGrid(mappedOffset.x);var newY=QStage.alignToGrid(mappedOffset.y);this.bezierLastCtrl.moveControllerTo(newX,newY,false)}},isFirst:function(){return this.parent.anchorPoints[0]==this},isLast:function(){return this.parent.anchorPoints[this.parent.anchorPoints.length-1]==this},getNext:function(){if(this.parent.anchorPoints.length<
2)return null;if(this.isLast())return this.parent.anchorPoints[0];else return this.parent.anchorPoints[this.getIndex()+1]},getPrevious:function(){if(this.parent.anchorPoints.length<2)return null;if(this.isFirst())return this.parent.anchorPoints[this.parent.anchorPoints.length-1];else return this.parent.anchorPoints[this.getIndex()-1]},tipPointCapture:function(e){if(!Config.General.anchorTipNofified){Config.General.anchorTipNofified=true;var msg=[];msg.push("Double tapping on a point will:");msg.push("a) delete the Bezier control points if it has");
msg.push("b) delete itself if it has no Bezier control points");var point=workspace.drawingBoard.transformPoint({x:e.pageX+50,y:e.pageY+50});var g=workspace.drawingBoard.upperGroup.createChildNS("g",{"class":"no-select"});for(var i=0;i<msg.length;i++)g.createChildNS("text",{"x":point.x,"y":point.y+i*14,"fill":"#666666","font-size":"12px"},msg[i]);setTimeout(function(){g.parentNode.removeChild(g);g=null},1E4)}return true},destroy:function(){this.svgGroup.parentNode.removeChild(this.svgGroup);this.svgGroup=
null},movePoint:function(dx,dy,calcBoundary,isLast){this.x+=dx;this.y+=dy;this.movePointTo(this.x,this.y,calcBoundary,isLast)},movePointTo:function(x,y,calcBoundary,isLast){this.x=x;this.y=y;if(this.hasUI())this.svgGroup.setAttribute("transform","translate({0},{1})".format(this.x,this.y));if(isLast&&typeof this.onAnchorChanged=="function")this.onAnchorChanged(calcBoundary)},setDisplay:function(display){if(!this.hasUI())return;this.svgGroup.updateStyle("display",display?"block":"none")},showBezierControllers:function(show){if(this.bezierFirstCtrl!=
null){this.bezierFirstCtrl.setDisplay(show);this.bezierLastCtrl.setDisplay(show)}},setCaptured:function(captured){if(!this.hasUI())return;if(captured&&!this.captured){workspace.painting.selectingShape=this.parent;this.shapeElement.setAttribute("fill",Config.AnchorPoint.capturedFill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.capturedStroke);this.highlightOthers(true)}else if(!captured&&this.captured){this.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);this.shapeElement.setAttribute("stroke",
Config.AnchorPoint.stroke);this.highlightOthers(false)}this.ghostElement.updateStyle("cursor",captured?"crosshair":"default");this.captured=captured},setHighlighted:function(highlighted){if(!this.hasUI())return;if(highlighted&&!this.highlighted){this.shapeElement.setAttribute("fill",Config.AnchorPoint.highlightedFill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.highlightedStroke)}else if(!highlighted&&this.highlighted){this.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);
this.shapeElement.setAttribute("stroke",Config.AnchorPoint.stroke)}this.highlighted=highlighted},highlightOthers:function(highlighted){if(!this.hasUI())return;for(var i=0;i<this.parent.anchorPoints.length;i++){var anchor=this.parent.anchorPoints[i];if(anchor!=this)anchor.setHighlighted(highlighted)}},setSelected:function(selected){if(!this.selected&&selected){this.shapeElement.setAttribute("fill",Config.AnchorPoint.selectedFill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.selectedStroke);
if(this.hasBezierCtrl()){this.bezierFirstCtrl.setDisplay(true);this.bezierLastCtrl.setDisplay(true)}var nextAnchor=this.getNext();if(nextAnchor!=null){nextAnchor.shapeElement.setAttribute("fill",Config.AnchorPoint.followingFill);nextAnchor.shapeElement.setAttribute("stroke",Config.AnchorPoint.followingStroke)}}else if(this.selected&&!selected){this.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);this.shapeElement.setAttribute("stroke",Config.AnchorPoint.stroke);if(this.hasBezierCtrl()){this.bezierFirstCtrl.setDisplay(false);
this.bezierLastCtrl.setDisplay(false)}var nextAnchor=this.getNext();if(nextAnchor!=null){nextAnchor.shapeElement.setAttribute("fill",Config.AnchorPoint.fill);nextAnchor.shapeElement.setAttribute("stroke",Config.AnchorPoint.stroke)}}this.selected=selected},captureOnSelected:function(e){if(this.hasBezierCtrl()){this.tipPointCapture(e);this.deleteBezierCtrl()}else{this.tipPointCapture(e);this.parent.deletePoint(this)}}};
function BezierController(parent,x,y){this.parent=parent;this.svgGroup=null;this.x=x;this.y=y;this.captured=false;this.savedPosition={x:x,y:y};this.shapeSize=Config.BezierController.size;this.shapeElement=null;this.ghostSize=Config.BezierController.size*4;this.ghostElement=null;this.line=null;this.onControllerChanged=null}
BezierController.prototype={render:function(){var that=this;var transform="translate({0},{1})".format(this.x,this.y);this.svgGroup=this.parent.svgGroup.createChildNS("g",{"data-label":"Bezier Control Point Group","transform":transform},null,true);this.shapeElement=this.svgGroup.createChildNS("circle",{"cx":0,"cy":0,"r":this.shapeSize/2,"fill":Config.BezierController.fill,"stroke":Config.BezierController.stroke,"stroke-width":Config.BezierController.strokeWidth});this.ghostElement=this.svgGroup.createChildNS("rect",
{"x":-this.ghostSize/2,"y":-this.ghostSize/2,"width":this.ghostSize,"height":this.ghostSize,"fill":"RGBA(255, 255, 255, 0)","stroke":"none"});this.line=this.svgGroup.createChildNS("line",{"x1":0,"y1":0,"x2":-this.x,"y2":-this.y,"fill":"none","stroke":"RGBA(127,127,127,0.5)","stroke-width":1,"stroke-dasharray":"4,4"});workspace.getEventManager(this.ghostElement).addListener("capture",function(e,args){if(workspace.painting.toolType==ToolTypes.Pen){that.setCaptured(true);that.savedPosition={x:that.x,
y:that.y};var point=that.parent;var shape=point.parent;shape.selectingPoint=point;point.selectingCtrl=that}}).addListener("release",function(e,args){if(workspace.painting.toolType==ToolTypes.Pen)that.setCaptured(false)}).addListener("drag",function(e,args){if(workspace.painting.toolType==ToolTypes.Pen){var frame=that.parent.parent.transFrame;var d=frame.getMappedOffset(args.begin,args.current);var x=QStage.alignToGrid(that.savedPosition.x+d.x);var y=QStage.alignToGrid(that.savedPosition.y+d.y);that.moveControllerTo(x,
y,false)}})},moveControllerTo:function(x,y,passiveMove){this.x=x;this.y=y;this.svgGroup.setAttribute("transform","translate({0},{1})".format(this.x,this.y));this.line.setAttribute("x1",0);this.line.setAttribute("y1",0);this.line.setAttribute("x2",-this.x);this.line.setAttribute("y2",-this.y);if(!passiveMove){var peer=this.getPeer();if(peer!=null)peer.moveControllerTo(-x,-y,true)}if(typeof this.onControllerChanged=="function")this.onControllerChanged()},setDisplay:function(display){this.svgGroup.updateStyle("display",
display?"block":"none")},setCaptured:function(captured){this.captured=captured;if(captured){this.shapeElement.setAttribute("fill",Config.BezierController.capturedFill);this.shapeElement.setAttribute("stroke",Config.BezierController.capturedStroke);this.getPeer().setHighlighted(true)}else{this.shapeElement.setAttribute("fill",Config.BezierController.fill);this.shapeElement.setAttribute("stroke",Config.BezierController.stroke);this.getPeer().setHighlighted(false)}this.ghostElement.updateStyle("cursor",
captured?"crosshair":"default")},setHighlighted:function(highlighted){if(highlighted){this.shapeElement.setAttribute("fill",Config.BezierController.highlightedFill);this.shapeElement.setAttribute("stroke",Config.BezierController.highlightedStroke)}else{this.shapeElement.setAttribute("fill",Config.BezierController.fill);this.shapeElement.setAttribute("stroke",Config.BezierController.stroke)}},getPeer:function(){if(this.parent.bezierFirstCtrl==this)return this.parent.bezierLastCtrl;else return this.parent.bezierFirstCtrl},
destroy:function(){this.svgGroup.parentNode.removeChild(this.svgGroup);this.svgGroup=null}};function CanvasFrame(parent){this.parent=parent;this.svgGroup=null;this.transFrame=null;this.renderred=false}
CanvasFrame.prototype={resize:function(width,height){if(!this.renderred){this.render(width,height);this.renderred=true}},render:function(boardWidth,boardHeight){var that=this;var left=Config.CanvasFrame.marginLeft;var top=Config.CanvasFrame.marginTop;var width=boardWidth-Config.CanvasFrame.marginLeft-Config.CanvasFrame.marginRight;var height=boardHeight-Config.CanvasFrame.marginTop-Config.CanvasFrame.marginBottom;this.svgGroup=this.parent.createChildNS("g",{"data-label":"Group of CanvasFrame"});var transformInfo=
{position:{x:left,y:top},boundary:{left:0,top:0,right:width,bottom:height},rotation:{cx:0,cy:0,angle:0}};this.transFrame=new TransformableFrame(this.svgGroup,transformInfo,true);this.transFrame.setProperty("rotatable",false);this.shapeElement=this.svgGroup.createChildNS("rect",{"data-label":"CanvasFrame","x":left,"y":top,"width":width,"height":height,"fill":Config.General.drawingBackground,"stroke":Config.CanvasFrame.borderColor,"stroke-width":1,"stroke-dasharray":Config.CanvasFrame.borderDashArray});
this.transFrame.addEventListener("boundarychange",function(args){var boundary=QStage.enhanceBoundary(args.newBoundary,true);that.shapeElement.setAttribute("x",boundary.left-.5);that.shapeElement.setAttribute("y",boundary.top-.5);that.shapeElement.setAttribute("width",boundary.width+1);that.shapeElement.setAttribute("height",boundary.height+1);workspace.autoSave()});this.transFrame.addEventListener("positionchange",function(args){workspace.autoSave()});this.transFrame.render();workspace.getEventManager(this.shapeElement).addListener("capture",
function(e,args){if(that.transFrame.enabled)that.transFrame.captureHandle(2,0,true)}).addListener("release",function(e,args){if(that.transFrame.enabled)that.transFrame.captureHandle(2,0,false)}).addListener("drag",function(e,args){if(that.transFrame.enabled){var x=QStage.alignToGrid(that.transFrame.savedStatus.position.x+args.begin.dx);var y=QStage.alignToGrid(that.transFrame.savedStatus.position.y+args.begin.dy);that.transFrame.moveTo(x,y,true)}});this.setEnabled(false)},reset:function(boardWidth,
boardHeight){var left=Config.CanvasFrame.marginLeft;var top=Config.CanvasFrame.marginTop;var width=boardWidth-Config.CanvasFrame.marginLeft-Config.CanvasFrame.marginRight;var height=boardHeight-Config.CanvasFrame.marginTop-Config.CanvasFrame.marginBottom;this.transFrame.moveTo(left,top,true);this.transFrame.transformTo(0,0,width,height,true)},setEnabled:function(enabled){this.transFrame.setEnabled(enabled)}};var ShapeTypes={Other:0,Line:1,Rectangle:2,Ellipse:4,Polygon:8,Polyline:16,Freeline:32,Label:64};
var ToolTypes={None:0,Picker:1,Move:2,Crop:4,Line:8,Rectangle:16,Ellipse:32,Polygon:64,Pencil:128,Pen:256,Label:512,Map:1024,Poi:2048,Block:4096,Eraser:8192};var SerializeType={TypeOnly:1,Abstract:2,JSON:4,SVG:8,Canvas:16};function clone(obj){if(typeof obj=="function"||Object(obj)!==obj)return obj;var res=new obj.constructor;for(var key in obj)if(obj.hasOwnProperty(key))res[key]=clone(obj[key]);return res}
function getType(x){if(x==null)return"null";var t=typeof x;if(t!="object")return t;var c=Object.prototype.toString.apply(x);c=c.substring(8,c.length-1);if(c!="Object")return c;if(x.constructor==Object)return c;if("classname"in x.prototype.constructor&&typeof x.prototype.constructor.classname=="string")return x.constructor.prototype.classname;return"<unknown type>"}function isRefType(value){var type=getType(value);return type=="Object"||type=="Array"}
(function(){var QStage={extend:function(obj){for(var key in obj){if(!obj.hasOwnProperty(key))continue;this[key]=obj[key]}}};QStage.extend({$:function(){var elements=new Array;for(var i=0;i<arguments.length;i++){var element=arguments[i];if(typeof element=="string")element=document.getElementById(element);if(arguments.length==1)return element;elements.push(element)}return elements},rand:function(lower,upper){return Math.floor(Math.random()*(upper-lower+1))+lower},round:function(value){return value},
buildPathCommand:function(cmd,args){var str=cmd;if(args==null||args.length==0)str+=" ";else if(args.length==1)str+="{0} ".format(args[0]);else for(var i=0;i<args.length;i+=2){var x=args[i];var y=args[i+1];str+="{0},{1} ".format(x,y)}return str},getQueryStringByName:function(name,url){if(url==null)url=location.search;var result=url.match(new RegExp("[?&]"+name+"=([^&]+)","i"));if(result==null||result.length<1)return null;else return result[1]},setUrlHash:function(name,value){var hash=window.location.hash;
if(hash.length<=0)window.location.hash=name+"="+value;else{var pattern=name+"=([^&]+)";if(value==null){window.location.hash=hash.replace(new RegExp(pattern,"i"),"");return}var result=hash.match(new RegExp(pattern,"i"));if(result==null||result.length<1)window.location.hash+="&"+name+"="+value;else window.location.hash=hash.replace(new RegExp(pattern,"i"),name+"="+value)}},getUrlHash:function(name,url){if(url==null)url=window.location.hash;var result=url.match(new RegExp("[#&]"+name+"=([^&]+)","i"));
if(result==null||result.length<1)return null;else return result[1]},alignToGrid:function(v){if(Config.General.snapToGrid)return Math.round(v/Config.General.gridSize)*Config.General.gridSize;else return v},generateNewProjectId:function(){if(Config.General.offlineMode===true){var now=new Date;var year=now.getFullYear();var month=("0"+(now.getMonth()+1)).slice(-2);var day=("0"+now.getDate()).slice(-2);var hour=("0"+now.getHours()).slice(-2);var minute=("0"+now.getMinutes()).slice(-2);var second=("0"+
now.getSeconds()).slice(-2);return year+month+day+hour+minute+second}else return"N"},brushToRgba:function(brush){return brush.color.toColorRgba(brush.opacity)},enhanceBoundary:function(boundary,forcePositive){var left=boundary.left;var top=boundary.top;var right=boundary.right;var bottom=boundary.bottom;var width=right-left;var height=bottom-top;if(forcePositive&&width<0){width*=-1;left=right;right=left+width}if(forcePositive&&height<0){height*=-1;top=bottom;bottom=top+height}return{left:left,top:top,
right:right,bottom:bottom,width:width,height:height,cx:left+width/2,cy:top+height/2,rx:width/2,ry:height/2}},supportsTransitions:function(){var b=document.body||document.documentElement,s=b.style,p="transition",e={Webkit:"webkitTransitionEnd",Moz:"transitionend",O:"oTransitionEnd otransitionend",ms:"MSTransitionEnd",default:"transitionend"},v=["Moz","Webkit","O","ms"];if(typeof s[p]=="string")return{prefixedProperty:p,prefixedEventName:e["default"]};p=p.charAt(0).toUpperCase()+p.substr(1);for(var i=
0;i<v.length;i++)if(typeof s[v[i]+p]=="string")return{prefixedProperty:"-"+v[i].toLowerCase()+"-"+p.toLowerCase(),prefixedEventName:e[v[i]]};return false},isLocal:function(){var protocol=document.location.protocol;return protocol!="https:"&&protocol!="http:"},getAppUrl:function(){var url="./";if(QStage.isLocal())url+="index.html";return url},isValidId:function(id){return id!=null&&id.length==32},sendPostRequest:function(url,params,succCallback,errCallback){var xmlhttp=new XMLHttpRequest;xmlhttp.onreadystatechange=
function(){if(xmlhttp.readyState==4)if(xmlhttp.status==200){if(typeof succCallback=="function")succCallback(xmlhttp.responseText)}else if(typeof errCallback=="function")errCallback(xmlhttp.status)};xmlhttp.open("POST",url,true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send(params)}});window.QStage=QStage})();String.prototype.format=function(){var args=arguments;return this.replace(/\{(\d+)\}/g,function(m,i){return args[i]})};
String.prototype.trim=function(){return this.replace(/^(\s|\u00A0)+/,"").replace(/(\s|\u00A0)+$/,"")};Array.prototype.forEach=function(func){for(var i=0;i<this.length;i++){var item=this[i];if(typeof func=="function")func.call(this,item)}};
Date.prototype.Format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(fmt))fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));for(var k in o)if((new RegExp("("+k+")")).test(fmt))fmt=fmt.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length));return fmt};
Element.prototype.attr=function(params,value){if(!params){if(this.nodeType!=1)return{text:this.nodeValue};var attr=this.attributes,out={};for(var i=0,ii=attr.length;i<ii;i++)out[attr[i].nodeName]=attr[i].nodeValue;return out}if(Util.is(params,"string"))if(arguments.length>1){var json={};json[params]=value;params=json}else return this.getAttribute(params);for(var att in params)if(params["hasOwnProperty"](att))this.setAttribute(att,params[att]);return this};
Element.prototype.createChildNS=function(tag,param,textContent,addToFirst){var svgns="http://www.w3.org/2000/svg";var element=document.createElementNS(svgns,tag);if(addToFirst&&this.hasChildNodes())this.insertBefore(element,this.firstChild);else this.appendChild(element);if(param)for(var key in param)element.setAttribute(key,param[key]);if(textContent)element.textContent=textContent;return element};
Element.prototype.createChild=function(tag,param,textContent,addToFirst){var element=document.createElement(tag);if(addToFirst&&this.hasChildNodes())this.insertBefore(element,this.firstChild);else this.appendChild(element);if(param)for(var key in param)element.setAttribute(key,param[key]);if(textContent)element.textContent=textContent;return element};Element.prototype.hasClassName=function(a){return(new RegExp("(?:^|\\s+)"+a+"(?:\\s+|$)")).test(this.className)};
Element.prototype.addClassName=function(a){if(!this.hasClassName(a))this.className=[this.className,a].join(" ")};Element.prototype.removeClassName=function(b){if(this.hasClassName(b)){var a=this.className;this.className=a.replace(new RegExp("(?:^|\\s+)"+b+"(?:\\s+|$)","g")," ")}};
Element.prototype.getStyle=function(key){var style=this.getAttribute("style");if(style!=null&&style.trim().length>0){var keyValuePairs=style.split(";");for(var i=0;i<keyValuePairs.length&&keyValuePairs[i].trim().length>0;i++){var keyAndValue=keyValuePairs[i].split(":");if(keyAndValue.length!=2)continue;if(key==keyAndValue[0].trim())return keyAndValue[1].trim()}}return null};
Element.prototype.updateStyle=function(key,value){var oldStyle=this.getAttribute("style");var keyExisting=false;var newStyle="";if(oldStyle!=null&&oldStyle.trim().length>0){var keyValuePairs=oldStyle.split(";");for(var i=0;i<keyValuePairs.length&&keyValuePairs[i].trim().length>0;i++){var keyAndValue=keyValuePairs[i].split(":");if(keyAndValue.length!=2)continue;if(key==keyAndValue[0].trim()){keyExisting=true;if(value!=null)newStyle+=key+": "+value+"; ";else;}else newStyle+=keyAndValue[0].trim()+": "+
keyAndValue[1].trim()+"; "}}if(!keyExisting)newStyle+=key+": "+value+"; ";this.setAttribute("style",newStyle)};String.prototype.isRGBCode=function(alpha){var sColor=this.toLowerCase();var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;return sColor&&reg.test(sColor)};
String.prototype.toColorRgba=function(alpha){var sColor=this.toLowerCase();var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1)sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));sColor=sColorNew}var sColorChange=[];for(var i=1;i<7;i+=2)sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));return"RGBA("+sColorChange.join(",")+","+alpha+")"}else return sColor};
String.prototype.toColorHex=function(){var aColor=this.replace(/rgba|RGBA|\(|\)/g,"").split(",");if(aColor.length!=4)return{color:"#000000",opacity:0};else{var strHex="#";for(var i=0;i<3;i++){var hex=Number(aColor[i]).toString(16);if(Number(aColor[i])<16)hex="0"+hex;strHex+=hex}var opacity=aColor[3];return{color:strHex,opacity:opacity}}};var canvasPrototype=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;
canvasPrototype.antiFuzzyLine=function(x1,y1,x2,y2){if(this.lineWidth==1){x1+=.5;y1+=.5;x2+=.5;y2+=.5}this.moveTo(x1,y1);this.lineTo(x2,y2)};canvasPrototype.fillTextWithRotate=function(text,x,y,angle,horizontalAlign,verticalAlign){this.save();this.translate(x,y);this.rotate(angle);this.fillTextEx(text,0,0,horizontalAlign,verticalAlign);this.restore()};
canvasPrototype.fillTextEx=function(text,x,y,horizontalAlign,verticalAlign){this.save();var textLeft=x;if(horizontalAlign!="left"){var textWidth=this.measureText(text).width;if(horizontalAlign=="center")textLeft-=textWidth/2;else if(horizontalAlign=="right")textLeft-=textWidth}this.textBaseline=verticalAlign;this.fillText(text,textLeft,y);this.restore()};
(function(){var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};var extendFunction=function(prop){var _super=this.prototype;initializing=true;var prototype=new this;initializing=false;for(var name in prop)prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}}(name,
prop[name]):prop[name];function Class(){if(!initializing&&this.init)this.init.apply(this,arguments)}Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=extendFunction;return Class};Class.extend=extendFunction})();
function Icon(stage,id){this.stage=stage;this.id=id;this.size=stage.width+stage.height;this.stageManaged=false;this.position={x:stage.width/2,y:stage.height/2,angle:0};console.log(this.position.x);this.samplePosition={x:0,y:0};this.speed={x:0,y:0,angle:0};this.angle=0;this.group=null;this.ghost=null;this.blocks=[];this.config={finalSize:60,fadeInDelay:20,sampleSpeedDelay:20,airRate:.99,otherCollisionRate:.9,boundaryCollisionRate:.9,gravityIncrease:1};this.interval=null;this.timer=null;this.render();
this.fadeIn()}
Icon.prototype={render:function(){this.group=this.stage.group.createChildNS("g",{"data-label":"Animation Icon","transform":"translate({0},{1})".format(this.position.x-this.size/2,this.position.y-this.size/2)});var path=this.getBlockPath();var padding=this.getBlockPadding();this.blocks[0]=this.group.createChildNS("path",{"fill":"#22CB20","stroke":"#22CB20","stroke-width":padding,"stroke-linejoin":"round","d":path});this.blocks[1]=this.group.createChildNS("path",{"fill":"#06ACD4","stroke":"#06ACD4","stroke-width":padding,
"stroke-linejoin":"round","d":path,transform:this.getBlockTransform(1)});this.blocks[2]=this.group.createChildNS("path",{"fill":"#FFCC00","stroke":"#FFCC00","stroke-width":padding,"stroke-linejoin":"round","d":path,transform:this.getBlockTransform(2)});this.blocks[3]=this.group.createChildNS("path",{"fill":"#FA5151","stroke":"#FA5151","stroke-width":padding,"stroke-linejoin":"round","d":path,transform:this.getBlockTransform(3)});this.ghost=this.group.createChildNS("rect",{"x":0,"y":0,"width":this.size,
"height":this.size,"fill":"RGBA(255,255,255,0)","stroke":"none","style":"cursor: pointer"});this.attachEventHandlers()},attachEventHandlers:function(){var that=this;workspace.getEventManager(this.ghost).addListener("capture",function(e,args){that.stageManaged=false;that.samplePosition={x:that.position.x,y:that.position.y};that.startInterval(function(){console.log("Sampling Speed Interval");that.speed={x:(that.position.x-that.samplePosition.x)*that.stage.config.intervalDelay/that.config.sampleSpeedDelay,
y:(that.position.y-that.samplePosition.y)*that.stage.config.intervalDelay/that.config.sampleSpeedDelay,angle:0};that.samplePosition={x:that.position.x,y:that.position.y}},that.config.sampleSpeedDelay)}).addListener("drag",function(e,args){that.moveIcon(args.previous.dx,args.previous.dy,0,null,true)}).addListener("release",function(e,args){that.stageManaged=true;that.stopInterval();that.ensurePositionAvailablity()})},startInterval:function(callback,timerDelay){this.stopInterval();this.interval=setInterval(callback,
timerDelay)},stopInterval:function(){if(this.interval!=null){clearInterval(this.interval);this.interval=null}},ensurePositionAvailablity:function(){var attemptX=this.position.x;var attemptY=this.position.y;var attemptNum=0;while(!this.isAvailablePosition(attemptX,attemptY)){attemptNum++;var r=Math.ceil(attemptNum/4)*this.size;switch(attemptNum%4){case 0:attemptX=this.position.x+r;attemptY=this.position.y;break;case 1:attemptX=this.position.x;attemptY=this.position.y+r;break;case 2:attemptX=this.position.x-
r;attemptY=this.position.y;break;case 3:attemptX=this.position.x;attemptY=this.position.y-r;break}}if(this.position.x!=attemptX||this.position.y!=attemptY){this.position.x=attemptX;this.position.y=attemptY;this.updateGroupTransform()}},getThreateningIcons:function(){var others=[];for(var i=0;i<this.stage.icons.length;i++){var other=this.stage.icons[i];if(this==other||!other.stageManaged)continue;others.push(other)}return others},isOverlappedWith:function(x,y,icon){var distance=Math.sqrt(Math.pow(x-
icon.position.x,2)+Math.pow(y-icon.position.y,2));return distance<this.size},isAvailablePosition:function(x,y){if(x-this.size/2<this.stage.boundary.left||x+this.size/2>this.stage.boundary.right||y-this.size/2<this.stage.boundary.top||y+this.size/2>this.stage.boundary.bottom)return;var others=this.getThreateningIcons();for(var i=0;i<others.length;i++){var other=others[i];if(this.isOverlappedWith(x,y,other))return false}return true},getBlockPath:function(){var size=this.size;var padding=this.getBlockPadding();
var path="M{0},{1} H{2} L {3},{4} H {0} Z".format(size/3+padding,padding,size*2/3,size-padding,size/3-padding);return path},getBlockPadding:function(){return this.size*10/300},getBlockTransform:function(index){var size=this.size;return"translate(0,0), rotate({1},{0},{0})".format(size/2,index*90)},fadeIn:function(){var that=this;function handler(){console.log("Fade In Timer");if(that.size<=that.config.finalSize){that.size=that.config.finalSize;that.stageManaged=true;that.ensurePositionAvailablity()}else{that.resizeTo(that.size*
.95);that.timer=setTimeout(handler,that.config.fadeInDelay)}}this.timer=setTimeout(handler,this.config.fadeInDelay)},resizeTo:function(size){this.size=size;for(var i=0;i<this.blocks.length;i++){this.blocks[i].setAttribute("d",this.getBlockPath());this.blocks[i].setAttribute("stroke-width",this.getBlockPadding());this.blocks[i].setAttribute("transform",this.getBlockTransform(i))}this.updateGroupTransform();this.ghost.setAttribute("width",this.size);this.ghost.setAttribute("height",this.size)},updateGroupTransform:function(){this.group.setAttribute("transform",
"translate({0},{1}) rotate({2},{3},{3})".format(this.position.x-this.size/2,this.position.y-this.size/2,this.position.angle,this.size/2))},landed:function(){return this.speed.x==0&&this.speed.y==0&&this.speed.angle==0&&this.position.y==this.stage.boundary.bottom-this.size/2},moveIcon:function(dx,dy,dAngle,status,ignoreCollide){if(status==null)status=this.getNextStepStatus(dx,dy);var actualMove={dx:dx,dy:dy,dAngle:dAngle};var radius=this.size/2;if(status.collideTop){this.position.y=this.stage.boundary.top+
radius;actualMove.dy=this.stage.boundary.top+radius-this.position.y}else if(status.collideBottom){this.position.y=this.stage.boundary.bottom-radius;actualMove.dy=this.stage.boundary.bottom-radius-this.position.y}if(status.collideLeft){this.position.x=this.stage.boundary.left+radius;actualMove.dx=this.stage.boundary.left+radius-this.position.x}else if(status.collideRight){this.position.x=this.stage.boundary.right-radius;actualMove.dx=this.stage.boundary.right-radius-this.position.x}if(status.collideObjects.length>
0&&this.stageManaged&&!ignoreCollide)for(var i=0;i<status.collideObjects.length;i++){var other=status.collideObjects[i];var sX=Math.abs(this.speed.x)+Math.abs(other.speed.x)*this.config.otherCollisionRate;var sY=Math.abs(this.speed.y)+Math.abs(other.speed.y)*this.config.otherCollisionRate;this.speed.x=(this.speed.x>0?-1:1)*sX/2;this.speed.y=(this.speed.y>0?-1:1)*sY/2;other.speed.x=-this.speed.x;other.speed.y=-this.speed.y;actualMove.dx=0;actualMove.dy=0}this.position.x+=actualMove.dx;this.position.y+=
actualMove.dy;this.position.angle+=actualMove.dAngle;this.updateGroupTransform();return actualMove},getNextStepStatus:function(dx,dy){var status={collideTop:false,collideLeft:false,collideRight:false,collideBottom:false,collideObjects:[]};var radius=this.size/2;var testX=this.position.x+this.speed.x;var testY=this.position.y+this.speed.y;if(testX-radius<this.stage.boundary.left)status.collideLeft=true;else if(testX+radius>this.stage.boundary.right)status.collideRight=true;if(testY-radius<this.stage.boundary.top)status.collideTop=
true;else if(testY+radius>this.stage.boundary.bottom)status.collideBottom=true;var others=this.getThreateningIcons();for(var i=0;i<others.length;i++){var other=others[i];if(this.isOverlappedWith(testX,testY,other))status.collideObjects.push(other)}return status},handleStageInterval:function(){if(!this.stageManaged)return;if(!this.landed())this.speed.y+=this.config.gravityIncrease;if(Math.abs(this.speed.x)<1)this.speed.x=0;if(Math.abs(this.speed.y)<1)this.speed.y=0;if(Math.abs(this.speed.angle)<1)this.speed.angle=
0;if(this.speed.x==0&&this.speed.y==0&&this.speed.angle==0)return;var status=this.getNextStepStatus(this.speed.x,this.speed.y);this.moveIcon(this.speed.x,this.speed.y,this.speed.angle,status,false);this.changeSpeedByAir();this.handleBoundaryCollision(status)},handleBoundaryCollision:function(status){if(status.collideTop){this.speed.y*=-this.config.boundaryCollisionRate;this.speed.angle=-this.speed.x;this.position.y=this.stage.boundary.top+this.size/2}else if(status.collideBottom){this.speed.y*=-this.config.boundaryCollisionRate;
this.speed.angle=this.speed.x;this.position.y=this.stage.boundary.bottom-this.size/2}if(status.collideLeft){this.speed.x*=-this.config.boundaryCollisionRate;this.speed.angle=this.speed.y;this.position.x=this.stage.boundary.left+this.size/2}else if(status.collideRight){this.speed.x*=-this.config.boundaryCollisionRate;this.speed.angle=-this.speed.y;this.position.x=this.stage.boundary.right-this.size/2}},changeSpeedByAir:function(){this.speed.x*=this.config.airRate;this.speed.y*=this.config.airRate;
this.speed.angle*=this.config.airRate}};function Stage(parent,width,height){this.parent=parent;this.width=width;this.height=height;this.boundary={left:0,top:0,right:width,bottom:height};this.group=null;this.icons=[];this.config={timerDelayNormal:25,timerDelayLazy:200,intervalDelay:20};this.interval=null;this.destroied=false;this.timerCounter=0;this.maxTimerCounter=-1;this.render()}
Stage.prototype={render:function(){this.group=this.parent.createChildNS("g",{"data-label":"Animation Stage"});this.initTimer()},initTimer:function(){var that=this;var timeHandler=function(){this.timerCounter++;console.log("Stage Timer");var noneInMotion=true;for(var i=0;i<that.icons.length;i++){that.icons[i].handleStageInterval();if(!that.icons[i].landed())noneInMotion=false}var forceStopForDebugging=that.maxTimerCounter!=-1&&that.timerCount>=that.maxTimerCounter;if(!that.destroied&&!forceStopForDebugging)setTimeout(timeHandler,
noneInMotion?that.config.timerDelayLazy:that.config.timerDelayNormal)};setTimeout(timeHandler,this.config.timerDelayNormal)},initInterval:function(){var that=this;this.interval=setInterval(function(){console.log("Stage Interval");for(var i=0;i<that.icons.length;i++)that.icons[i].handleStageInterval()},this.config.intervalDelay)},addIcon:function(){var newId=this.icons.length;var icon=new Icon(this,newId);this.icons.push(icon)},destroy:function(){if(this.interval!=null){clearInterval(this.interval);
this.interval=null}this.parent.removeChild(this.group);this.group=null;this.destroied=true}};
var Config={General:{developerMode:false,keyboardScrollSpeed:50,lockTool:false,snapToGrid:false,showScale:false,showObjectManager:false,gridSize:20,canvasBackground:"#CCCCCC",drawingBackground:"#FFFFFF",anchorTipNofified:false,offlineMode:true},LocalStorage:{mainKey:"QSTAGE_VF710",playerCacheKey:"player-cache"},Workspace:{margin:0},SlidePane:{left:0,top:24},Scaleplate:{size:16,indicatorSize:5,indicatorColor:"RGBA(67, 74, 77, 0.5)"},ObjectManager:{width:240,marginTop:66,marginRight:20},DrawingBoard:{fillColor:"#3F51B5",
strokeColor:"#333333",fillOpacity:.8,strokeOpacity:1,strokeWidth:4},CanvasFrame:{marginLeft:8,marginTop:8,marginRight:8,marginBottom:12,borderDashArray:"1,0",borderColor:"#333333"},AnchorPoint:{width:10,height:10,fill:"RGBA(255, 255, 255, 0.2)",stroke:"RGBA(33, 33, 33, 1)",capturedFill:"#FE5722",capturedStroke:"#FE5722",highlightedFill:"#FFFFFF",highlightedStroke:"#FE5722",strokeWidth:1,selectedFill:"#ff0000",selectedStroke:"#FE5722",followingFill:"#FFFFFF",followingStroke:"#FE5722"},BezierController:{size:6,
fill:"RGBA(127, 127, 127, 1)",stroke:"RGBA(127, 127, 127, 1)",strokeWidth:1,capturedFill:"#ff0000",capturedStroke:"#FE5722",highlightedFill:"#FFFFFF",highlightedStroke:"#FE5722"},FrameHandle:{weight:4,length:16,borderSize:1,borderDashArray:"4,2",fill:"RGBA(255, 255, 255, 1)",stroke:"RGBA(33, 33, 33, 1)",capturedFill:"#FE5722",capturedStroke:"#FE5722",highlightedFill:"#FFFFFF",highlightedStroke:"#FE5722",ghostFill:"RGBA(0, 0, 0, 0)",ghostStroke:"RGBA(0, 0, 0, 0)"},Shape:{ghostWidth:40,ghostStroke:"RGBA(255, 0, 0, 0)",
ghostFill:"RGBA(255, 0, 0, 0)"}};
function GET_SAMPLE_OBJ(){var obj={canvas:{position:{x:8,y:8},boundary:{left:0,top:0,right:1091,bottom:735}},shapes:[{id:0,type:16,position:{x:176,y:328},boundary:{left:0,top:-187,right:387,bottom:4},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[53,-149,-73,72],[280,-187,-23,-9],[382,-87,-15,-53],[387,4,4,-25]],properties:[["fill",{color:"#FFFFFF",opacity:"1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",true],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",
2],["fillAnimation",1]]},{id:1,type:16,position:{x:821,y:491},boundary:{left:-670,top:-278,right:-233,bottom:-88},rotation:{cx:0,cy:0,angle:0},points:[[-670,-93,-41,187],[-446,-278,0,0],[-233,-88,-42,-201]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:2,type:4,position:{x:120,y:396},boundary:{left:0,top:0,right:75,
bottom:80},rotation:{cx:0,cy:0,angle:0},points:[],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",true],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:3,type:4,position:{x:535,y:399},boundary:{left:0,top:0,right:83,bottom:82},rotation:{cx:0,cy:0,angle:0},points:[],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",{color:"#333333",opacity:1,width:4}],
["applyFill",true],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:4,type:16,position:{x:177,y:523},boundary:{left:-6,top:-310,right:387,bottom:19},rotation:{cx:0,cy:0,angle:0},points:[[0,0,1,3],[-6,-86,-8,53],[39,-245,-57,60],[196,-310],[362,-236,-57,-72],[387,-72],[382,8,13,-22],[226,11,9,19],[210,-17],[182,-20,13,-10],[161,9,6,-14],[64,19,27,1]],properties:[["fill",{color:"#FFFFFF",opacity:"1"}],["stroke",{color:"#333333",
opacity:1,width:4}],["applyFill",true],["closePath",true],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:5,type:4,position:{x:335,y:188},boundary:{left:0,top:0,right:67,bottom:70},rotation:{cx:0,cy:0,angle:0},points:[],properties:[["fill",{color:"#FE5722",opacity:"1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",true],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},
{id:6,type:16,position:{x:802,y:336},boundary:{left:-431,top:-78,right:-430,bottom:-37},rotation:{cx:0,cy:0,angle:0},points:[[-431,-78],[-431,-37]],properties:[["fill",{color:"#FFFFFF",opacity:"0.1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:7,type:16,position:{x:407,y:532},boundary:{left:-62,top:-31,right:-3,bottom:-29},rotation:{cx:0,cy:0,angle:0},points:[[-62,
-29,-8,7],[-3,-31,-27,-6]],properties:[["fill",{color:"#FFFFFF",opacity:"0.1"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:8,type:16,position:{x:179,y:523},boundary:{left:-15,top:0,right:162,bottom:58},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[-15,53,-24,-31],[162,58,-11,13],[159,12,2,1]],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",
{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:9,type:16,position:{x:401,y:533},boundary:{left:0,top:-2,right:160,bottom:66},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[37,66,-63,-16],[160,-2,88,57]],properties:[["fill",{color:"#FE5722",opacity:"0.8"}],["stroke",{color:"#333333",opacity:1,width:4}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin",
"miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:10,type:32,position:{x:633,y:471},boundary:{left:0,top:-11,right:39,bottom:20},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,5],[0,8],[1,10],[1,11],[1,14],[2,15],[2,16],[3,17],[4,17],[5,18],[5,19],[6,19],[8,19],[8,20],[9,20],[9,19],[11,16],[15,9],[16,5],[18,2],[18,1],[19,-1],[19,-2],[20,-3],[20,-4],[20,-5],[20,-7],[20,-9],[20,-8],[20,-7],[21,-3],[22,1],[23,5],[25,7],[25,8],[26,9],[26,12],[27,13],[27,14],[28,15],[28,16],[28,17],[29,17],
[30,17],[31,17],[33,17],[33,16],[34,15],[35,14],[35,13],[36,10],[37,8],[37,6],[37,5],[37,4],[37,2],[37,1],[39,-2],[39,-5],[39,-6],[39,-7],[39,-8],[39,-9],[39,-10],[37,-10],[37,-11],[36,-11]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:11,type:32,position:{x:681,y:455},boundary:{left:0,top:0,right:2,bottom:27},
rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[2,1],[2,3],[2,6],[2,10],[2,11],[2,13],[2,17],[2,20],[2,21],[2,22],[2,24],[2,25],[2,26],[2,27]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:12,type:32,position:{x:701,y:448},boundary:{left:0,top:0,right:5,bottom:28},rotation:{cx:0,cy:0,angle:0},points:[[0,
0],[0,0],[1,2],[1,8],[1,12],[3,15],[3,19],[4,21],[4,23],[5,26],[5,27],[5,28]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:13,type:32,position:{x:687,y:466},boundary:{left:0,top:-1,right:14,bottom:0},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[3,0],[5,-1],[6,-1],[8,-1],[9,-1],[11,-1],[12,-1],[13,
-1],[14,-1]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:14,type:32,position:{x:637,y:522},boundary:{left:0,top:-6,right:15,bottom:19},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[1,-1],[5,-2],[7,-4],[9,-5],[11,-6],[14,-6],[15,-6],[15,-3],[15,-2],[14,7],[14,12],[13,16],[13,17],[13,18],[13,19]],properties:[["fill",
{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:15,type:32,position:{x:672,y:506},boundary:{left:-14,top:0,right:0,bottom:45},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,2],[-1,7],[-3,11],[-3,14],[-4,17],[-5,19],[-8,25],[-9,30],[-11,34],[-12,37],[-13,40],[-13,42],[-13,44],[-14,45]],properties:[["fill",{color:"#3F51B5",
opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:16,type:32,position:{x:687,y:506},boundary:{left:0,top:0,right:16,bottom:30},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],[0,9],[0,11],[1,12],[2,12],[2,13],[3,13],[5,14],[6,15],[9,17],[13,20],[15,20],[16,21],[16,22],[16,23],[16,24],[16,26],[15,27],[14,28],
[13,29],[12,29],[9,29],[8,30],[6,30],[5,30],[3,30],[2,30],[2,29],[2,28],[2,27],[2,25],[4,24],[5,23],[5,22],[7,19],[7,18],[9,17],[9,16],[9,13],[10,12],[10,11],[10,10],[10,9],[10,8],[10,7],[10,6],[10,4],[10,3],[10,2],[8,2],[7,1],[6,0],[5,0],[4,0]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:17,type:32,position:{x:725,
y:497},boundary:{left:-17,top:0,right:0,bottom:42},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[0,5],[-2,7],[-4,13],[-7,18],[-9,21],[-10,24],[-11,26],[-13,29],[-14,30],[-15,34],[-16,35],[-16,37],[-16,39],[-17,40],[-17,41],[-17,42]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation",2],["fillAnimation",1]]},{id:18,type:32,position:{x:735,
y:499},boundary:{left:0,top:0,right:3,bottom:22},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[1,1],[1,5],[1,15],[1,19],[2,21],[2,22],[3,22]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:19,type:32,position:{x:754,y:492},boundary:{left:-8,top:0,right:21,bottom:35},rotation:{cx:0,cy:0,angle:0},points:[[0,
0],[0,0],[0,3],[0,5],[0,9],[0,11],[0,12],[0,13],[1,13],[2,13],[3,13],[7,12],[9,12],[12,10],[13,10],[15,10],[16,10],[17,10],[17,11],[18,11],[18,13],[20,13],[20,14],[20,15],[20,16],[21,16],[21,18],[21,19],[21,20],[21,21],[21,22],[19,23],[17,27],[16,27],[13,28],[8,31],[1,34],[-2,34],[-3,35],[-5,35],[-7,35],[-7,34],[-8,33],[-8,32],[-8,30],[-8,29]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap",
"butt"],["strokeLinejoin","miter"],["strokeAnimation","1"],["fillAnimation",1]]},{id:20,type:32,position:{x:757,y:495},boundary:{left:0,top:-6,right:17,bottom:0},rotation:{cx:0,cy:0,angle:0},points:[[0,0],[0,0],[1,-1],[3,-1],[4,-2],[5,-2],[7,-2],[8,-2],[9,-2],[10,-2],[11,-2],[11,-3],[12,-3],[13,-3],[15,-4],[16,-4],[17,-4],[17,-6]],properties:[["fill",{color:"#3F51B5",opacity:.8}],["stroke",{color:"#333333",opacity:"1",width:"1"}],["applyFill",false],["closePath",false],["strokeLinecap","butt"],["strokeLinejoin",
"miter"],["strokeAnimation","1"],["fillAnimation",1]]}]};return obj}function EventManager(workspace){this.workspace=workspace;this.registrations=[];this.arrowKeyStatus=0;this.keyboardTimer=null;this.keyboardTimerDelay=50;this.doubleTapThreshold=300;this.init()}
EventManager.prototype={init:function(object){var that=this;this.handleMouseEvent=function(e){that.handleMT(e,this)};this.handleTouchEvent=function(e){e.preventDefault();that.handleMT(e,this)};this.handleKeyEvent=function(e){that.handleKey(e)};if(object==null){document.addEventListener("mousemove",this.handleMouseEvent,false);document.addEventListener("mouseup",this.handleMouseEvent,false);document.addEventListener("keydown",this.handleMouseEvent,false);document.addEventListener("keyup",this.handleMouseEvent,
false)}else{object.addEventListener("mousedown",this.handleMouseEvent,false);object.addEventListener("touchstart",this.handleTouchEvent,false);object.addEventListener("touchend",this.handleTouchEvent,false);object.addEventListener("touchmove",this.handleTouchEvent,false)}},getRegistration:function(object){for(var i=0;i<this.registrations.length;i++)if(this.registrations[i].object==object)return this.registrations[i];var registration={object:object,events:[],beginPosition:null,previousPosition:null,
previousTime:null,addListener:function(eventKey,handler){this.events.push({key:eventKey,handler:handler});return this}};this.registrations.push(registration);this.init(object);return registration},fireEvent:function(registration,eventKey,e,args){if(registration!=null)for(var i=0;i<registration.events.length;i++){var event=registration.events[i];if(event.key==eventKey)event.handler(e,args)}else for(var i=0;i<this.registrations.length;i++)this.fireEvent(this.registrations[i],eventKey,e,args)},isAppleDevice:function(){var u=
navigator.userAgent;var val=false;val|=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);val|=u.indexOf("iPhone")>-1;val|=u.indexOf("iPad")>-1;return val},handleMT:function(e,object){switch(e.type){case "mousedown":this.touchstartAndMousedown(e,object);break;case "mousemove":this.touchmoveAndMousemove(e);break;case "mouseup":this.touchcancelAndMouseup(e);break;case "touchstart":if(e.touches.length==1)this.touchstartAndMousedown(e.targetTouches[0],object);else if(e.touches.length==2);break;case "touchend":if(e.changedTouches.length==
1)this.touchcancelAndMouseup(e.changedTouches[0],object);break;case "touchmove":if(e.changedTouches.length==1)this.touchmoveAndMousemove(e.changedTouches[0],object);else if(e.touches.length==2);break}},touchstartAndMousedown:function(e,object){var registration=this.getRegistration(object);registration.beginPosition={x:e.pageX,y:e.pageY};registration.previousPosition={x:e.pageX,y:e.pageY};var eventName="capture";if(registration.previousTime!=null&&(new Date).getTime()-registration.previousTime<this.doubleTapThreshold)eventName=
"doubleTap";this.fireEvent(registration,eventName,e,{sender:object,current:{x:e.pageX,y:e.pageY}});registration.previousTime=(new Date).getTime()},touchmoveAndMousemove:function(e,object){for(var i=0;i<this.registrations.length;i++){var registration=this.registrations[i];if(registration.beginPosition==null)continue;this.fireEvent(registration,"drag",e,{sender:registration.object,captured:true,begin:{x:registration.beginPosition.x,y:registration.beginPosition.y,dx:e.pageX-registration.beginPosition.x,
dy:e.pageY-registration.beginPosition.y},previous:{x:registration.previousPosition.x,y:registration.previousPosition.y,dx:e.pageX-registration.previousPosition.x,dy:e.pageY-registration.previousPosition.y},current:{x:e.pageX,y:e.pageY}});registration.previousPosition.x=e.pageX;registration.previousPosition.y=e.pageY}},touchcancelAndMouseup:function(e,object){for(var i=0;i<this.registrations.length;i++){var registration=this.registrations[i];if(registration.beginPosition==null)continue;registration.beginPosition=
null;this.fireEvent(registration,"release",e,{sender:registration.object,current:{x:e.pageX,y:e.pageY}})}},handleKey:function(e){var that=this;switch(e.type){case "keydown":var keyboardTimerHandler=function(){var dx=0;var dy=0;if((that.arrowKeyStatus&1)>0)dx=-1;if((that.arrowKeyStatus&1<<1)>0)dy=-1;if((that.arrowKeyStatus&1<<2)>0)dx=1;if((that.arrowKeyStatus&1<<3)>0)dy=1;if(that.arrowKeyStatus>0){that.fireEvent(null,"arrowkey",e,{dx:dx,dy:dy});that.keyboardTimer=setTimeout(keyboardTimerHandler,that.keyboardTimerDelay)}else that.keyboardTimer=
null};var keyCode=event.keyCode;switch(keyCode){case 37:this.arrowKeyStatus|=1;break;case 38:this.arrowKeyStatus|=1<<1;break;case 39:this.arrowKeyStatus|=1<<2;break;case 40:this.arrowKeyStatus|=1<<3;break}if(this.arrowKeyStatus>0&&this.keyboardTimer==null)keyboardTimerHandler();break;case "keyup":var keyCode=event.keyCode;switch(keyCode){case 37:that.arrowKeyStatus&=~1;break;case 38:that.arrowKeyStatus&=~(1<<1);break;case 39:that.arrowKeyStatus&=~(1<<2);break;case 40:that.arrowKeyStatus&=~(1<<3);
break}if(that.arrowKeyStatus==0)if(that.keyboardTimer!=null){clearTimeout(that.keyboardTimer);that.keyboardTimer=null}break}}};
(function(){var QCache={extend:function(obj){for(var key in obj){if(!obj.hasOwnProperty(key))continue;this[key]=obj[key]}},payloadObject:{}};QCache.extend({get:function(key){if(!this.update(false))return null;if(this.payloadObject.hasOwnProperty(key))return this.payloadObject[key];else return null},set:function(key,value){this.payloadObject[key]=value;return this.update(true)},getProject:function(projectId){if(!this.update(false))return null;if(!this.payloadObject.hasOwnProperty("projects"))this.payloadObject.projects=
{};if(this.payloadObject.projects.hasOwnProperty(projectId))return this.payloadObject.projects[projectId];else return null},setProject:function(projectId,value){if(!this.payloadObject.hasOwnProperty("projects"))this.payloadObject.projects={};this.payloadObject.projects[projectId]=value;return this.update(true)},deleteProject:function(projectId){if(!this.update(false))return false;if(!this.payloadObject.hasOwnProperty("projects"))return false;if(this.payloadObject.projects.hasOwnProperty(projectId)){delete this.payloadObject.projects[projectId];
return this.update(true)}return false},getAllProjectIds:function(){if(!this.update(false))return[];if(!this.payloadObject.hasOwnProperty("projects"))return[];var projectIds=[];for(var key in this.payloadObject.projects)if(this.payloadObject.projects.hasOwnProperty(key))projectIds.push(key);return projectIds},clear:function(){return this.clearCache(Config.LocalStorage.mainKey)},update:function(serialize){if(serialize){var saved=this.saveToCache(Config.LocalStorage.mainKey,JSON.stringify(this.payloadObject));
return saved}else try{var json=this.loadFromCache(Config.LocalStorage.mainKey);if(json!=null){this.payloadObject=JSON.parse(json);return true}else return false}catch(err){console.log("Error:",err);return false}},saveToCache:function(key,str){if(!localStorage)return false;try{localStorage.setItem(key,str);return true}catch(e){console.log("Error saving to localStorage:",e);return false}},loadFromCache:function(key){if(!localStorage)return null;try{var str=localStorage.getItem(key);return str}catch(e){console.log("Error loading from localStorage:",
e);return null}},clearCache:function(key){if(!localStorage)return false;try{localStorage.removeItem(key);return true}catch(e){console.log("Error clearing localStorage:",e);return false}}});window.QCache=QCache})();function AppMenu(pane){this.pane=pane;this.width=200;this.title="Application"}
AppMenu.prototype={renderInto:function(wrapper){var that=this;var menuItem=wrapper.createChild("div",{class:"menu-item app-menu",title:this.title});var button=menuItem.createChild("div",{});this.pane.render32pxSvgIcon(button,"ICON32_MENU_App");var subContainer=menuItem.createChild("div",{class:"sub-container",style:"width: {0}px;".format(this.width)});subContainer.createChild("div",{class:"sub-title no-select"},this.title);var subBody=subContainer.createChild("div",{class:"sub-body"});var items=subBody.createChild("div",
{class:"sub-items"});this.renderSubMenus(items);button.addEventListener("click",function(){that.pane.selectMenuItem(this.parentNode)},false);return menuItem},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace.painting},renderSubMenus:function(container){var that=this;this.pane.renderIconButton(container,"Home","ICON24_HOME",true,function(){QStage.setUrlHash("id",null);that.getWorkspace().showStartPage(true)});this.pane.renderIconButton(container,
"New","ICON24_NEW",true,function(){that.getWorkspace().reset(true)});if(!Config.General.offlineMode)this.pane.renderIconButton(container,"Save","ICON24_SAVE",false,function(){if(!that.getWorkspace().needToBeSaved())return;that.getWorkspace().sendToServer(function(id){if(id==null)that.getWorkspace().drawingBoard.showMessage("Error: Not Saved");else{var urlId=QStage.getUrlHash("id");if(urlId==id)that.getWorkspace().drawingBoard.showMessage("Saved");else QStage.setUrlHash("id",id)}})});this.pane.renderIconButton(container,
"Play","ICON24_PLAY",true,function(){if(Config.General.offlineMode===true){var jsonObj=that.getWorkspace().painting.serialize("JSON");var id=QStage.getUrlHash("id");if(localStorage){var cacheKey=Config.LocalStorage.mainKey;var cacheData={};try{var existingData=localStorage.getItem(cacheKey);if(existingData)cacheData=JSON.parse(existingData)}catch(e){}cacheData[Config.LocalStorage.playerCacheKey]=jsonObj;localStorage.setItem(cacheKey,JSON.stringify(cacheData))}var targetFile="./player/index.html";
var newWindow=window.open(targetFile,"wndPlay","");if(newWindow)newWindow.focus();else that.getWorkspace().drawingBoard.showMessage("Failed to open new window")}else{var targetFile="http://stage.qlike.com/player/?id=";if(that.getWorkspace().needToBeSaved())that.getWorkspace().sendToServer(function(id){QStage.setUrlHash("id",id);targetFile+=id;var newWindow=window.open(targetFile,"wndPlay","");if(newWindow)newWindow.focus();else that.getWorkspace().drawingBoard.showMessage("Failed to open new window")});
else{var id=QStage.getUrlHash("id");targetFile+=id;var newWindow=window.open(targetFile,"wndPlay","");if(newWindow)newWindow.focus();else that.getWorkspace().drawingBoard.showMessage("Failed to open new window")}}});if(!Config.General.offlineMode)this.pane.renderIconButton(container,"Share","ICON24_SHARE",true,function(){var promptDialog=that.getWorkspace().promptDialog;promptDialog.setShowing(true);var targetFile="http://stage.qlike.com/player/?id=";if(that.getWorkspace().needToBeSaved()){promptDialog.setEnabled(false);
promptDialog.setText("Getting sharing URL...");that.getWorkspace().sendToServer(function(id){QStage.setUrlHash("id",id);targetFile+=id;promptDialog.setText(targetFile);promptDialog.setEnabled(true);promptDialog.selectAll()})}else{targetFile+=QStage.getUrlHash("id");promptDialog.setText(targetFile);promptDialog.selectAll()}});this.pane.renderIconButton(container,"Download","ICON24_DOWNLOAD",true,function(){if(Config.General.offlineMode===true){var jsonObj=that.getWorkspace().painting.serialize("JSON");
var jsonString=JSON.stringify(jsonObj,null,2);var id=QStage.getUrlHash("id")||"project";var filename="project_"+id+".json";var blob=new Blob([jsonString],{type:"application/json"});var url=window.URL.createObjectURL(blob);var link=document.createElement("a");link.href=url;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);window.URL.revokeObjectURL(url)}else{var targetFile="http://stage.qlike.com/repository/?action=down&id=";if(that.getWorkspace().needToBeSaved())that.getWorkspace().sendToServer(function(id){QStage.setUrlHash("id",
id);targetFile+=id;location.href=targetFile});else{targetFile+=QStage.getUrlHash("id");location.href=targetFile}}})},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace},getDrawingBoard:function(){return this.pane.workspace.drawingBoard}};
function ColorMenu(pane,isStroke){this.pane=pane;this.isStroke=isStroke;this.title=isStroke?"Stroke":"Fill";this.screenStatus=null;this.width=[392,228,338];this.colors=[["#333333","#E51C24","#EA1E63","#9C27B3","#673BB7","#00BCD5","#03A9F5","#5677FC","#3F51B5","#039488","#259B23","#8BC24A","#CDDC39","#FE5722","#FF9700","#FEC107","#FFEB3C","#795547","#9E9E9E","#607D8B","#FFFFFF"],["#333333","#E51C24","#FF9700","#FFEB3C","#259B23","#00BCD5","#3F51B5","#9C27B3","#795547","#9E9E9E","#EA1E63","#FFFFFF"]];
this.icon=null;this.subContainer=null;this.titleBackground=null;this.opacityLabel=null;this.widthLabel=null;this.colorsPanel=null;this.widthPanel=null;this.codeInput=null;this.widthSelect=null;this.opacSelect=null;this.onColorChanged=null}
ColorMenu.prototype={renderInto:function(wrapper){var that=this;var menuItem=wrapper.createChild("div",{"class":"menu-item color-menu","title":this.title});this.button=menuItem.createChild("div",{});this.icon=this.button.createChild("div",{"class":"icon-color"});this.opacityLabel=this.icon.createChild("div",{"class":"label no-select"},"[Opacity]");if(this.isStroke)this.widthLabel=this.icon.createChild("div",{"class":"label no-select"},"[Width]");this.subContainer=menuItem.createChild("div",{"class":"sub-container",
"style":"width: 0px;"});var subTitle=this.subContainer.createChild("div",{"class":"sub-title no-select"});this.titleBackground=subTitle.createChild("div",{"class":"color-background"});this.titleBackground.createChild("span",{"class":"color-label"},this.title);var buttons=this.titleBackground.createChild("div",{"class":"buttons"});var btnOk=buttons.createChild("span",{"class":"button button-ok"},"OK");btnOk.addEventListener("click",function(){var color=that.codeInput.value;that.changeColor(color.isRGBCode()?
color:that.color)},false);var subBody=this.subContainer.createChild("div",{"class":"sub-body"});this.renderPalette(subBody);this.button.addEventListener("click",function(){that.pane.selectMenuItem(this.parentNode)},false);if(this.isStroke){var color=this.getPainting().stroke.color;var opacity=this.getPainting().stroke.opacity;var strokeWidth=this.getPainting().stroke.width;this.setData(color,opacity,strokeWidth)}else{var color=this.getPainting().fill.color;var opacity=this.getPainting().fill.opacity;
var strokeWidth=null;this.setData(color,opacity,strokeWidth)}return menuItem},resize:function(width,height){var isSmallScreen=this.getWorkspace().isSmallScreen();var isLandscape=this.getWorkspace().isLandscape();var newScreenStatus=0;if(isSmallScreen)if(isLandscape)newScreenStatus=2;else newScreenStatus=1;if(this.screenStatus!=newScreenStatus){this.screenStatus=newScreenStatus;while(this.colorsPanel.childNodes.length>0)this.colorsPanel.removeChild(this.colorsPanel.firstChild);var colors=isSmallScreen?
this.colors[1]:this.colors[0];for(var i=0;i<colors.length;i++)this.renderColorButton(this.colorsPanel,colors[i],false);var width=this.width[0];if(isSmallScreen)if(isLandscape)width=this.width[2];else width=this.width[1];this.subContainer.updateStyle("width",width+"px")}},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace.painting},renderPalette:function(subBody){var that=this;this.colorsPanel=subBody.createChild("div",{"class":"colors"});subBody.createChild("div",
{"class":"clear"});var attributesPanel=subBody.createChild("div",{"class":"attributes"});var opacityPanel=attributesPanel.createChild("div",{"class":"field"});opacityPanel.createChild("div",{"class":"label"},"RGB Code:");this.codeInput=opacityPanel.createChild("input",{"type":"text","class":"form-control","id":"code-input","maxlength":7});attributesPanel.createChild("div",{"class":"clear"});var opacityPanel=attributesPanel.createChild("div",{"class":"field"});opacityPanel.createChild("div",{"class":"label"},
"Color Opacity:");this.opacSelect=opacityPanel.createChild("select",{"class":"form-control","id":"opacity-select"});for(var i=0;i<=10;i++)this.opacSelect.createChild("option",{"value":i/10},i*10+"%");attributesPanel.createChild("div",{"class":"clear"});if(this.isStroke){this.widthPanel=attributesPanel.createChild("div",{"class":"field"});this.widthPanel.createChild("div",{"class":"label"},"Stroke Width:");this.widthSelect=this.widthPanel.createChild("select",{"class":"form-control","id":"width-select"});
for(var i=0;i<=20;i++)this.widthSelect.createChild("option",{"value":i}," "+i);attributesPanel.createChild("div",{"class":"clear"})}},renderColorButton:function(panel,color){var that=this;var div=panel.createChild("div",{"style":"background-color: "+color,"title":color,"data-color":color});div.addEventListener("click",function(){var color=this.getAttribute("data-color");that.changeColor(color)},false)},changeColor:function(color){if(color==null){this.pane.selectMenuItem(null);return}if(typeof this.onColorChanged==
"function"){var opacity=this.getSelectValue(this.opacSelect);var strokeWidth=null;if(this.isStroke)strokeWidth=this.getSelectValue(this.widthSelect);this.onColorChanged(color,opacity,strokeWidth)}this.pane.selectMenuItem(null)},selectByValue:function(select,value){for(var i=0;i<select.options.length;i++)if(select.options[i].value==value)select.options[i].selected=true},getSelectValue:function(select){return select.options[select.selectedIndex].value},setData:function(color,opacity,strokeWidth){this.icon.updateStyle("background-color",
color);this.titleBackground.updateStyle("background-color",color);this.opacityLabel.textContent="{0}%".format(opacity*100);if(strokeWidth)this.widthLabel.textContent="{0}px".format(strokeWidth);this.codeInput.value=color;this.selectByValue(this.opacSelect,opacity);if(strokeWidth)this.selectByValue(this.widthSelect,strokeWidth)}};
function PropertyMenu(pane){this.pane=pane;this.menuItem=null;this.width=260;this.title="Properties";this.shape=null;this.buttonFront=null;this.buttonBack=null;this.lblPosition=null;this.lblSize=null;this.lvlRotation=null;this.dynamicProperties=null;this.fieldIndex=0}
PropertyMenu.prototype={renderInto:function(wrapper){var that=this;this.menuItem=wrapper.createChild("div",{"class":"menu-item property-menu hidden","title":this.title});var button=this.menuItem.createChild("div",{});this.pane.render32pxSvgIcon(button,"ICON32_MENU_Property");var subContainer=this.menuItem.createChild("div",{"class":"sub-container","style":"width: {0}px;".format(this.width)});subContainer.createChild("div",{"class":"sub-title no-select"},this.title);var subBody=subContainer.createChild("div",
{"class":"sub-body"});var buttonList=subBody.createChild("div",{"class":"button-list"});var buttonDelete=buttonList.createChild("div",{"class":"icon-item","title":"Delete"});this.render32pxSvgIcon(buttonDelete,0);buttonDelete.addEventListener("click",function(e){that.getPainting().selectedShape.remove()},false);this.buttonFront=buttonList.createChild("div",{"class":"icon-item","title":"Bring to Front"});this.render32pxSvgIcon(this.buttonFront,1);this.buttonFront.addEventListener("click",function(e){that.getPainting().selectedShape.bringToFront();
that.updateButtonStatus(that.getPainting().selectedShape)},false);this.buttonBack=buttonList.createChild("div",{"class":"icon-item","title":"Send to Back"});this.render32pxSvgIcon(this.buttonBack,2);this.buttonBack.addEventListener("click",function(e){that.getPainting().selectedShape.sendToBack();that.updateButtonStatus(that.getPainting().selectedShape)},false);this.pane.addSeperator(subBody,"Properties");var fixProperties=subBody.createChild("div",{"class":"property-list"});this.lblPosition=this.addLabelField(fixProperties,
"Position (X,Y)","");this.lblSize=this.addLabelField(fixProperties,"Size (W*H)","");this.lblRotation=this.addLabelField(fixProperties,"Rotation","");this.dynamicProperties=subBody.createChild("div",{"class":"property-list dynamic-list"});button.addEventListener("click",function(){that.pane.selectMenuItem(this.parentNode);that.updateStaticFields(that.shape)},false);return this.menuItem},getPainting:function(){return this.pane.workspace.painting},showProperty:function(shape){this.shape=shape;if(shape==
null){this.menuItem.addClassName("hidden");this.pane.selectMenuItem(null)}else{this.menuItem.removeClassName("hidden");this.updateButtonStatus(shape);this.updateStaticFields(shape);this.updateDynamicFields(shape)}},updateButtonStatus:function(shape){this.buttonFront.updateStyle("display",shape.canBringFront()?"block":"none");this.buttonBack.updateStyle("display",shape.canSendBack()?"block":"none")},updateStaticFields:function(shape){var absoluteInfo=shape.getAbsoluteInfo();this.lblPosition.textContent=
"{0},{1}".format(Math.round(absoluteInfo.left),Math.round(absoluteInfo.top));this.lblSize.textContent="{0}*{1}".format(Math.round(absoluteInfo.width),Math.round(absoluteInfo.height));this.lblRotation.textContent="{0} degree".format(Math.round(absoluteInfo.rotation))},updateDynamicFields:function(shape){while(this.dynamicProperties.hasChildNodes())this.dynamicProperties.removeChild(this.dynamicProperties.firstChild);var select=this.addSelectField(this.dynamicProperties,"Animation (Stroke)",shape.prop("strokeAnimation")>
0?65:85,shape.getOptions("strokeAnimation"),shape.prop("strokeAnimation"),function(newValue){if(newValue==0){select.updateStyle("width","85px");select.nextSibling.updateStyle("display","none")}else{select.updateStyle("width","65px");select.nextSibling.updateStyle("display",null)}shape.prop("strokeAnimation",newValue)});var style="float: right; margin: 4px 0px 0px 4px;"+(shape.prop("strokeAnimation")>0?" ":"display:none;");var iconWrapper=select.parentNode.createChild("div",{"style":style,"title":"Preview Stroke Animation"});
var icon=iconWrapper.createChildNS("svg",{"width":16,"height":16});var g=icon.createChildNS("g");g.createChildNS("path",{"fill":"#06ACD4","stroke":"none","d":"M0,0 L16,8 L0,16 Z"});icon.addEventListener("click",function(e){shape.playAnimation("STROKE",1)},false);var select=this.addSelectField(this.dynamicProperties,"Animation (Fill)",shape.prop("fillAnimation")>0?65:85,shape.getOptions("fillAnimation"),shape.prop("fillAnimation"),function(newValue){if(newValue==0){select.updateStyle("width","85px");
select.nextSibling.updateStyle("display","none")}else{select.updateStyle("width","65px");select.nextSibling.updateStyle("display",null)}shape.prop("fillAnimation",newValue)});var style="float: right; margin: 4px 0px 0px 4px;"+(shape.prop("fillAnimation")>0?" ":"display:none;");var iconWrapper=select.parentNode.createChild("div",{"style":style,"title":"Preview Fill Animation"});var icon=iconWrapper.createChildNS("svg",{"width":16,"height":16});var g=icon.createChildNS("g");g.createChildNS("path",{"fill":"#06ACD4",
"stroke":"none","d":"M0,0 L16,8 L0,16 Z"});icon.addEventListener("click",function(e){shape.playAnimation("FILL",1)},false);this.addSelectField(this.dynamicProperties,"Stroke Linecap",85,shape.getOptions("strokeLinecap"),shape.prop("strokeLinecap"),function(newValue){shape.prop("strokeLinecap",newValue)});this.addSelectField(this.dynamicProperties,"Stroke Linejoin",85,shape.getOptions("strokeLinejoin"),shape.prop("strokeLinejoin"),function(newValue){shape.prop("strokeLinejoin",newValue)});switch(shape.getType()){case ShapeTypes.Polygon:var selectedValue=
shape.anchorPoints.length;this.addSelectField(this.dynamicProperties,"Vertex Number",50,shape.getOptions("vertexNumber"),selectedValue,function(newValue){shape.setVertexNumber(newValue)});break;case ShapeTypes.Polyline:var selectedValue=shape.prop("closePath")?1:0;this.addSelectField(this.dynamicProperties,"Close Path",85,shape.getOptions("GENERIC_BOOL"),selectedValue,function(newValue){shape.prop("closePath",newValue==1)});var selectedValue=shape.prop("applyFill")?1:0;this.addSelectField(this.dynamicProperties,
"Apply Fill",85,shape.getOptions("GENERIC_BOOL"),selectedValue,function(newValue){shape.prop("applyFill",newValue==1)});break;case ShapeTypes.Label:var selectedValue=shape.prop("lengthAdjust");this.addSelectField(this.dynamicProperties,"Length Adjust",140,shape.getOptions("lengthAdjust"),selectedValue,function(newValue){shape.prop("lengthAdjust",newValue)});this.addTextField(this.dynamicProperties,"Text",180,shape.prop("text"),function(newValue){shape.prop("text",newValue)});break}},addSelectField:function(wrapper,
label,width,options,selectedValue,callback){this.fieldIndex++;var field=wrapper.createChild("div",{"class":this.fieldIndex%2!=0?"field no-select":"field alt-field no-select"});var lblKey=field.createChild("div",{"class":"left"},label+":");var controlContainer=field.createChild("div",{"class":"right"});var select=controlContainer.createChild("select",{"style":"width: {0}px;".format(width)});for(var i=0;i<options.length;i++){var value=options[i][0];var text=options[i][1];if(value==selectedValue)select.createChild("option",
{"value":value,"selected":"true"},text);else select.createChild("option",{"value":value},text)}select.addEventListener("change",function(e){var selectedValue=select.options[select.selectedIndex].value;callback(selectedValue)},false);return select},addTextField:function(wrapper,label,width,defaultText,callback){this.fieldIndex++;var field=wrapper.createChild("div",{"class":this.fieldIndex%2!=0?"field no-select":"field alt-field no-select"});var lblKey=field.createChild("div",{"class":"left"},label+
":");var controlContainer=field.createChild("div",{"class":"right"});var text=controlContainer.createChild("input",{"type":"text","style":"width: {0}px;".format(width),"value":defaultText});text.addEventListener("change",function(e){var newText=text.value;callback(newText)},false);return text},addLabelField:function(wrapper,key,value){this.fieldIndex++;var field=wrapper.createChild("div",{"class":this.fieldIndex%2!=0?"field no-select":"field alt-field no-select"});var lblKey=field.createChild("div",
{"class":"left"},key+":");var lblValue=field.createChild("div",{"class":"right"},value);return lblValue},render32pxSvgIcon:function(divWrapper,index){var buttonSize=32;var svg=divWrapper.createChildNS("svg",{"width":buttonSize,"height":buttonSize});var g=svg.createChildNS("g");switch(index){case 0:var d="";d+="M22.153,28c0.68,0,1.232-0.448,1.232-1V15c0-0.553-0.553-1-1.232-1c-0.678,0-1.229,0.447-1.229,1v12";d+="C20.925,27.552,21.476,28,22.153,28z M29.539,4h-7.386V2c0-1.105-1.102-2-2.461-2h-7.384c-1.36,0-2.461,0.895-2.461,2v2H2.462";
d+="C1.102,4,0,4.895,0,6v2c0,1.104,1.103,2,2.462,2v18c0,2.209,2.205,4,4.923,4h17.229c2.72,0,4.925-1.791,4.925-4V10";d+="C30.898,10,32,9.104,32,8V6C32.002,4.895,30.9,4,29.539,4z M12.308,3c0-0.552,0.551-1,1.231-1h4.923c0.68,0,1.23,0.448,1.23,1v1";d+="c-1.193,0-7.385,0-7.385,0L12.308,3L12.308,3z M27.078,28c0,1.104-1.103,2-2.462,2H7.386c-1.36,0-2.462-0.896-2.462-2V10h22.154";d+="V28z M28.309,8H3.693c-0.68,0-1.231-0.448-1.231-1c0-0.552,0.551-1,1.231-1h24.616c0.68,0,1.23,0.448,1.23,1";d+="C29.539,7.552,28.988,8,28.309,8z M9.847,28c0.679,0,1.231-0.448,1.231-1V15c0-0.553-0.552-1-1.231-1";
d+="c-0.68,0-1.231,0.447-1.231,1v12C8.616,27.552,9.167,28,9.847,28z M16.001,28c0.68,0,1.23-0.448,1.23-1V15";d+="c0-0.553-0.551-1-1.23-1c-0.679,0-1.231,0.447-1.231,1v12C14.77,27.552,15.322,28,16.001,28z";g.createChildNS("path",{"d":d,"fill":"#FE5722","stroke":"none","stroke-width":1});break;case 1:g.createChildNS("rect",{"x":.5,"y":.5,"width":buttonSize/2,"height":buttonSize/2,"stroke":"#333333","stroke-width":1,"fill":"#ffffff"});g.createChildNS("rect",{"x":buttonSize/2+.5,"y":buttonSize/2+.5,"width":buttonSize/
2-1,"height":buttonSize/2-1,"stroke":"#333333","stroke-width":1,"fill":"#ffffff"});g.createChildNS("rect",{"x":buttonSize/4,"y":buttonSize/4,"width":buttonSize/2,"height":buttonSize/2,"stroke":"none","fill":"#FF9700"});break;case 2:g.createChildNS("rect",{"x":buttonSize/4,"y":buttonSize/4,"width":buttonSize/2,"height":buttonSize/2,"stroke":"none","fill":"#FF9700"});g.createChildNS("rect",{"x":.5,"y":.5,"width":buttonSize/2,"height":buttonSize/2,"stroke":"#333333","stroke-width":1,"fill":"#ffffff"});
g.createChildNS("rect",{"x":buttonSize/2+.5,"y":buttonSize/2+.5,"width":buttonSize/2-1,"height":buttonSize/2-1,"stroke":"#333333","stroke-width":1,"fill":"#ffffff"});break}}};function SampleMenu(pane){this.pane=pane;this.width=200;this.title="Developer Mode"}
SampleMenu.prototype={renderInto:function(wrapper){var that=this;var menuItem=wrapper.createChild("div",{"class":"menu-item sample-menu","title":this.title,"id":"hidden_sample_menu","style":"display: none"});var button=menuItem.createChild("div",{});this.pane.render32pxSvgIcon(button,"ICON32_MENU_NONE");var subContainer=menuItem.createChild("div",{"class":"sub-container","style":"width: {0}px;".format(this.width)});subContainer.createChild("div",{"class":"sub-title no-select"},this.title);var subBody=
subContainer.createChild("div",{"class":"sub-body"});var items=subBody.createChild("div",{"class":"sub-items"});this.renderSubMenus(items);button.addEventListener("click",function(){that.pane.selectMenuItem(this.parentNode)},false);return menuItem},getWorkspace:function(){return this.pane.workspace},getPainting:function(){return this.pane.workspace.painting},renderSubMenus:function(container){var that=this;var rBlack=null;var rRed=null;var rBlue=null;var redCenter=null;var blueCenter=null;var position=
{x:200,y:150};var boundary={left:100,top:80,right:500,bottom:250};boundary=QStage.enhanceBoundary(boundary);var angle=40;var dcx=90;var dcy=120;function getRotationOffset(cx1,cy1,cx2,cy2,angle){var d=angle/180*Math.PI;var dx=cx2-cx1;var dy=cy2-cy1;var ddx=dx*(1-Math.cos(d))-dy*Math.sin(d);var ddy=dx*Math.sin(d)+dy*(1-Math.cos(d));return{x:ddx,y:ddy}}var tool1=container.createChild("div",{"class":"text-item no-select"},"Rotate Sample");var tool2=container.createChild("div",{"class":"text-item no-select"},
"Move Blue Rect");tool1.addEventListener("click",function(){var svg=that.getWorkspace().drawingBoard.underGroup;if(rBlack==null)rBlack=svg.createChildNS("rect",{"x":boundary.left,"y":boundary.top,"width":boundary.width,"height":boundary.height,"fill":"none","stroke":"RGBA(0, 0, 0, 0.5)","stroke-width":1});if(rRed==null){rRed=svg.createChildNS("rect",{"x":boundary.left,"y":boundary.top,"width":boundary.width,"height":boundary.height,"fill":"RGBA(255, 0, 0, 0.5)","stroke":"none"});redCenter=svg.createChildNS("circle",
{"cx":boundary.cx,"cy":boundary.cy,"r":10,"fill":"none","stroke":"RGBA(255, 0, 0, 1)","stroke-width":1})}if(rBlue==null){rBlue=svg.createChildNS("rect",{"x":boundary.left,"y":boundary.top,"width":boundary.width,"height":boundary.height,"fill":"RGBA(0, 0, 255, 0.5)","stroke":"none"});blueCenter=svg.createChildNS("circle",{"cx":boundary.cx+dcx,"cy":boundary.cy+dcy,"r":10,"fill":"none","stroke":"RGBA(0, 0, 255, 1)","stroke-width":1})}var blackTransform="translate({0}, {1})".format(position.x,position.y);
rBlack.setAttribute("transform",blackTransform);var redTransform="translate({3}, {4}) rotate({0}, {1}, {2})".format(angle,boundary.cx,boundary.cy,position.x,position.y);rRed.setAttribute("transform",redTransform);redCenter.setAttribute("transform","translate({0}, {1})".format(position.x,position.y));var blueTransform="translate({3}, {4}) rotate({0}, {1}, {2})".format(angle,boundary.cx+dcx,boundary.cy+dcy,position.x,position.y);rBlue.setAttribute("transform",blueTransform);blueCenter.setAttribute("transform",
"translate({0}, {1})".format(position.x,position.y));tool2.updateStyle("display","block")},false);tool2.addEventListener("click",function(){var delta=that.getRotationOffset(boundary.cx,boundary.cy,boundary.cx+dcx,boundary.cy+dcy,angle);var blueTransform="translate({3}, {4}) rotate({0}, {1}, {2})".format(angle,boundary.cx+dcx,boundary.cy+dcy,position.x+delta.x,position.y+delta.y);rBlue.setAttribute("transform",blueTransform)},false);var tool3=container.createChild("div",{"class":"text-item no-select"},
"Animation Stage");var stage=null;tool3.addEventListener("click",function(){if(stage==null){var addIcon=function(){stage.addIcon();if(stage.icons.length<3)setTimeout(addIcon,1E3)};var containerGroup=that.getWorkspace().drawingBoard.underGroup;var svgWidth=that.getWorkspace().drawingBoard.svgSize.width;var svgHeight=that.getWorkspace().drawingBoard.svgSize.height;stage=new Stage(containerGroup,svgWidth,svgHeight);addIcon()}else{stage.destroy();stage=null}},false);var serializeButton=container.createChild("div",
{"class":"text-item no-select"},"Server - List All");serializeButton.addEventListener("click",function(e){that.request("http://stage.qlike.com/repository/?action=pull",null,function(response){var object=JSON.parse(response);console.log(object.payload.length+" Record(s):");for(var i=0;i<object.payload.length;i++)console.log("- "+i+" "+object.payload[i].id)});that.pane.selectMenuItem(null)},false);var deserializeButton=container.createChild("div",{"class":"text-item no-select"},"Server - Clear");deserializeButton.addEventListener("click",
function(e){that.request("http://stage.qlike.com/repository/?action=del",null,function(response){console.log(response)});that.pane.selectMenuItem(null)},false);var clearButton=container.createChild("div",{"class":"text-item no-select"},"Server - Prepare");clearButton.addEventListener("click",function(e){var params="payload="+JSON.stringify(GET_SAMPLE_OBJ());that.request("http://stage.qlike.com/repository/?action=push",params,function(response){console.log(response)});that.pane.selectMenuItem(null)},
false);var clearButton=container.createChild("div",{"class":"text-item no-select"},"Render Sample PNG");clearButton.addEventListener("click",function(e){that.renderSample(that.getDrawingBoard().shapeGroup);that.pane.selectMenuItem(null)},false);var clearButton=container.createChild("div",{"class":"text-item no-select"},"Get Sample JSON");clearButton.addEventListener("click",function(e){var jsonObj=that.getWorkspace().painting.serialize("STRING");console.log(jsonObj);that.pane.selectMenuItem(null)},
false)},getWorkspace:function(){return this.pane.workspace},getDrawingBoard:function(){return this.pane.workspace.drawingBoard},getDeltaAngle:function(p0,p1,p2){var alpha0=Math.atan2(p1.x-p0.x,p1.y-p0.y);var alpha1=Math.atan2(p2.x-p0.x,p2.y-p0.y);return alpha0-alpha1},getRotationOffset:function(cx1,cy1,cx2,cy2,angle){var d=angle/180*Math.PI;var cos=Math.cos(d);var dx=cx2-cx1;var dy=cy2-cy1;var r=Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));var a=Math.pow(r,2);var b,c,resX1,resX2,resY1,resY2;if(cx1==cx2){b=
-2*Math.pow(r,2)*(cx1*cos-cx2*cos+cx2);c=-Math.pow(r*(cy1-cy2),2)+Math.pow(r,4)*Math.pow(cos,2)+2*Math.pow(r,2)*cos*(cx1-cx2)*cx2+Math.pow(r*cx2,2);resX1=(-b+Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);resX2=(-b-Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);resY1=(Math.pow(r,2)*cos+(cx1-cx2)*(cx2-resX1))/(cy1-cy2)+cy2;resY2=(Math.pow(r,2)*cos+(cx1-cx2)*(cx2-resX2))/(cy1-cy2)+cy2}else{b=-2*Math.pow(r,2)*(cy1*cos-cy2*cos+cy2);c=-Math.pow(r*(cx1-cx2),2)+Math.pow(r,4)*Math.pow(cos,2)+2*Math.pow(r,2)*cos*(cy1-cy2)*
cy2+Math.pow(r*cy2,2);resY1=(-b+Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);resY2=(-b-Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);resX1=(Math.pow(r,2)*cos+(cy1-cy2)*(cy2-resY1))/(cx1-cx2)+cx2;resX2=(Math.pow(r,2)*cos+(cy1-cy2)*(cy2-resY2))/(cx1-cx2)+cx2}var refAngle=this.getDeltaAngle({x:cx2,y:cy2},{x:cx1,y:cy1},{x:resX1,y:resY1})*Math.sin(d);var offset=null;if(refAngle>0)offset={x:cx1-resX1,y:cy1-resY1};else offset={x:cx1-resX2,y:cy1-resY2};return offset},request:function(url,params,callback){var that=this;
var xmlhttp=new XMLHttpRequest;xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4)if(typeof callback=="function")if(xmlhttp.status==200)callback(xmlhttp.responseText);else callback(null)};xmlhttp.open("POST",url,true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send(params)},renderSample:function(wrapper){var g=wrapper.createChildNS("g",{"transform":"translate(100.000000,967.000000) scale(0.100000,-0.100000)"});var d="";d+="M2569.316,8420.336c-399.541-31.997-747.573-145.933-1050.356-344.917c-458.848-302.002-738.218-738.218-795.962-1242.329 ";
d+="c-11.704-101.45-5.459-313.711,12.485-410.469l12.485-70.229l-51.499-101.45c-56.191-110.806-124.858-280.151-175.581-436.22 ";d+="l-33.56-101.44l-53.848-25.752c-67.891-32.778-149.038-110.811-184.16-177.92c-70.234-134.224-63.208-301.226,18.73-429.199 ";d+="c74.917-118.608,203.672-190.405,342.578-190.405h63.989l6.24-87.402c6.24-108.477,21.074-198.213,48.384-294.199l20.283-73.35 ";d+="l-22.627-15.605c-56.182-39.014-127.197-122.515-159.971-188.843c-28.096-56.973-33.555-74.922-36.675-127.207 ";d+="c-2.349-48.379,0-68.672,14.043-104.57c43.701-116.27,177.144-202.891,401.885-259.844 ";
d+="c173.242-43.711,273.906-53.848,534.541-53.848c255.181,0,369.888,10.137,570.44,49.941 ";d+="c305.127,60.859,402.666,125.645,428.418,282.48c13.262,85.059-11.704,216.172-56.187,295.762 ";d+="c-15.605,27.31-15.605,30.425-3.12,67.114c33.555,101.445,130.313,216.934,219.277,260.635 ";d+="c43.696,21.855,56.187,24.189,99.888,21.064c40.581-2.334,55.405-7.793,83.496-27.305c57.749-42.92,124.858-147.49,167.778-262.197 ";d+="l14.043-36.689l-28.872-62.427c-40.576-88.965-53.843-152.949-49.941-241.914c3.906-91.289,27.314-144.355,88.179-202.109 ";
d+="c99.106-93.633,231.772-130.313,581.367-159.961c391.738-34.336,726.513-19.512,963.74,42.129 ";d+="c92.08,24.199,210.693,84.277,258.291,131.094c60.879,59.316,77.266,99.883,77.266,184.961c0,64.746-2.344,74.902-27.314,124.844 ";d+="c-32.773,66.348-124.082,160.762-187.285,194.321c-23.418,12.48-43.701,23.408-45.264,24.189 ";d+="c-0.781,0.771,3.906,24.971,10.137,53.838c18.74,80.381,34.346,204.453,39.814,314.492l5.449,99.873l90.537,0.791 ";d+="c107.676,0,154.502,14.043,237.998,71.006c268.447,183.389,234.111,600.093-60.879,736.655l-56.953,26.533l-53.066,136.563 ";
d+="c-28.877,74.917-82.715,205.239-118.613,288.735c-97.539,223.96-91.309,201.328-73.35,276.25 ";d+="c43.701,179.473,55.4,427.632,28.086,609.453c-64.766,437.783-309.805,813.911-702.314,1076.108 ";d+="c-280.146,188.066-613.359,305.122-991.055,348.042C2915.019,8417.992,2633.315,8425.019,2569.316,8420.336z M3025.053,8367.27 ";d+="c246.587-32.778,527.515-114.712,718.696-211.479c234.893-118.613,460.41-297.314,601.65-479.922 ";d+="c230.996-295.752,342.588-661.733,312.939-1024.6c-9.365-120.957-31.221-252.056-40.586-241.914 ";
d+="c-3.115,3.125-13.271,28.877-23.418,56.968c-51.494,147.485-166.201,336.333-283.262,468.213 ";d+="c-278.584,312.144-710.117,526.738-1191.601,593.071l-67.109,8.584l-24.199,52.28c-60.864,130.322-177.139,204.453-321.509,204.453 ";d+="c-156.846,0-280.918-85.84-333.208-229.419l-16.382-46.826l-69.458-13.267C1700.005,7390.258,1209.165,7065.634,932.915,6606 ";d+="c-26.533-44.473-53.843-85.054-60.869-89.736c-6.24-5.459-28.872-32.773-50.723-60.869c-24.976-32.773-40.581-47.598-43.701-41.362 ";d+="c-14.824,26.538-24.189,172.461-20.288,309.023c3.125,113.149,8.584,166.221,24.971,242.695 ";
d+="c53.062,254.395,165.439,490.059,333.989,698.418c63.994,79.6,216.943,227.861,298.1,290.293 ";d+="c322.285,245.029,714.024,392.515,1131.514,426.851C2629.409,8387.563,2932.182,8378.979,3025.053,8367.27z M2803.427,7740.644 ";d+="c145.142-45.259,241.133-200.552,214.595-347.261c-25.747-139.688-125.63-239.57-266.094-264.541 ";d+="c-105.347-18.726-227.871,30.43-294.976,120.171c-132.666,174.805-54.624,426.079,151.387,491.631 ";d+="C2679.35,7763.275,2730.854,7763.275,2803.427,7740.644z M3149.121,7483.905c703.887-112.373,1236.084-513.472,1421.816-1070.649 ";
d+="c65.547-196.646,82.715-353.5,74.902-688.276c-3.105-122.515-8.574-274.683-12.471-339.448 ";d+="c-5.469-91.309-4.688-142.808,4.668-234.111c9.365-85.84,11.709-169.336,8.594-316.045c-3.125-199.766-12.49-291.074-42.93-421.396 ";d+="l-13.252-58.525l-44.492-17.168c-56.182-22.622-236.436-58.521-427.637-85.825c-138.115-19.512-173.232-21.074-386.269-21.855 ";d+="c-189.629,0-251.279,3.125-323.848,14.043c-109.253,17.949-245.034,52.285-313.706,79.59l-49.937,20.298l-29.658,71.006 ";d+="c-38.237,94.424-82.72,168.564-128.76,216.172l-38.232,39.014l78.813,2.344c73.359,2.324,79.6,3.115,79.6,17.939 ";
d+="c0,15.605-4.683,15.605-245.82,13.271c-280.923-1.563-323.843-5.469-323.843-28.887c0-14.824,4.683-15.596,78.032-13.262 ";d+="l78.042,2.344l-23.418-17.949c-80.371-60.869-142.021-144.365-179.478-239.57c-20.293-50.723-24.194-56.172-49.941-63.213 ";d+="c-372.231-99.097-817.031-112.358-1200.967-34.331c-193.535,39.019-326.191,94.419-351.157,145.923 ";d+="c-19.517,40.586-54.629,195.879-63.999,285.625c-13.267,117.051-6.235,250.488,20.293,384.707l21.064,106.914l-16.382,88.955 ";d+="c-28.091,148.267-35.117,240.347-30.435,395.645c5.459,152.944,17.168,251.274,48.384,378.471 ";
d+="c162.314,678.13,702.319,1180.674,1455.361,1354.697c139.687,31.997,130.322,35.112,134.228-41.357 ";d+="c3.115-53.066,8.574-74.917,29.648-119.399c51.504-107.686,161.538-188.062,268.442-196.65l51.499-4.678v-168.555 ";d+="c0-92.866,3.125-173.247,7.031-179.487c3.901-6.24,12.48-8.584,19.512-6.24c10.918,4.683,12.48,26.533,12.48,180.264v174.795 ";d+="l34.336,4.683c92.856,14.048,199.771,98.33,246.592,195.088c24.185,48.389,27.31,63.213,29.653,131.104 ";d+="c2.339,42.139,6.24,76.475,10.142,76.475C3069.521,7496.391,3106.987,7490.927,3149.121,7483.905z M790.107,6310.248 ";
d+="c-53.843-137.339-89.741-309.018-109.248-523.613l-4.683-52.29l-67.891-3.12c-37.456-2.339-69.453-3.12-71.016-1.563 ";d+="c-3.896,3.901,53.066,172.461,98.33,287.954c53.843,137.338,161.533,354.282,170.898,344.917 ";d+="C808.057,6360.976,801.03,6337.558,790.107,6310.248z M4773.056,5893.535c42.91-109.248,78.809-199.771,78.809-201.328 ";d+="c0-1.563-39.014-3.12-86.621-3.901l-87.402-0.776l4.688,98.32c2.344,54.624,2.344,150.61-0.781,214.6 ";d+="c-3.906,85.84-3.125,112.373,3.125,103.007C4690.322,6096.43,4729.345,6002.006,4773.056,5893.535z M679.297,5581.391 ";
d+="c3.12-61.641,14.829-165.43,25.752-230.977l19.512-119.399l-16.387-82.72c-8.589-45.259-18.73-112.368-21.851-149.043 ";d+="l-5.464-66.328l-28.872-7.031c-38.242-9.355-135.781,9.365-196.65,38.242c-126.421,59.307-215.376,202.114-215.376,343.354 ";d+="c0,109.253,35.894,195.869,113.149,273.13c74.131,74.131,162.314,110.811,266.099,112.368l55.41,0.776L679.297,5581.391z ";d+=" M4854.208,5643.046c251.27-53.062,382.373-330.093,266.094-559.517c-44.482-87.402-150.615-172.461-248.154-198.203 ";d+="c-42.139-11.709-158.408-14.834-173.232-4.688c-5.469,3.115-10.928,53.848-14.043,130.313 ";
d+="c-3.125,68.677-8.594,149.834-12.49,179.492c-7.031,48.379,3.115,418.267,11.699,446.362 ";d+="C4689.55,5654.75,4782.412,5658.652,4854.208,5643.046z M821.323,4371.069c169.336-101.44,623.501-167.788,995.737-145.933 ";d+="c171.675,10.918,312.925,29.648,444.023,60.078c49.155,11.719,96.763,21.855,105.347,22.656 ";d+="c33.55,2.324,78.032-138.125,77.251-241.152c-1.553-167.773-91.299-231.758-412.807-296.543 ";d+="c-195.874-39.004-287.173-46.816-550.151-46.816c-269.224,0-341.792,7.031-515.81,50.742 ";d+=
"c-165.439,41.348-278.589,96.758-341.802,169.336c-80.381,91.289-71.792,220.059,24.976,344.121 ";d+="c30.435,39.805,108.472,110.815,122.515,110.815C773.726,4398.374,796.348,4385.893,821.323,4371.069z M4685.644,4296.152 ";d+="c95.986-62.422,166.221-164.648,172.451-251.27c5.479-67.891-10.137-109.258-57.734-161.543 ";d+="c-94.434-101.445-290.293-163.086-600.088-188.066c-248.164-20.293-771.777,12.5-959.848,60.078 ";d+="c-71.006,18.75-154.507,60.098-195.088,97.559c-88.179,81.152-107.686,197.422-57.744,344.922 ";
d+="c25.752,77.246,45.264,109.238,60.083,102.227c78.037-35.117,217.725-71.016,360.527-92.871 ";d+="c113.926-17.168,384.707-24.18,523.613-12.48c262.207,21.855,581.377,79.59,654.726,117.832 ";d+="C4624.775,4333.608,4631.025,4332.055,4685.644,4296.152z ";g.createChildNS("path",{"d":d,"fill":"RGBA(0,0,0,0.2)"})}};function SettingMenu(pane){this.pane=pane;this.width=200;this.title="Settings"}
SettingMenu.prototype={renderInto:function(wrapper){var that=this;var menuItem=wrapper.createChild("div",{"class":"menu-item setting-menu","title":this.title});var button=menuItem.createChild("div",{});this.pane.render32pxSvgIcon(button,"ICON32_MENU_Option");var subContainer=menuItem.createChild("div",{"class":"sub-container","style":"width: {0}px;".format(this.width)});subContainer.createChild("div",{"class":"sub-title no-select"},this.title);var subBody=subContainer.createChild("div",{"class":"sub-body"});
var settings=subBody.createChild("div",{"class":"sub-items"});var btnLock=this.renderCheckBox(settings,"Lock Selected Tool","Config.General.lockTool",null);var stage=null;var clickCount=0;var beginInitCount=6;var maxInitCount=3;btnLock.addEventListener("click",function(){clickCount++;console.log(clickCount);if(clickCount>=beginInitCount+maxInitCount){if(stage!=null){that.getWorkspace().switchDeveloperMode(false);that.getWorkspace().drawingBoard.showMessage("Cancel developer mode");stage.destroy();
stage=null}clickCount=0;that.pane.selectMenuItem(null)}if(clickCount==beginInitCount-1){that.getWorkspace().switchDeveloperMode(true);that.getWorkspace().drawingBoard.showMessage("Start developer mode")}if(clickCount>=beginInitCount){var addIcon=function(){stage.addIcon();if(stage.icons.length<2)setTimeout(addIcon,1E3)};if(stage==null){var containerGroup=that.getWorkspace().drawingBoard.underGroup;var svgWidth=that.getWorkspace().drawingBoard.svgSize.width;var svgHeight=that.getWorkspace().drawingBoard.svgSize.height;
stage=new Stage(containerGroup,svgWidth,svgHeight)}addIcon()}},false);this.renderCheckBox(settings,"Snap to Grids","Config.General.snapToGrid",null);this.renderCheckBox(settings,"Show Scale Rulers","Config.General.showScale",function(){that.getWorkspace().showScalePlate(Config.General.showScale)});this.renderCheckBox(settings,"Objects Manager","Config.General.showObjectManager",function(){that.getWorkspace().objectManager.show(Config.General.showObjectManager)});button.addEventListener("click",function(){that.pane.selectMenuItem(this.parentNode)},
false);return menuItem},getWorkspace:function(){return this.pane.workspace},getDrawingBoard:function(){return this.pane.workspace.drawingBoard},renderMenuItem:function(wrapper,label,configKey,callback){var button=wrapper.createChild("div",{"class":"text-item no-select"},label);button.addEventListener("click",function(e){if(this.hasClassName("selected")){this.removeClassName("selected");eval(configKey+" = false")}else{this.addClassName("selected");eval(configKey+" = true")}if(typeof callback=="function")callback()},
false);if(eval(configKey))button.addClassName("selected")},renderCheckBox:function(wrapper,label,configKey,callback){var button=wrapper.createChild("div",{"class":"checkbox-item no-select"},label);var icon=button.createChildNS("svg",{"class":"icon-checkbox","width":24,"height":24});var gChecked=icon.createChildNS("g",{"class":"icon-group-checked"});gChecked.createChildNS("path",{"fill":"#ffffff","d":"M6.534,9.467l-1.867,1.867l6,6L24,4l-1.865-1.867L10.667,13.6L6.534,9.467z M21.334,21.333H2.667V2.667H16V0H2.667C1.201,0,0,1.2,0,2.667v18.667C0,22.8,1.201,24,2.667,24h18.667C22.801,24,24,22.8,24,21.333V10.667h-2.666V21.333z"});
var gNormal=icon.createChildNS("g",{"class":"icon-group-normal"});gNormal.createChildNS("path",{"fill":"#010101","d":"M21.333,2.667v18.667H2.667V2.667H21.333 M21.333,0H2.667C1.2,0,0,1.201,0,2.667v18.667C0,22.801,1.2,24,2.667,24h18.667C22.8,24,24,22.801,24,21.334V2.667C24,1.201,22.8,0,21.333,0L21.333,0z"});button.addEventListener("click",function(e){if(this.hasClassName("selected")){this.removeClassName("selected");eval(configKey+" = false")}else{this.addClassName("selected");eval(configKey+" = true")}if(typeof callback==
"function")callback()},false);if(eval(configKey))button.addClassName("selected");return button}};function SlidePane(workspace){this.workspace=workspace;this.appMenu=null;this.toolMenu=null;this.fillMenu=null;this.strokeMenu=null;this.settingMenu=null;this.propertyMenu=null;this.wrapper=null;this.menuDoms=[];this.selectedMenuDom=null}
SlidePane.prototype={renderIntoWorkspace:function(){var that=this;this.wrapper=this.workspace.getWrapper().createChild("div",{"id":"slide-pane","style":"left: {0}px; top: {1}px".format(Config.SlidePane.left,Config.SlidePane.top)});this.appMenu=new AppMenu(this);this.menuDoms.push(this.appMenu.renderInto(this.wrapper));this.toolMenu=new ToolMenu(this);this.menuDoms.push(this.toolMenu.renderInto(this.wrapper));this.fillMenu=new ColorMenu(this,false);this.menuDoms.push(this.fillMenu.renderInto(this.wrapper));
this.strokeMenu=new ColorMenu(this,true);this.menuDoms.push(this.strokeMenu.renderInto(this.wrapper));this.settingMenu=new SettingMenu(this);this.menuDoms.push(this.settingMenu.renderInto(this.wrapper));this.propertyMenu=new PropertyMenu(this);this.menuDoms.push(this.propertyMenu.renderInto(this.wrapper));var sampleMenu=new SampleMenu(this);this.menuDoms.push(sampleMenu.renderInto(this.wrapper));var css3support=QStage.supportsTransitions();this.wrapper.style[css3support.prefixedProperty]="top 0.2s ease-in";
this.wrapper.addEventListener(css3support.prefixedEventName,function(){})},setMargin:function(left,top){this.wrapper.updateStyle("left",Config.SlidePane.left+left+"px");this.wrapper.updateStyle("top",Config.SlidePane.top+top+"px")},reset:function(){this.selectMenuItem(null)},resize:function(width,height){for(var i=0;i<this.menuDoms.length;i++){var item=this.menuDoms[i];if(item.hasClassName("menu-selected"))item.removeClassName("menu-selected")}this.wrapper.updateStyle("top",Config.SlidePane.top+"px");
this.fillMenu.resize(width,height);this.strokeMenu.resize(width,height)},selectMenuItem:function(newItem){if(this.selectedMenuDom==newItem){if(this.selectedMenuDom!=null){this.selectedMenuDom.removeClassName("menu-selected");this.selectedMenuDom=null}}else{if(this.selectedMenuDom!=null)this.selectedMenuDom.removeClassName("menu-selected");if(newItem!=null)newItem.addClassName("menu-selected");this.selectedMenuDom=newItem}if(this.workspace.isSmallScreen()||Config.General.developerMode)if(this.selectedMenuDom!=
null){var top=-this.selectedMenuDom.offsetTop+Config.SlidePane.top+4;this.wrapper.updateStyle("top",top+"px")}else this.wrapper.updateStyle("top",Config.SlidePane.top+"px")},selectToolType:function(newToolType){this.toolMenu.selectToolType(newToolType)},showPropertyMenu:function(shape){this.propertyMenu.showProperty(shape)},setFill:function(color,opacity){this.fillMenu.setData(color,opacity,null)},setStroke:function(color,opacity,width){this.strokeMenu.setData(color,opacity,width)},addSeperator:function(wrapper,
label){var seperator=wrapper.createChild("div",{"class":"seperator"});seperator.createChild("div",{"class":"seperator-line"});seperator.createChild("div",{"class":"seperator-label"},label)},renderIconButton:function(wrapper,text,iconName,closeMenuOnTap,callback){var that=this;var btnWrapper=wrapper.createChild("div",{"class":"icon-item no-select"});var iconWrapper=btnWrapper.createChild("div",{"class":"icon"});btnWrapper.createChild("div",{"class":"label"},text);this.render24pxSvgIcon(iconWrapper,
iconName);btnWrapper.addEventListener("click",function(e){if(typeof callback=="function")callback();if(closeMenuOnTap)that.selectMenuItem(null)},false)},render24pxSvgIcon:function(wrapper,iconName){var icon=wrapper.createChildNS("svg",{"class":"icon-svg-24px","width":24,"height":24});var g=icon.createChildNS("g");switch(iconName){case "ICON24_HOME":g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":"M3.263,22.096c0,0-0.021,0.537,0.503,0.537c0.652,0,6.05-0.008,6.05-0.008l0.009-4.957c0,0-0.085-0.818,0.708-0.818h2.51c0.938,0,0.88,0.818,0.88,0.818l-0.011,4.941c0,0,5.118,0,5.922,0c0.666,0,0.635-0.668,0.635-0.668v-9.139l-8.346-7.425l-8.86,7.425V22.096z"});
g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":"M0,12.111c0,0,0.752,1.387,2.393,0l9.804-8.295l9.192,8.243c1.899,1.37,2.61,0,2.61,0L12.197,1.367L0,12.111z"});g.createChildNS("polygon",{"fill":"#434A4D","stroke":"none","points":"21.166,3.797 18.803,3.797 18.813,6.664 21.166,8.662"});break;case "ICON24_SAVE":g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":"M19.5,0H18v9.75H6V0H0v24h24V4.5L19.5,0z M21,22.5H3V12h18V22.5z"});g.createChildNS("rect",{"fill":"#434A4D","stroke":"none",
"x":4.5,"y":13.5,"width":15,"height":1.5});g.createChildNS("rect",{"fill":"#434A4D","stroke":"none","x":4.5,"y":16.5,"width":15,"height":1.5});g.createChildNS("rect",{"fill":"#434A4D","stroke":"none","x":4.5,"y":19.5,"width":15,"height":1.5});g.createChildNS("rect",{"fill":"#434A4D","stroke":"none","x":13.5,"y":1.5,"width":3,"height":6.75});break;case "ICON24_PLAY":var d="";d+="M6,2L6,22L20,12z";g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":d});break;case "ICON24_SHARE":var d="";d+=
"M19.229,16.965c-0.916,0-1.734,0.359-2.359,0.926l-8.593-4.999c0.063-0.277,0.11-0.557,0.11-0.845";d+="s-0.049-0.566-0.11-0.844l8.497-4.951c0.646,0.6,1.504,0.975,2.455,0.975c2.002,0,3.617-1.611,3.617-3.614";d+="C22.846,1.615,21.23,0,19.229,0c-2,0-3.615,1.615-3.615,3.613c0,0.292,0.049,0.566,0.111,0.844L7.228,9.412";d+="C6.579,8.809,5.723,8.435,4.771,8.435c-2.003,0-3.617,1.614-3.617,3.613c0,2,1.614,3.615,3.617,3.615";d+="c0.95,0,1.808-0.375,2.455-0.975l8.578,5.008c-0.059,0.256-0.096,0.521-0.096,0.787c0,1.939,1.58,3.518,3.518,3.518";
d+="c1.939,0,3.521-1.578,3.521-3.518C22.748,18.541,21.166,16.965,19.229,16.965z";g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":d});break;case "ICON24_NEW":var d="";d+="M20.294,5.87h-5.229V0.641c0-0.347-0.281-0.628-0.627-0.628H3.665c-0.347,0-0.628,0.282-0.628,0.628";d+="v22.731C3.037,23.718,3.318,24,3.665,24h16.629c0.348,0,0.629-0.282,0.629-0.628V6.498C20.923,6.151,20.642,5.87,20.294,5.87z";g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":d});var d="";d+="M17.144,4.354h3.283c0.219,0,0.412-0.129,0.496-0.33c0.082-0.201,0.037-0.43-0.117-0.583l-3.285-3.285";
d+="C17.419,0.056,17.286,0,17.142,0c-0.07,0-0.139,0.013-0.203,0.041c-0.201,0.083-0.332,0.277-0.332,0.494v3.285";d+="C16.606,4.114,16.849,4.354,17.144,4.354z";g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":d});break;case "ICON24_DOWNLOAD":var d="";d+="M19.399,10C18.7,6.6,15.7,4,12,4C9.1,4,6.6,5.6,5.4,8C2.3,8.4,0,10.9,0,14c0,3.301,2.7,6,6,6h13";d+="c2.8,0,5-2.199,5-5C24,12.4,21.9,10.2,19.399,10z M17,13l-5,5l-5-5h3V9h4v4H17z";g.createChildNS("path",{"fill":"#434A4D","stroke":"none","d":d});
break}return icon},render32pxSvgIcon:function(wrapper,iconName){var icon=wrapper.createChildNS("svg",{"class":"icon-svg-32px","width":32,"height":32});var g=icon.createChildNS("g");switch(iconName){case "ICON32_MENU_App":var size=32;var padding=size*10/300;var path="M{0},{1} H{2} L {3},{4} H {0} Z".format(size/3+padding,padding,size*2/3,size-padding,size/3-padding);g.createChildNS("path",{"fill":"#22CB20","stroke":"#22CB20","stroke-width":padding,"stroke-linejoin":"round","d":path});g.createChildNS("path",
{"fill":"#06ACD4","stroke":"#06ACD4","stroke-width":padding,"stroke-linejoin":"round","d":path,transform:"translate(0,0), rotate({1},{0},{0})".format(size/2,1*90)});g.createChildNS("path",{"fill":"#FFCC00","stroke":"#FFCC00","stroke-width":padding,"stroke-linejoin":"round","d":path,transform:"translate(0,0), rotate({1},{0},{0})".format(size/2,2*90)});g.createChildNS("path",{"fill":"#FA5151","stroke":"#FA5151","stroke-width":padding,"stroke-linejoin":"round","d":path,transform:"translate(0,0), rotate({1},{0},{0})".format(size/
2,3*90)});break;case "ICON32_MENU_Option":var d="";d+="M17.8,31.7h-3.4c-0.5,0-0.7,0-2.4-4.3l-1.3-0.5c-3.6,1.6-4.1,1.6-4.2,1.6H6.2l-0.2-0.2L3.5,26 ";d+="c-0.4-0.4-0.5-0.5,1.4-4.7L4.4,20C0,18.4,0,18.2,0,17.7v-3.3c0-0.5,0-0.7,4.4-2.4l0.5-1.3c-2-4.2-1.8-4.3-1.4-4.6L6,3.6l0.3,0 ";d+="c0.4,0,1.8,0.5,4.3,1.6l1.3-0.5c1.6-4.3,1.8-4.3,2.3-4.3h3.4c0.5,0,0.7,0,2.4,4.3l1.3,0.5c3.6-1.6,4.1-1.6,4.2-1.6h0.3l0.2,0.2 ";d+="L28.4,6c0.4,0.4,0.5,0.5-1.4,4.7l0.5,1.3c4.4,1.6,4.4,1.7,4.4,2.3v3.3c0,0.5,0,0.7-4.4,2.4l-0.5,1.3c2,4.1,1.8,4.3,1.5,4.6 ";
d+="L26,28.4l-0.3,0c-0.4,0-1.8-0.5-4.3-1.6l-1.3,0.5C18.4,31.7,18.3,31.7,17.8,31.7z M14.7,30.3h2.7c0.3-0.6,1-2.3,1.5-3.7 ";d+="l0.1-0.3l2.4-1l0.3,0.1c1.4,0.6,3.1,1.3,3.8,1.5l1.9-1.8c-0.2-0.7-1-2.3-1.6-3.6l-0.1-0.3l1-2.4l0.3-0.1 ";d+="c1.5-0.6,3.1-1.3,3.8-1.6v-2.6c-0.6-0.3-2.3-0.9-3.8-1.5l-0.3-0.1l-1-2.4l0.1-0.3c0.6-1.4,1.3-3,1.5-3.7l-1.9-1.8 ";d+="c-0.6,0.2-2.3,0.9-3.7,1.6l-0.3,0.1l-2.4-1l-0.1-0.3c-0.6-1.4-1.3-3.1-1.6-3.7h-2.7c-0.3,0.6-1,2.3-1.5,3.7L13,5.6l-2.4,1 ";d+="l-0.3-0.1C8.9,5.9,7.2,5.2,6.5,5L4.7,6.8c0.2,0.7,1,2.3,1.6,3.6l0.1,0.3l-1,2.4l-0.3,0.1c-1.5,0.6-3.1,1.2-3.8,1.6v2.6 ";
d+="c0.6,0.3,2.3,0.9,3.8,1.5l0.3,0.1l1,2.4l-0.1,0.3c-0.6,1.4-1.3,3-1.5,3.7l1.9,1.8c0.6-0.2,2.3-0.9,3.7-1.6l0.3-0.1l2.4,1 ";d+="l0.1,0.3C13.7,28.1,14.4,29.7,14.7,30.3z M16,21.5c-3.1,0-5.6-2.5-5.6-5.5c0-3,2.5-5.5,5.6-5.5c3.1,0,5.6,2.5,5.6,5.5 ";d+="C21.6,19,19.1,21.5,16,21.5z M16,11.9c-2.3,0-4.2,1.8-4.2,4.1c0,2.3,1.9,4.1,4.2,4.1c2.3,0,4.2-1.9,4.2-4.1 ";d+="C20.2,13.7,18.3,11.9,16,11.9z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"#FFFFFF","stroke-width":1,"d":d});break;case "ICON32_MENU_Property":g.createChildNS("circle",
{"fill":"none","stroke":"#FFFFFF","stroke-width":2,"cx":16,"cy":16,"r":15});g.createChildNS("circle",{"fill":"#FFFFFF","stroke":"none","cx":8,"cy":16,"r":2});g.createChildNS("circle",{"fill":"#FFFFFF","stroke":"none","cx":16,"cy":16,"r":2});g.createChildNS("circle",{"fill":"#FFFFFF","stroke":"none","cx":24,"cy":16,"r":2});break;case "ICON32_TOOL_Picker":g.createChildNS("polygon",{"fill":"none","stroke":"#FFFFFF","stroke-width":2,"points":"8.5,2 25,17.9 16.8,17.9 22,30.2 19.5,31.2 14.3,19 8.5,24.7"});
break;case "ICON32_TOOL_Move":var d="";d+="M31.917,15.593l-0.229-0.346l-4.267-4.267c-0.416-0.416-1.094-0.416-1.508,0";d+="c-0.416,0.416-0.416,1.092,0,1.508l2.444,2.445H17.066V3.642l2.445,2.445c0.414,0.416,1.092,0.416,1.508,0";d+="c0.414-0.416,0.414-1.092,0-1.508l-4.267-4.267l-0.011-0.006l-0.335-0.222L16,0h-0.004l-0.403,0.083l-0.335,0.222l-0.013,0.006";d+="l-4.267,4.267c-0.416,0.416-0.416,1.092,0,1.508s1.092,0.416,1.508,0l2.447-2.445v11.292H3.642l2.445-2.445";d+="c0.416-0.416,0.416-1.092,0-1.508s-1.092-0.416-1.508,0l-4.267,4.267l-0.006,0.011l-0.222,0.335L0,16v0.004l0.083,0.403";
d+="l0.222,0.333l0.006,0.013l4.267,4.266c0.416,0.416,1.092,0.416,1.508,0c0.416-0.414,0.416-1.092,0-1.508l-2.445-2.445h11.292";d+="v11.293l-2.445-2.445c-0.416-0.414-1.092-0.414-1.508,0c-0.416,0.416-0.416,1.094,0,1.508l4.267,4.268l0.346,0.23L15.996,32H16";d+="l0.407-0.082l0.346-0.229l4.267-4.268c0.414-0.416,0.414-1.094,0-1.508c-0.416-0.416-1.094-0.416-1.508,0l-2.445,2.445V17.066";d+="h11.292l-2.444,2.445c-0.414,0.414-0.414,1.092,0,1.508c0.416,0.414,1.094,0.414,1.508,0l4.267-4.266l0.23-0.346L32,16.004V16";
d+="L31.917,15.593z";g.createChildNS("path",{"fill":"#ffffff","d":d});break;case "ICON32_TOOL_Crop":g.createChildNS("path",{"fill":"none","stroke":"#FFFFFF","stroke-width":2,"d":"M2,8 V2 H8 M24,2 H30 V8 M30,24 V30 H24 M8,30 H2 V24 M16,12 V20 M12,16 H 20"});break;case "ICON32_TOOL_Rectangle":g.createChildNS("path",{"fill":"#ffffff","d":"M0,0v32h32V0H0z M30,30H2L2,2l28,0V30z"});break;case "ICON32_TOOL_Ellipse":g.createChildNS("path",{"fill":"#ffffff","d":"M16,0C7.2,0,0,7.2,0,16s7.2,16,16,16c8.8,0,16-7.2,16-16S24.8,0,16,0z M16,30C8.2,30,2,23.8,2,16 S8.2,2,16,2c7.7,0,14,6.3,14,14S23.7,30,16,30z"});
break;case "ICON32_TOOL_Line":g.createChildNS("rect",{"x":0,"y":15,"width":32,"height":2,"fill":"#ffffff"});break;case "ICON32_TOOL_Polygon":var d="";var vertexNumber=5;var x0=16;var y0=16;var r=15;var unitAngle=2*Math.PI/vertexNumber;var baseAngle=-90/180*Math.PI;for(var i=0;i<vertexNumber;i++){var radian=unitAngle*i+baseAngle;var x=x0+r*Math.cos(radian);var y=y0+r*Math.sin(radian);var cmd=i==0?"M{0},{1}":" L{0},{1}";d+=cmd.format(x.toFixed(2),y.toFixed(2))}d+=" Z";g.createChildNS("path",{"fill":"none",
"stroke":"#FFFFFF","stroke-width":2,"d":d,"stroke-linecap":"butt","stroke-linejoin":"miter"});break;case "ICON32_TOOL_Pencil":g.createChildNS("path",{"fill":"#ffffff","d":"M9.3,1.4L9.3,1.4L0,0l1.3,9.2l0,0l0,0l0,0l0,0L24.1,32l1.5-1.5l6.4-6.4L9.3,1.4z M2.4,2.5l4.4,1.2 L3.7,6.9L2.4,2.5z M4.5,9.5l4.8-4.8l14,14l-4.8,4.8L4.5,9.5z M23.9,28.8l-3.5-3.5l4.8-4.8l3.5,3.5L23.9,28.8z"});break;case "ICON32_TOOL_Pen":var d="";d+="M26.477,15.592l-3.056-8.343c-0.13-0.351-0.531-0.639-0.894-0.639H10.5";d+="c-0.363,0-0.765,0.288-0.894,0.639L6.55,15.592c-0.129,0.351-0.095,0.91,0.075,1.242l6.887,13.971";
d+="c0.17,0.332,0.606,0.603,0.968,0.603h0.896c0.363,0,0.649-0.307,0.637-0.681l-0.208-13.733";d+="c-0.013-0.376-0.264-0.862-0.559-1.082c0,0-1.201-0.894-1.201-2.041c0-1.411,1.105-2.555,2.469-2.555";d+="c1.364,0,2.468,1.144,2.468,2.555c0,1.147-1.2,2.041-1.2,2.041c-0.295,0.22-0.547,0.706-0.561,1.082l-0.227,13.749";d+="c-0.013,0.376,0.272,0.684,0.635,0.684h0.926c0.363,0,0.798-0.271,0.969-0.604l6.879-13.989";d+="C26.572,16.502,26.605,15.943,26.477,15.592z";g.createChildNS("path",{"fill":"none","stroke":"#FFFFFF",
"stroke-width":2,"d":d});d="";d+="M9.397,5.292h14.231c0.361,0,0.66-0.307,0.66-0.682V1.257c0-0.375-0.299-0.683-0.66-0.683";d+="H9.397c-0.363,0-0.66,0.307-0.66,0.683V4.61C8.738,4.985,9.034,5.292,9.397,5.292z";g.createChildNS("path",{"fill":"none","stroke":"#FFFFFF","stroke-width":2,"d":d});break;case "ICON32_TOOL_Label":g.createChildNS("polygon",{"style":"fill:#FFFFFF;","points":"23.91,10.705 23.91,12.348 30.359,12.348 30.359,21.393 23.91,21.393 23.91,23.033 32,23.033 32,10.705"});g.createChildNS("polygon",
{"style":"fill:#FFFFFF;","points":"17.599,21.393 1.641,21.393 1.641,12.348 17.599,12.348 17.599,10.705 0,10.705 0,23.033 17.599,23.033"});var d="";d+="M21.942,26.466c-0.067-0.069-0.114-0.147-0.153-0.249V7.854l-0.005-0.125";d+="c0.032-0.16,0.098-0.292,0.204-0.403C22.302,7,22.912,6.93,23.369,6.93h0.854V4.794";d+="h-0.854c-1.096,0-1.979,0.264-2.631,0.784c-0.655-0.556-1.561-0.837-2.689-0.837";d+="h-0.855v2.138h0.855c0.454,0,1.064,0.067,1.379,0.396c0.068,0.069,0.121,0.154,0.155,0.251";d+="v18.403c0,0.012-0.002,0.31-0.223,0.537c-0.316,0.329-0.927,0.4-1.384,0.4h-0.854V29h0.854";
d+="c1.121,0,2.02-0.276,2.674-0.819C21.306,28.728,22.202,29,23.32,29h0.857v-2.134H23.32";d+="C22.864,26.864,22.256,26.795,21.942,26.466z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});break;case "ICON32_TOOL_Map":var d="";d+="M10.866,17.107c1.119,0,2.025,0.906,2.025,2.025c0,1.117-0.907,2.025-2.025,2.025S8.84,20.25,8.84,19.133";d+="C8.84,18.014,9.747,17.107,10.866,17.107z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});d="";d+="M30.59,18.734l1.373-10.828l-9.852-3.738L10.295,9.813L0,5.465l1.39,11.551L0.058,28.389l10.938,2.053";
d+="l11.158-2.125L32,30.588L30.59,18.734z M22.074,5.315l8.727,3.288l-0.602,4.734l-8.695-2.2L22.074,5.315z M20.92,5.917";d+="l-0.459,4.957l-0.008-0.002l-6.022,0.777l-0.036,0.133c-0.008,0.029-0.706,2.61-1.442,3.784c-0.477-0.28-1.012-0.468-1.585-0.538";d+="l-0.488-4.316L20.92,5.917z M20,16.973l-5.233,0.789c-0.282-0.797-0.799-1.481-1.471-1.971c0.685-1.094,1.304-3.211,1.459-3.77";d+="l5.667-0.731L20,16.973z M9.815,10.764l0.484,4.274c-1.591,0.219-2.896,1.342-3.374,2.835l-4.462-0.691l-0.429-4.139";d+="c1.479-0.098,2.589-0.579,3.3-1.438c0.641-0.773,0.826-1.688,0.861-2.37L9.815,10.764z M1.288,7.163l4.499,1.9";
d+="c-0.013,0.627-0.155,1.538-0.769,2.279c-0.641,0.773-1.661,1.206-3.036,1.292L1.288,7.163z M1.23,27.527l1.107-9.289l4.401,0.682";d+="c-0.003,0.07-0.01,0.141-0.01,0.213c0,0.967,0.336,1.857,0.896,2.563l-2.286,1.836l-0.72,4.631L1.23,27.527z M9.853,29.145";d+="l-4.832-0.906l0.698-4.488l2.175-1.746c0.667,0.691,1.57,1.15,2.579,1.246L9.853,29.145z M7.549,19.133";d+="c0-1.83,1.488-3.317,3.316-3.317c1.83,0,3.317,1.487,3.317,3.317c0,1.828-1.488,3.316-3.317,3.316";d+="C9.037,22.449,7.549,20.961,7.549,19.133z M10.995,29.359l-0.093-0.018l0.646-6.133c1.958-0.326,3.457-2.027,3.457-4.076";
d+="c0-0.111-0.008-0.221-0.017-0.328l5.116-0.771l0.428,4.363c-2.244,0.104-3.922,0.795-4.979,2.068";d+="c-1.231,1.488-1.289,3.342-1.226,4.26L10.995,29.359z M14.737,28.646c-0.05-0.871,0.022-2.578,1.132-3.918";d+="c0.982-1.186,2.567-1.826,4.702-1.924l0.455,4.643L14.737,28.646z M21.465,11.551l8.684,2.196l-0.52,4.103l-8.574-1.035";d+="L21.465,11.551z M28.447,21.393l-3.951-0.469l0.725,7.008l-3.166-0.68l-0.898-9.377l0.092-0.014l8.289,1.051l1.227,10.301";d+="l-5.129-1.184l-0.678-6.637l3.521,0.408L28.447,21.393z";
g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});break;case "ICON32_TOOL_Poi":var d="";d+="M16.791,0c-5.988,0-10.86,4.872-10.86,10.86c0,2.406,1.417,6.065,4.459,11.517";d+="c2.076,3.72,4.142,6.861,4.229,6.994l1.493,2.264C16.262,31.862,16.518,32,16.791,32s0.528-0.138,0.679-0.365l1.494-2.264";d+="c0.086-0.131,2.137-3.245,4.229-6.994c3.042-5.45,4.459-9.11,4.459-11.517C27.651,4.872,22.779,0,16.791,0z M21.771,21.584";d+="c-2.063,3.696-4.081,6.762-4.166,6.891l-0.814,1.234l-0.814-1.234c-0.085-0.13-2.12-3.223-4.167-6.891";
d+="C8.989,16.528,7.558,12.92,7.558,10.86c0-5.091,4.142-9.233,9.233-9.233s9.232,4.142,9.232,9.233";d+="C26.023,12.92,24.593,16.528,21.771,21.584z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});d="";d+="M16.791,4.771c-3.32,0-6.021,2.701-6.021,6.021c0,3.32,2.701,6.021,6.021,6.021s6.021-2.701,6.021-6.021";d+="C22.813,7.472,20.111,4.771,16.791,4.771z M16.791,15.187c-2.423,0-4.394-1.971-4.394-4.394s1.971-4.394,4.394-4.394";d+="s4.394,1.971,4.394,4.394S19.214,15.187,16.791,15.187z";g.createChildNS("path",
{"fill":"#FFFFFF","stroke":"none","d":d});break;case "ICON32_TOOL_Block":var d="";d+="M28.405,4.527h-9.918C18.218,4.527,18,4.746,18,5.015v1.46c0,0.269,0.218,0.487,0.487,0.487h9.918";d+="c0.641,0,1.161,0.521,1.161,1.162v16.095c0,0.641-0.521,1.16-1.161,1.16h-9.918c-0.27,0-0.487,0.219-0.487,0.488v1.457";d+="c0,0.27,0.218,0.49,0.487,0.49h9.918c1.982,0,3.595-1.615,3.595-3.596V8.124C32,6.141,30.387,4.527,28.405,4.527z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});d="";d+="M3.595,27.813h9.918c0.27,0,0.487-0.218,0.487-0.487v-1.461c0-0.268-0.218-0.486-0.487-0.486H3.595";
d+="c-0.641,0-1.161-0.521-1.161-1.162V8.123c0-0.642,0.521-1.16,1.161-1.16h9.918c0.27,0,0.487-0.219,0.487-0.489V5.016";d+="c0-0.27-0.218-0.489-0.487-0.489H3.595C1.612,4.527,0,6.141,0,8.123v16.094C0,26.2,1.613,27.813,3.595,27.813z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":"M15,9h2v14h-2V9z"});break;case "ICON32_TOOL_Eraser":var d="";d+="M28.405,4.527h-9.918C18.218,4.527,18,4.746,18,5.015v1.46c0,0.269,0.218,0.487,0.487,0.487h9.918";
d+="c0.641,0,1.161,0.521,1.161,1.162v16.095c0,0.641-0.521,1.16-1.161,1.16h-9.918c-0.27,0-0.487,0.219-0.487,0.488v1.457";d+="c0,0.27,0.218,0.49,0.487,0.49h9.918c1.982,0,3.595-1.615,3.595-3.596V8.124C32,6.141,30.387,4.527,28.405,4.527z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});d="";d+="M3.595,27.813h9.918c0.27,0,0.487-0.218,0.487-0.487v-1.461c0-0.268-0.218-0.486-0.487-0.486H3.595";d+="c-0.641,0-1.161-0.521-1.161-1.162V8.123c0-0.642,0.521-1.16,1.161-1.16h9.918c0.27,0,0.487-0.219,0.487-0.489V5.016";
d+="c0-0.27-0.218-0.489-0.487-0.489H3.595C1.612,4.527,0,6.141,0,8.123v16.094C0,26.2,1.613,27.813,3.595,27.813z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});break;default:var d="";d+="M31.732,6.211l0.023-0.058L16.37,0L9.131,2.797l-0.046-0.02L9.064,2.824l-8.78,3.393L0.232,6.197v0.04";d+="L0.23,6.237l0.002,0.006v19.735l15.205,5.998V32h1.127v-0.023l15.205-5.998V6.197L31.732,6.211z M30.643,16.468l-6.395,2.346";d+="v-8.439l6.395-2.523V16.468z M15.438,13.405v8.231l-6.513-2.355v-8.446L15.438,13.405z M9.68,9.924l6.545-2.722l6.093,2.723";
d+="L16,12.417L9.68,9.924z M16.564,13.405l6.557-2.586v8.408l-6.557,2.404V13.405L16.564,13.405z M23.785,9.346l-6.129-2.739";d+="l5.984-2.49l6.66,2.659L23.785,9.346z M16.356,1.21l5.788,2.31l-5.902,2.455l-5.661-2.529L16.356,1.21z M9.103,4.019l5.709,2.551";d+="L8.175,9.329L1.84,6.83L9.103,4.019z M7.799,10.392v8.481l-6.439-2.329V7.852L7.799,10.392z M1.359,17.742l6.439,2.33v7.68";d+="l-6.439-2.541V17.742z M8.924,28.195v-7.717l6.513,2.357v7.928L8.924,28.195z M16.564,22.832l6.557-2.404v7.75l-6.557,2.586V22.832";
d+="L16.564,22.832z M24.248,27.734v-7.721l6.395-2.346v7.543L24.248,27.734z";g.createChildNS("path",{"fill":"#FFFFFF","stroke":"none","d":d});break}return icon}};function ToolMenu(pane){this.pane=pane;this.width=236;this.title="Tools";this.button=null;this.options=[]}
ToolMenu.prototype={renderInto:function(wrapper){var that=this;var menuItem=wrapper.createChild("div",{"class":"menu-item tool-menu","title":this.title});this.button=menuItem.createChild("div",{});this.renderToolIcon();var subContainer=menuItem.createChild("div",{"class":"sub-container","style":"width: {0}px;".format(this.width)});var subTitle=subContainer.createChild("div",{"class":"sub-title no-select"},this.title);var subBody=subContainer.createChild("div",{"class":"sub-body"});var tools=subBody.createChild("div",
{"class":"tools"});this.pane.addSeperator(tools,"General");this.renderToolOption(tools,"Picker","ICON32_TOOL_Picker",ToolTypes.Picker);this.renderToolOption(tools,"Move Canvas","ICON32_TOOL_Move",ToolTypes.Move);this.renderToolOption(tools,"Drawing Board","ICON32_TOOL_Crop",ToolTypes.Crop);this.pane.addSeperator(tools,"Shape");this.renderToolOption(tools,"Rectangle","ICON32_TOOL_Rectangle",ToolTypes.Rectangle);this.renderToolOption(tools,"Ellipse","ICON32_TOOL_Ellipse",ToolTypes.Ellipse);this.renderToolOption(tools,
"Line","ICON32_TOOL_Line",ToolTypes.Line);this.renderToolOption(tools,"Polygon","ICON32_TOOL_Polygon",ToolTypes.Polygon);this.renderToolOption(tools,"Pencil","ICON32_TOOL_Pencil",ToolTypes.Pencil);this.renderToolOption(tools,"Pen","ICON32_TOOL_Pen",ToolTypes.Pen);this.renderToolOption(tools,"Label","ICON32_TOOL_Label",ToolTypes.Label);var hidden_map_tools=tools.createChild("div",{"id":"hidden_map_tools","style":"display: none"});this.pane.addSeperator(hidden_map_tools,"Map");this.renderToolOption(hidden_map_tools,
"Show Map","ICON32_TOOL_Map",ToolTypes.Map);this.renderToolOption(hidden_map_tools,"Point of Interest","ICON32_TOOL_Poi",ToolTypes.Poi);this.renderToolOption(hidden_map_tools,"Block","ICON32_TOOL_Block",ToolTypes.Block);this.renderToolOption(hidden_map_tools,"Unblock","ICON32_TOOL_Eraser",ToolTypes.Eraser);this.button.addEventListener("click",function(){that.pane.selectMenuItem(this.parentNode)},false);return menuItem},getPainting:function(){return this.pane.workspace.painting},renderToolIcon:function(){var icon=
null;switch(this.getPainting().toolType){case ToolTypes.None:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_?");break;case ToolTypes.Picker:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Picker");break;case ToolTypes.Move:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Move");break;case ToolTypes.Crop:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Crop");break;case ToolTypes.Line:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Line");break;case ToolTypes.Rectangle:icon=
this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Rectangle");break;case ToolTypes.Ellipse:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Ellipse");break;case ToolTypes.Polygon:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Polygon");break;case ToolTypes.Pencil:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Pencil");break;case ToolTypes.Pen:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Pen");break;case ToolTypes.Label:icon=this.pane.render32pxSvgIcon(this.button,
"ICON32_TOOL_Label");break;case ToolTypes.Map:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Map");break;case ToolTypes.Poi:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Poi");break;case ToolTypes.Block:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Block");break;case ToolTypes.Eraser:icon=this.pane.render32pxSvgIcon(this.button,"ICON32_TOOL_Eraser");break}return icon},renderToolOption:function(wrapper,title,iconName,toolType){var that=this;var button=wrapper.createChild("div",
{"title":title,"class":"tool-icon-wrapper"+(toolType==workspace.painting.toolType?" tool-icon-selected":""),"data-toolType":toolType});this.pane.render32pxSvgIcon(button,iconName);button.addEventListener("click",function(){var type=parseInt(this.getAttribute("data-toolType"));if(type==workspace.painting.toolType);else that.getPainting().selectTool(type);that.pane.selectMenuItem(null)},false);this.options.push(button);return button},selectToolType:function(newToolType){this.hiddenClickCount=0;this.button.removeChild(this.button.firstChild);
this.renderToolIcon();for(var i=0;i<this.options.length;i++){var toolButton=this.options[i];var type=parseInt(toolButton.getAttribute("data-toolType"));if(type==newToolType&&!toolButton.hasClassName("tool-icon-selected"))toolButton.addClassName("tool-icon-selected");else if(toolButton.hasClassName("tool-icon-selected")&&type!=newToolType)toolButton.removeClassName("tool-icon-selected")}}};
function Painting(workspace){this.workspace=workspace;this.shapes=[];this.maxShapeId=-1;this.toolType=ToolTypes.Picker;this.modified=false;this.fill={"color":Config.DrawingBoard.fillColor,"opacity":Config.DrawingBoard.fillOpacity};this.stroke={"color":Config.DrawingBoard.strokeColor,"opacity":Config.DrawingBoard.strokeOpacity,"width":Config.DrawingBoard.strokeWidth};this.selectingShape=null;this.selectedShape=null;this.onToolChanged=null;this.onFillChanged=null;this.onStrokeChanged=null;this.onShapeChanged=
null;this.onShapeAppended=null;this.onShapeRemoved=null;this.onShapeSorted=null;this.onProjectChanged=null}
Painting.prototype={removeAllShapes:function(){while(this.shapes.length>0)this.shapes[0].remove()},reset:function(){this.selectTool(ToolTypes.Picker);this.setFill(Config.DrawingBoard.fillColor,Config.DrawingBoard.fillOpacity);this.setStroke(Config.DrawingBoard.strokeColor,Config.DrawingBoard.strokeOpacity,Config.DrawingBoard.strokeWidth);this.removeAllShapes()},getNextId:function(){return++this.maxShapeId},createShape:function(type,container,transformInfo){var shape=null;switch(type){case ShapeTypes.Line:shape=
new Line(container,transformInfo,null,null);break;case ShapeTypes.Rectangle:shape=new Rectangle(container,transformInfo,null,null);break;case ShapeTypes.Ellipse:shape=new Ellipse(container,transformInfo,null,null);break;case ShapeTypes.Polygon:shape=new Polygon(container,transformInfo,null,null);break;case ShapeTypes.Freeline:shape=new Freeline(container,transformInfo,null,null);break;case ShapeTypes.Label:shape=new Label(container,transformInfo,null,null);break;case ShapeTypes.Polyline:shape=new Polyline(container,
transformInfo,null,null);break}this.appendShape(shape);this.selectShape(shape);return shape},appendShape:function(shape){var that=this;this.shapes.push(shape);shape.onStatusChanged=function(){that.projectChanged()};if(typeof this.onShapeAppended=="function")this.onShapeAppended(shape);this.projectChanged()},searchShape:function(shape){for(var i=0;i<this.shapes.length;i++)if(this.shapes[i]==shape)return i;return-1},changeShapePosition:function(shape,newIndex){if(newIndex>this.shapes.length-1||newIndex<
0)return;var oldIndex=this.searchShape(shape);if(oldIndex<0)return;if(oldIndex==newIndex)return;if(oldIndex<newIndex)for(var i=oldIndex;i<newIndex;i++)this.shapes[i]=this.shapes[i+1];else for(var i=oldIndex;i>newIndex;i--)this.shapes[i]=this.shapes[i-1];this.shapes[newIndex]=shape;if(typeof this.onShapeSorted=="function")this.onShapeSorted(shape,oldIndex,newIndex);this.projectChanged()},removeShape:function(shape){var index=this.searchShape(shape);if(index>=0)this.shapes.splice(index,1);if(typeof this.onShapeRemoved==
"function")this.onShapeRemoved(shape,index);this.projectChanged()},selectTool:function(newToolType){if(this.toolType==newToolType)return;var oldToolType=this.toolType;this.toolType=newToolType;if(typeof this.onToolChanged=="function")this.onToolChanged(oldToolType,newToolType)},setFill:function(color,opacity){this.fill.color=color;this.fill.opacity=opacity;if(typeof this.onFillChanged=="function")this.onFillChanged(color,opacity)},setStroke:function(color,opacity,width){this.stroke.color=color;this.stroke.opacity=
opacity;this.stroke.width=width;if(typeof this.onStrokeChanged=="function")this.onStrokeChanged(color,opacity,width)},selectShape:function(shape){if(this.selectedShape==shape)return;else{if(this.selectedShape!=null)this.selectedShape.setSelected(false);this.selectedShape=shape;if(shape!=null)shape.setSelected(true);if(typeof this.onShapeChanged=="function")this.onShapeChanged(shape)}},selectShapeById:function(id){if(id<0)this.selectShape(null);for(var i=0;i<this.shapes.length;i++)if(this.shapes[i].id==
id)this.selectShape(this.shapes[i])},isShapeTool:function(){return this.toolType==ToolTypes.Rectangle||this.toolType==ToolTypes.Ellipse||this.toolType==ToolTypes.Line||this.toolType==ToolTypes.Polygon||this.toolType==ToolTypes.Pencil||this.toolType==ToolTypes.Pen||this.toolType==ToolTypes.Label},projectChanged:function(){this.modified=true;if(typeof this.onProjectChanged=="function")this.onProjectChanged()},getCanvas:function(){var frame=this.workspace.drawingBoard.canvasFrame.transFrame;return{position:frame.getPosition(),
boundary:frame.getBoundary()}},setCanvas:function(jsonObject){var frame=this.workspace.drawingBoard.canvasFrame.transFrame;var position=jsonObject.position;var boundary=jsonObject.boundary;frame.moveTo(position.x,position.y,false);frame.transformTo(boundary.left,boundary.top,boundary.right,boundary.bottom,true)},serialize:function(type){var o={canvas:this.getCanvas(),shapes:[]};for(var i=0;i<this.shapes.length;i++)o.shapes.push(this.shapes[i].toJsonObject());if(type=="JSON")return o;else if(type==
"STRING")return JSON.stringify(o);else return null},deserialize:function(obj,type){this.workspace.autoSaveEnabled=false;this.removeAllShapes();var o=null;if(type=="JSON")o=obj;else if(type=="STRING")o=JSON.stringify(o);else{this.workspace.autoSaveEnabled=true;return false}this.setCanvas(o.canvas);for(var i=0;i<o.shapes.length;i++){var shape=BaseShape.fromJsonObject(o.shapes[i]);this.appendShape(shape)}this.workspace.autoSaveEnabled=true;return true}};
function DrawingBoard(workspace){this.workspace=workspace;this.wrapper=null;this.svg=null;this.underGroup=null;this.shapeGroup=null;this.upperGroup=null;this.canvasFrame=null;this.svgOffset={x:0,y:0};this.svgSize={width:0,height:0};this.onBoardMoved=null;this.onCaptured=null;this.ghostObject=null;this.messageBox=null}
DrawingBoard.prototype={renderIntoWorkspace:function(){var that=this;this.wrapper=this.workspace.getWrapper().createChild("div",{"id":"drawing-board"});this.svg=this.wrapper.createChildNS("svg",{"id":"drawing-svg","width":this.svgSize.width,"height":this.svgSize.height,"style":"background-color:"+Config.General.canvasBackground});this.underGroup=this.svg.createChildNS("g",{"data-label":"Group of Frame"});this.shapeGroup=this.svg.createChildNS("g",{"data-label":"Group of Shapes"});this.upperGroup=
this.svg.createChildNS("g",{"data-label":"Group of Misc"});this.canvasFrame=new CanvasFrame(this.underGroup);var svgEvent=workspace.getEventManager(this.wrapper);svgEvent.addListener("capture",function(e,args){that.processCapture(e,args)});svgEvent.addListener("release",function(e,args){that.processRelease(e,args)});svgEvent.addListener("drag",function(e,args){that.processDrag(e,args)})},processCapture:function(e,args){var a=document.elementFromPoint(e.pageX,e.pageY);var selectingShape=workspace.painting.selectingShape;
var selectedShape=workspace.painting.selectedShape;if(workspace.painting.toolType==ToolTypes.Picker)if(selectingShape!=null){if(selectingShape!=selectedShape)workspace.painting.selectShape(selectingShape);workspace.painting.selectingShape=null}else workspace.painting.selectShape(null);if(workspace.painting.toolType==ToolTypes.Pen){var point=this.transformPoint({x:args.current.x,y:args.current.y});if(selectingShape!=null&&selectedShape!=selectingShape){workspace.painting.selectShape(selectingShape);
workspace.painting.selectingShape=null;selectingShape.switchPathEditing(true)}else if(selectedShape!=null&&selectedShape.isPathShape()){var selectingPoint=selectedShape.selectingPoint;var selectedPoint=selectedShape.selectedPoint;if(selectingPoint!=null){if(selectingPoint.selected)if(selectingPoint.selectingCtrl!=null)selectingPoint.selectingCtrl=null;else selectedShape.selectPoint(null);else selectedShape.selectPoint(selectingPoint);selectedShape.selectingPoint=null}else{var dx=point.x-selectedShape.getOffset().x;
var dy=point.y-selectedShape.getOffset().y;var orgPoint=selectedShape.transFrame.getOriginalPoint(dx,dy);var newAnchor=null;if(selectedShape.selectedPoint==null);else if(selectedShape.selectedPoint.isLast()||selectedShape.anchorPoints.length<2)newAnchor=selectedShape.addAndRenderPoint(orgPoint.x,orgPoint.y,true);else newAnchor=selectedShape.insertAndRenderPoint(orgPoint.x,orgPoint.y,selectedShape.selectedPoint);selectedShape.selectPoint(newAnchor)}}else{var transformInfo={position:{x:point.x,y:point.y},
boundary:{left:0,top:0,right:0,bottom:0},rotation:{cx:0,cy:0,angle:0}};var path=workspace.painting.createShape(ShapeTypes.Polyline,this.shapeGroup,transformInfo);path.selectLastPoint()}}if(typeof this.onCaptured=="function")this.onCaptured()},processRelease:function(e,args){if(workspace.painting.toolType==ToolTypes.Picker);else if(workspace.painting.toolType==ToolTypes.Pen){var selectedShape=workspace.painting.selectedShape;if(selectedShape!=null){var selectedPoint=selectedShape.selectedPoint;if(selectedPoint!=
null){var ctrl=selectedPoint.bezierLastCtrl;if(ctrl!=null&&ctrl.captured)ctrl.setCaptured(false)}}}else{workspace.painting.selectShape(null);if(!Config.General.lockTool&&workspace.painting.isShapeTool())workspace.painting.selectTool(ToolTypes.Picker)}this.workspace.scaleplate.moveIndicator(-1,-1)},processDrag:function(e,args){var currentPoint=this.transformPoint(args.current);var selectedShape=workspace.painting.selectedShape;if(selectedShape==null){var transformInfo={position:this.transformPoint(args.begin),
boundary:{left:0,top:0,right:0,bottom:0},rotation:{cx:0,cy:0,angle:0}};switch(workspace.painting.toolType){case ToolTypes.Picker:break;case ToolTypes.Move:this.moveBoard(args.previous.dx,args.previous.dy);break;case ToolTypes.Line:workspace.painting.createShape(ShapeTypes.Line,this.shapeGroup,transformInfo);break;case ToolTypes.Rectangle:workspace.painting.createShape(ShapeTypes.Rectangle,this.shapeGroup,transformInfo);break;case ToolTypes.Ellipse:workspace.painting.createShape(ShapeTypes.Ellipse,
this.shapeGroup,transformInfo);break;case ToolTypes.Polygon:workspace.painting.createShape(ShapeTypes.Polygon,this.shapeGroup,transformInfo);break;case ToolTypes.Pencil:workspace.painting.createShape(ShapeTypes.Freeline,this.shapeGroup,transformInfo);break;case ToolTypes.Label:workspace.painting.createShape(ShapeTypes.Label,this.shapeGroup,transformInfo);break}}else switch(workspace.painting.toolType){case ToolTypes.Picker:break;case ToolTypes.Line:case ToolTypes.Rectangle:case ToolTypes.Ellipse:case ToolTypes.Polygon:case ToolTypes.Label:selectedShape.resize(args.begin.dx,
args.begin.dy);break;case ToolTypes.Pencil:selectedShape.addAndRenderPoint(args.begin.dx,args.begin.dy,true);break;case ToolTypes.Pen:if(args.previous.dx!=0||args.previous.dy!=0)if(selectedShape.isPathShape()&&selectedShape.selectedPoint!=null){var frame=selectedShape.transFrame;var mappedOffset=frame.getMappedOffset(args.begin,args.current);selectedShape.selectedPoint.prepareBezierCtrl(mappedOffset)}break}this.workspace.scaleplate.moveIndicator(currentPoint.x,currentPoint.y)},applyViewBox:function(){var viewBox=
"{0} {1} {2} {3}".format(-this.svgOffset.x,-this.svgOffset.y,this.svgSize.width,this.svgSize.height);this.svg.setAttribute("viewBox",viewBox)},moveBoard:function(dx,dy){this.svgOffset.x+=dx;this.svgOffset.y+=dy;this.applyViewBox();if(typeof this.onBoardMoved=="function")this.onBoardMoved(this.svgOffset.x,this.svgOffset.y)},reset:function(){this.svgOffset.x=0;this.svgOffset.y=0;this.applyViewBox();this.canvasFrame.reset(this.svgSize.width,this.svgSize.height)},resize:function(width,height){this.wrapper.updateStyle("width",
width+"px");this.wrapper.updateStyle("height",height+"px");this.svgSize.width=width;this.svgSize.height=height;this.svg.setAttribute("width",this.svgSize.width);this.svg.setAttribute("height",this.svgSize.height);this.applyViewBox();this.canvasFrame.resize(width,height)},transformPoint:function(point){return{x:point.x-this.wrapper.offsetLeft-this.svgOffset.x,y:point.y-this.wrapper.offsetTop-this.svgOffset.y}},showGhost:function(d){if(this.ghostObject==null)this.ghostObject=this.upperGroup.createChildNS("path",
{"d":d,"fill":"RGBA(0,0,0,0.5)","stroke-width":1,"stroke":"RGBA(0,0,0,1)"});else this.ghostObject.setAttribute("d",d)},showMessage:function(msg){var that=this;if(this.messageBox!=null)this.hideMessage();var msgArray=[];if(getType(msg)=="Array")msgArray=msg;else msgArray.push(msg);var margin=50;var fontSize=14;var lineHeight=fontSize*1.5;var point={x:margin,y:this.svgSize.height-margin-lineHeight*(msgArray.length-1)};this.messageBox=this.workspace.drawingBoard.upperGroup.createChildNS("g",{"class":"no-select"});
for(var i=0;i<msgArray.length;i++)this.messageBox.createChildNS("text",{"x":point.x,"y":point.y+i*lineHeight,"fill":"#333333","font-size":fontSize+"px"},msgArray[i]);setTimeout(function(){that.hideMessage()},1E4)},hideMessage:function(){if(this.messageBox==null)return;this.messageBox.parentNode.removeChild(this.messageBox);this.messageBox=null}};
function ObjectManager(workspace){this.workspace=workspace;this.wrapper=null;this.left=0;this.top=0;this.showing=Config.General.showObjectManager;this.selectedShapes=[];this.objectListContainer=null;this.objectListDoms=[];this.summaryLabel=null}
ObjectManager.prototype={renderIntoWorkspace:function(){var that=this;this.wrapper=this.workspace.getWrapper().createChild("div",{"id":"object-manager","class":"floating-panel","style":"width: {0}px; display: {1}".format(Config.ObjectManager.width,this.showing?"block":"none")});var titleBar=this.wrapper.createChild("div",{"class":"title-Bar no-select"});workspace.getEventManager(titleBar).addListener("drag",function(e,args){that.moveWindow(args.previous.dx,args.previous.dy)});this.summaryLabel=titleBar.createChild("div",
{"class":"dragable"},"Objects");this.objectListContainer=this.wrapper.createChild("div",{"class":"list"});this.updateSummary()},moveWindow:function(dx,dy){if(dx!=null&&dy!=null){this.left+=dx;this.top+=dy}this.wrapper.updateStyle("left",this.left+"px");this.wrapper.updateStyle("top",this.top+"px")},moveWindowTo:function(left,top){this.left=left;this.top=top;this.moveWindow()},insertItem:function(shape){var that=this;var dom=this.objectListContainer.createChild("div",{"class":"item","data-id":shape.id},
"",true);this.objectListDoms.push(dom);if(this.isIdSelected(shape.id))dom.addClassName("selected");var titleDom=dom.createChild("div",{"class":"item-title"},shape.toString(false),"",false);titleDom.addEventListener("click",function(e){var id=this.parentNode.getAttribute("data-id");that.workspace.selectShapeById(id)})},updateList:function(){while(this.objectListDoms.length>0){var dom=this.objectListDoms.pop();this.objectListContainer.removeChild(dom)}var shapes=this.workspace.painting.shapes;for(var i=
0;i<shapes.length;i++){var shape=shapes[i];this.insertItem(shape)}},updateSummary:function(){var shapes=this.workspace.painting.shapes;this.summaryLabel.textContent="Objects Number: "+shapes.length},isIdSelected:function(id){for(var i=0;i<this.selectedShapes.length;i++)if(this.selectedShapes[i].id==id)return true;return false},appendShape:function(shape){if(!this.showing)return;this.insertItem(shape);this.updateSummary()},removeShape:function(shape,index){if(!this.showing)return;this.objectListContainer.removeChild(this.objectListDoms[index]);
this.objectListDoms.splice(index,1);this.updateSummary()},sortShape:function(shape,oldIndex,newIndex){if(!this.showing)return;this.updateList()},selectShapes:function(shapes){this.selectedShapes=shapes;if(!this.showing)return;for(var i=0;i<this.objectListDoms.length;i++){var dom=this.objectListDoms[i];var id=dom.getAttribute("data-id");if(this.isIdSelected(id)){if(!dom.hasClassName("selected"))dom.addClassName("selected")}else if(dom.hasClassName("selected"))dom.removeClassName("selected")}},show:function(show){this.showing=
show;this.updateList();this.updateSummary();if(show)this.wrapper.updateStyle("display","block");else this.wrapper.updateStyle("display","none")}};function PromptDialog(workspace){this.workspace=workspace;this.wrapper=null;this.dlgBox=null;this.textBox=null;this.button=null}
PromptDialog.prototype={renderIntoWorkspace:function(){var that=this;this.wrapper=this.workspace.getWrapper().createChild("div",{"id":"prompt-wrapper","style":"display:none"});this.dlgBox=this.wrapper.createChild("div",{"class":"prompt-dlg"});this.textBox=this.dlgBox.createChild("input",{"type":"text","class":"text"});this.button=this.dlgBox.createChild("input",{"type":"button","class":"button","value":"OK"});this.button.addEventListener("click",function(){that.setShowing(false)},false)},selectAll:function(){this.textBox.focus();
this.textBox.select()},setShowing:function(show){this.wrapper.updateStyle("display",show?null:"none")},setText:function(text){this.textBox.value=text},setEnabled:function(enabled){if(enabled){this.textBox.removeAttribute("readonly");this.button.removeAttribute("disabled")}else{this.textBox.setAttribute("readonly","readonly");this.button.setAttribute("disabled","disabled")}},resize:function(width,height){this.wrapper.updateStyle("width",width+"px");this.wrapper.updateStyle("height",height+"px");this.dlgBox.updateStyle("margin-top",
height/2-50+"px")}};function TextPanel(workspace){this.workspace=workspace;this.wrapper=null;this.contetArea=null;this.buttonArea=null;this.titleBar=null;this.textArea=null}
TextPanel.prototype={renderIntoWorkspace:function(){var that=this;this.wrapper=this.workspace.getWrapper().createChild("div",{"id":"text-panel","style":"display: none; left: 0px; top: 0px; width: 0px; height: 0px"});this.contetArea=this.wrapper.createChild("div",{"class":"content-area"});this.titleBar=this.contetArea.createChild("div",{"class":"title-bar"});var buttons=this.titleBar.createChild("div",{"class":"buttons"});this.buttonArea=buttons.createChild("div",{"style":"display: inline"});var btnClose=
buttons.createChild("div",{"class":"button","title":"close"});btnClose.addEventListener("click",function(e){that.hide()});var svg=btnClose.createChildNS("svg",{"class":"top-menu-icon","width":16,"height":16});var g=svg.createChildNS("g");g.createChildNS("path",{"d":"M0 0 L{0} {0} M{0} 0 L0 {0}".format(16),"stroke":"#FE5722","stroke-width":2,"fill":"none"});this.textArea=this.contetArea.createChild("textarea",{"class":"text-area"})},clearButtons:function(){while(this.buttonArea.hasChildNodes())this.buttonArea.removeChild(this.buttonArea.firstChild)},
setText:function(text){this.textArea.value=text},show:function(){this.wrapper.updateStyle("display","block")},hide:function(){this.wrapper.updateStyle("display","none")},resize:function(width,height){var padding=this.workspace.isSmallScreen()?0:50;var titleHeight=42;var contentWidth=width-padding*2;var contentHeight=height-padding*2;this.wrapper.updateStyle("width",width+"px");this.wrapper.updateStyle("height",height+"px");this.contetArea.updateStyle("width",contentWidth+"px");this.contetArea.updateStyle("height",
contentHeight+"px");this.contetArea.updateStyle("margin","{0}px 0px 0px {0}px".format(padding));this.titleBar.updateStyle("height",titleHeight+"px");var textMargin=5;this.textArea.updateStyle("width",contentWidth-textMargin*2+"px");this.textArea.updateStyle("height",contentHeight-textMargin*2-titleHeight+"px");this.textArea.updateStyle("margin","{0}px 0px 0px {0}px".format(textMargin))}};
function Scaleplate(workspace,marginLeft,marginTop){this.workspace=workspace;this.showing=true;this.hRuler=null;this.hCanvas=null;this.hContext=null;this.vRuler=null;this.vCanvas=null;this.vContext=null;this.marginLeft=marginLeft;this.marginTop=marginTop;this.barSize=Config.Scaleplate.size;this.width=0;this.height=0;this.offset={x:0,y:0};this.indicator={x:-1,y:-1}}
Scaleplate.prototype={renderIntoWorkspace:function(){this.hRuler=this.workspace.getWrapper().createChild("div",{"id":"horizontal-ruler","class":"ruler","style":"width: 0px; height: {0}px; margin-left: {0}px".format(this.barSize)});this.hCanvas=this.hRuler.createChild("canvas",{"width":0,"height":0});this.hContext=this.hCanvas.getContext("2d");this.vRuler=this.workspace.getWrapper().createChild("div",{"id":"vertical-ruler","class":"ruler","style":"width: {0}px; height: 0px".format(this.barSize)});
this.vCanvas=this.vRuler.createChild("canvas",{"width":0,"height":0});this.vContext=this.vCanvas.getContext("2d");this.setShowing(Config.General.showScale)},resize:function(width,height){this.width=width;this.height=height;this.hRuler.updateStyle("width",width+"px");this.vRuler.updateStyle("height",height+"px");this.redraw()},setShowing:function(show){this.showing=show;this.hRuler.updateStyle("display",show?"block":"none");this.vRuler.updateStyle("display",show?"block":"none");if(show)this.redraw()},
changeOffset:function(offsetX,offsetY){this.offset.x=offsetX;this.offset.y=offsetY;this.redraw()},moveIndicator:function(x,y){this.indicator.x=x;this.indicator.y=y;this.redraw()},redraw:function(){if(!this.showing)return;this.hCanvas.width=this.width;this.hCanvas.height=this.barSize;this.vCanvas.width=this.barSize;this.vCanvas.height=this.height;var rulerUnit=10;this.hContext.save();this.hContext.font="{0}px verdana".format(10);this.hContext.textBaseline="top";this.hContext.fillStyle="#666666";this.hContext.strokeStyle=
"RGBA(0,0,0,0.2)";this.hContext.lineWidth=1;this.hContext.beginPath();for(var x=0;x<this.width;x++){var scale=x-this.offset.x;if(scale%100==0){this.hContext.antiFuzzyLine(x,0,x,this.barSize);this.hContext.fillText(scale,x+2,0)}else if(scale%10==0)this.hContext.antiFuzzyLine(x,this.barSize-4,x,this.barSize)}this.hContext.stroke();this.hContext.restore();this.vContext.save();this.vContext.font="{0}px verdana".format(10);this.vContext.textBaseline="top";this.vContext.fillStyle="#666666";this.vContext.strokeStyle=
"RGBA(0,0,0,0.2)";this.vContext.lineWidth=1;this.vContext.beginPath();for(var y=0;y<this.height;y++){var scale=y-this.offset.y;if(scale%100==0){this.vContext.antiFuzzyLine(0,y,this.barSize,y);this.vContext.fillTextWithRotate(scale,12,y+2,Math.PI/2,"left","top")}else if(scale%10==0)this.vContext.antiFuzzyLine(this.barSize-4,y,this.barSize,y)}this.vContext.stroke();this.vContext.restore();var indicatorSize=Config.Scaleplate.indicatorSize;if(this.indicator.x!=-1){var indicatorLeft=this.indicator.x+this.offset.x;
this.hContext.save();this.hContext.beginPath();this.hContext.moveTo(indicatorLeft-indicatorSize,0);this.hContext.lineTo(indicatorLeft+indicatorSize,0);this.hContext.lineTo(indicatorLeft+indicatorSize,this.barSize/2);this.hContext.lineTo(indicatorLeft,this.barSize);this.hContext.lineTo(indicatorLeft-indicatorSize,this.barSize/2);this.hContext.closePath();this.hContext.fillStyle=Config.Scaleplate.indicatorColor;this.hContext.fill();this.hContext.restore()}if(this.indicator.y!=-1){var indicatorTop=this.indicator.y+
this.offset.y;this.vContext.save();this.vContext.beginPath();this.vContext.moveTo(0,indicatorTop+indicatorSize);this.vContext.lineTo(0,indicatorTop-indicatorSize);this.vContext.lineTo(this.barSize/2,indicatorTop-indicatorSize);this.vContext.lineTo(this.barSize,indicatorTop);this.vContext.lineTo(this.barSize/2,indicatorTop+indicatorSize);this.vContext.closePath();this.vContext.fillStyle=Config.Scaleplate.indicatorColor;this.vContext.fill();this.vContext.restore()}}};
var base_shape_prototype={id:null,parent:null,renderred:null,committed:null,svgGroup:null,shapeElement:null,ghostElement:null,transFrame:null,anchorPoints:null,selectingPoint:null,selectedPoint:null,properties:null,propertyDict:null,animation:null,fps:null,fillInterval:null,fillPercentage:null,strokeInterval:null,strokePercentage:null,onCommitted:null,onStatusChanged:null,statusChanged:function(){if(typeof this.onStatusChanged=="function")this.onStatusChanged()},init:function(parent,transformInfo,
pointsInArray,initialProperties){var that=this;this.id=workspace.painting.getNextId();this.parent=parent;this.renderred=false;this.committed=false;this.svgGroup=this.parent.createChildNS("g",{"data-label":"Group of Shape","data-id":"s_"+this.id});this.shapeElemgnt=null;this.ghostElement=null;this.transFrame=new TransformableFrame(this.svgGroup,transformInfo,true);this.transFrame.addEventListener("boundarychange",function(args){that.statusChanged();if(!that.committed)return;if(that.anchorPoints.length<=
0)return;var position=that.transFrame.getPosition();var enhancedOldBoundary=QStage.enhanceBoundary(args.oldBoundary,false);var enhancedNewBoundary=QStage.enhanceBoundary(args.newBoundary,false);that.transformPointsToBoundary(null,position,enhancedOldBoundary,enhancedNewBoundary)});this.transFrame.addEventListener("positionchange",function(args){that.statusChanged()});this.transFrame.addEventListener("rotationchange",function(args){that.statusChanged()});this.anchorPoints=[];this.preparePoints(pointsInArray);
this.selectingPoint=null;this.selectedPoint=null;this.properties={};this.propertyDict=[];this.preparePropDict(initialProperties);this.fps=20;this.fillInterval=null;this.fillPercentage=null;this.strokeInterval=null;this.strokePercentage=null;this.onCommitted=null;this.onStatusChanged=null},preparePoints:function(pointsInArray){if(pointsInArray!=null)for(var i=0;i<pointsInArray.length;i++){var pointInArray=pointsInArray[i];if(pointInArray.length==4){var firstController={x:pointInArray[2],y:pointInArray[3]};
var anchor=this.addPoint(pointInArray[0],pointInArray[1],firstController)}else if(pointInArray.length==2)var anchor=this.addPoint(pointInArray[0],pointInArray[1],null)}},addPropDictItem:function(initialProperties,dictItem){var value=dictItem.value;if(initialProperties!=null)for(var i=0;i<initialProperties.length;i++){var key=initialProperties[i][0];if(key==dictItem.key){value=initialProperties[i][1];break}}this.propertyDict.push({key:dictItem.key,value:value,setter:dictItem.setter,getOptions:dictItem.getOptions})},
preparePropDict:function(initialProperties){this.addPropDictItem(initialProperties,{key:"fill",value:{color:workspace.painting.fill.color,opacity:workspace.painting.fill.opacity},setter:function(owner,value){if(owner.shapeElement.getAttribute("fill")!="none")owner.shapeElement.setAttribute("fill",QStage.brushToRgba(value))}});this.addPropDictItem(initialProperties,{key:"stroke",value:{color:workspace.painting.stroke.color,opacity:workspace.painting.stroke.opacity,width:workspace.painting.stroke.width},
setter:function(owner,value){owner.shapeElement.setAttribute("stroke",QStage.brushToRgba(value));owner.shapeElement.setAttribute("stroke-width",value.width)}});this.addPropDictItem(initialProperties,{key:"applyFill",value:true,setter:function(owner,value){owner.shapeElement.setAttribute("fill",value?QStage.brushToRgba(owner.prop("fill")):"none");if(owner.ghostElement)owner.ghostElement.setAttribute("fill",value?Config.Shape.ghostFill:"none")}});this.addPropDictItem(initialProperties,{key:"closePath",
value:false,setter:function(owner,value){owner.updatePath()}});this.addPropDictItem(initialProperties,{key:"strokeLinecap",value:"butt",setter:function(owner,value){owner.shapeElement.setAttribute("stroke-linecap",value)},getOptions:function(){var optionArray=[];optionArray.push(["butt","Butt"]);optionArray.push(["round","Round"]);optionArray.push(["square","Square"]);return optionArray}});this.addPropDictItem(initialProperties,{key:"strokeLinejoin",value:"miter",setter:function(owner,value){owner.shapeElement.setAttribute("stroke-linejoin",
value)},getOptions:function(){var optionArray=[];optionArray.push(["miter","Miter"]);optionArray.push(["round","Round"]);optionArray.push(["bevel","Bevel"]);return optionArray}});this.addPropDictItem(initialProperties,{key:"strokeAnimation",value:2,setter:function(owner,value){if(value==0)owner.stopAnimation("STROKE");else owner.playAnimation("STROKE",1)},getOptions:function(){var optionArray=[];optionArray.push(["0","None"]);for(var i=1;i<=10;i++)optionArray.push([i,"{0}s".format(i)]);return optionArray}});
this.addPropDictItem(initialProperties,{key:"fillAnimation",value:1,setter:function(owner,value){if(value==0)owner.stopAnimation("FILL");else owner.playAnimation("FILL",1)},getOptions:function(){var optionArray=[];optionArray.push(["0","None"]);for(var i=1;i<=4;i++)optionArray.push([i,"{0}s".format(i)]);return optionArray}})},renderComplete:function(){var that=this;this.shapeElement.setAttribute("stroke-linecap",this.prop("strokeLinecap"));this.shapeElement.setAttribute("stroke-linejoin",this.prop("strokeLinejoin"));
this.transFrame.render();for(var i=0;i<this.anchorPoints.length;i++){this.anchorPoints[i].render();this.anchorPoints[i].setDisplay(false)}function onCaptured(e,args){if(workspace.painting.toolType==ToolTypes.Picker)workspace.painting.selectingShape=that;else if(workspace.painting.toolType==ToolTypes.Pen&&that.isPathShape())workspace.painting.selectingShape=that}var frameEvent=workspace.getEventManager(this.transFrame.svgGroup).addListener("capture",onCaptured);var eventOwner=this.ghostElement==null?
this.shapeElement:this.ghostElement;var shapeEvent=workspace.getEventManager(eventOwner).addListener("capture",onCaptured);this.renderred=true},prop:function(key,value){var property=null;for(var i=0;i<this.propertyDict.length;i++)if(this.propertyDict[i].key==key){property=this.propertyDict[i];break}if(property==null)return;if(value==null)return property.value;else{property.value=clone(value);if(this.renderred)property.setter(this,value);this.statusChanged()}},getOptions:function(key){if(key=="GENERIC_BOOL"){var optionArray=
[];optionArray.push(["1","True"]);optionArray.push(["0","False"]);return optionArray}for(var i=0;i<this.propertyDict.length;i++)if(this.propertyDict[i].key==key)return this.propertyDict[i].getOptions();return null},playAnimation:function(animationType,loopCount){var that=this;if(animationType=="FILL"){if(!this.prop("applyFill"))return;this.fillPercentage=1;this.startInterval(animationType,function(){var fillOpacity=that.prop("fill").opacity*(1-that.fillPercentage);that.shapeElement.setAttribute("fill",
QStage.brushToRgba({color:that.prop("fill").color,opacity:fillOpacity}));if(that.fillPercentage>0)that.fillPercentage-=1/that.fps/that.prop("fillAnimation");else{that.fillPercentage=1;if(loopCount!=-1){loopCount--;if(loopCount<=0)that.stopAnimation(animationType)}}})}else if(animationType=="STROKE"){this.strokePercentage=1;this.startInterval(animationType,function(){var pathLength=that.shapeElement.getTotalLength();that.shapeElement.updateStyle("stroke-dasharray",pathLength);that.shapeElement.updateStyle("stroke-dashoffset",
pathLength*that.strokePercentage);if(that.strokePercentage>0)that.strokePercentage-=1/that.fps/that.prop("strokeAnimation");else{that.strokePercentage=1;if(loopCount!=-1){loopCount--;if(loopCount<=0)that.stopAnimation(animationType)}}})}},stopAnimation:function(animationType){if(animationType=="FILL"){if(this.prop("applyFill"))this.shapeElement.setAttribute("fill",QStage.brushToRgba(this.prop("fill")));else this.shapeElement.setAttribute("fill","none");this.stopInterval(animationType)}else if(animationType==
"STROKE"){this.shapeElement.updateStyle("stroke-dasharray",null);this.shapeElement.updateStyle("stroke-dashoffset",null);this.stopInterval(animationType)}},startInterval:function(animationType,callback){if(animationType=="FILL"){this.stopInterval("FILL");this.fillInterval=setInterval(callback,1E3/this.fps)}else if(animationType=="STROKE"){this.stopInterval("STROKE");this.strokeInterval=setInterval(callback,1E3/this.fps)}},stopInterval:function(animationType){if(animationType=="FILL"){if(this.fillInterval!=
null){clearInterval(this.fillInterval);this.fillInterval=null}}else if(animationType=="STROKE")if(this.strokeInterval!=null){clearInterval(this.strokeInterval);this.strokeInterval=null}},transformPointsToBoundary:function(points,position,enhancedOldBoundary,enhancedNewBoundary){var x=position.x;var y=position.y;var oldWidth=enhancedOldBoundary.right-enhancedOldBoundary.left;var newWidth=enhancedNewBoundary.right-enhancedNewBoundary.left;var oldHeight=enhancedOldBoundary.bottom-enhancedOldBoundary.top;
var newHeight=enhancedNewBoundary.bottom-enhancedNewBoundary.top;var widthRatio=newWidth/oldWidth;var heightRatio=newHeight/oldHeight;var oldCenter={x:enhancedOldBoundary.left+oldWidth/2,y:enhancedOldBoundary.top+oldHeight/2};var newCenter={x:(enhancedNewBoundary.left<enhancedNewBoundary.right?enhancedNewBoundary.left:enhancedNewBoundary.right)+Math.abs(newWidth/2),y:(enhancedNewBoundary.top<enhancedNewBoundary.bottom?enhancedNewBoundary.top:enhancedNewBoundary.bottom)+Math.abs(newHeight/2)};var processAnchorPoints=
points==null;if(processAnchorPoints)points=this.anchorPoints;for(var i=0;i<points.length;i++){var anchor=points[i];var x=(anchor.x-oldCenter.x)*widthRatio+newCenter.x;var y=(anchor.y-oldCenter.y)*heightRatio+newCenter.y;if(processAnchorPoints){var isLast=i==points.length-1;points[i].movePointTo(QStage.round(x),QStage.round(y),false,isLast)}else{points[i].x=QStage.round(x);points[i].y=QStage.round(y)}}},getAbsoluteInfo:function(){var position=this.transFrame.getPosition();var eBoundary=QStage.enhanceBoundary(this.transFrame.getBoundary(),
true);this.transFrame.validRotationCenter(eBoundary);var rotation=this.transFrame.getRotation();var info={left:position.x+eBoundary.left,top:position.y+eBoundary.top,width:eBoundary.width,height:eBoundary.height,cx:eBoundary.cx,cy:eBoundary.cy,rotation:rotation.angle%360};return info},resize:function(dw,dh){this.transFrame.transform(0,0,dw,dh,true)},getOffset:function(){var position=this.transFrame.getPosition();return{x:position.x,y:position.y}},addPoint:function(x,y,firstController){var that=this;
var anchor=new AnchorPoint(this,x,y,firstController);anchor.onAnchorChanged=function(calcBoundary){that.anchorsChanged(calcBoundary)};this.anchorPoints.push(anchor);return anchor},addAndRenderPoint:function(x,y,updateImmediately){var that=this;var anchor=this.addPoint(x,y,null);if(updateImmediately){this.anchorsChanged(true);var pointBoundary=this.getPointBoundary();this.transFrame.transformTo(pointBoundary.left,pointBoundary.top,pointBoundary.right,pointBoundary.bottom,false)}anchor.render();return anchor},
insertAndRenderPoint:function(x,y,insertAfter){var that=this;var anchor=new AnchorPoint(this,x,y,null);anchor.onAnchorChanged=function(reCalculateBoundary){that.anchorsChanged(reCalculateBoundary)};for(var i=0;i<this.anchorPoints.length;i++)if(this.anchorPoints[i]==insertAfter){this.anchorPoints.splice(i+1,0,anchor);break}this.anchorsChanged(true);var pointBoundary=this.getPointBoundary();this.transFrame.transformTo(pointBoundary.left,pointBoundary.top,pointBoundary.right,pointBoundary.bottom,false);
anchor.render();return anchor},selectPoint:function(anchorPoint){if(this.selectedPoint!=null)this.selectedPoint.setSelected(false);if(anchorPoint!=null)anchorPoint.setSelected(true);this.selectedPoint=anchorPoint},deletePoint:function(anchorPoint){if(this.anchorPoints.length<=2)return;if(this.selectedPoint==anchorPoint){this.selectPoint(null);this.selectingPoint=null}var index=-1;for(var i=0;i<this.anchorPoints.length;i++)if(this.anchorPoints[i]==anchorPoint){index=i;break}if(index>=0){this.anchorPoints.splice(index,
1);this.anchorsChanged(true);anchorPoint.destroy()}},selectLastPoint:function(){this.selectPoint(this.anchorPoints[this.anchorPoints.length-1])},switchPathEditing:function(editing){if(editing)this.transFrame.setEnabled(false)},updatePath:function(){this.shapeElement.setAttribute("d",this.getPathData(false));if(this.ghostElement)this.ghostElement.setAttribute("d",this.getPathData(false));this.statusChanged()},anchorsChanged:function(calcBoundary){this.updatePath();if(calcBoundary){var pointBoundary=
this.getPointBoundary();this.transFrame.transformTo(pointBoundary.left,pointBoundary.top,pointBoundary.right,pointBoundary.bottom,false)}},getPointBoundary:function(points){if(points==null)points=this.anchorPoints;var left=null;var top=null;var right=null;var bottom=null;for(var i=0;i<points.length;i++){var point=points[i];if(point.x<left||left==null)left=point.x;if(point.x>right||right==null)right=point.x;if(point.y<top||top==null)top=point.y;if(point.y>bottom||bottom==null)bottom=point.y}return{left:left,
top:top,right:right,bottom:bottom}},getPathCommand:function(pointIndex,shapePosition,exportRect){var point=pointIndex==-1?this.anchorPoints[0]:this.anchorPoints[pointIndex];var x=exportRect!=null?point.x+shapePosition.x-exportRect.left:point.x;var y=exportRect!=null?point.y+shapePosition.y-exportRect.top:point.y;var path="";if(pointIndex==0)path+="M{0} {1}".format(x,y);else{var previousCtrl=point.getPrevious().getBezierCtrl(false);var currentCtrl=point.getBezierCtrl(true);if(currentCtrl!=null)if(previousCtrl!=
null)path+=" C{0} {1}, {2} {3}, {4} {5}".format(previousCtrl.x,previousCtrl.y,currentCtrl.x,currentCtrl.y,x,y);else path+=" Q{0} {1}, {2} {3}".format(currentCtrl.x,currentCtrl.y,x,y);else if(previousCtrl!=null)path+=" Q{0} {1}, {2} {3}".format(previousCtrl.x,previousCtrl.y,x,y);else path+=" L{0} {1}".format(x,y)}return path},getPathData:function(forExport){var exportRect=forExport?workspace.getExportRect():null;var shapePosition=this.transFrame.getPosition();var path="";for(var i=0;i<this.anchorPoints.length;i++)path+=
this.getPathCommand(i,shapePosition,exportRect);if(this.prop("closePath")){path+=this.getPathCommand(-1,shapePosition,exportRect);path+=" Z"}return path},setSelected:function(selected){if(!this.committed)if(selected){if(this.getType()!=ShapeTypes.Line&&this.getType()!=ShapeTypes.Freeline&&this.getType()!=ShapeTypes.Polyline&&this.getType()!=ShapeTypes.Rectangle)this.transFrame.setEnabled(selected)}else{this.committed=true;if(typeof this.onCommitted=="function")this.onCommitted()}if(this.committed){if(this.getType()!=
ShapeTypes.Line)this.transFrame.setEnabled(selected);for(var i=0;i<this.anchorPoints.length;i++)this.anchorPoints[i].setDisplay(selected);if(!selected&&this.selectedPoint!=null){this.selectedPoint.setSelected(false);this.selectedPoint=null}}},canBringFront:function(){var index=workspace.painting.searchShape(this);if(index>=0)return index<workspace.painting.shapes.length-1;else return false},canSendBack:function(){var index=workspace.painting.searchShape(this);if(index>=0)return index>0;else return false},
remove:function(){this.svgGroup.parentNode.removeChild(this.svgGroup);this.svgGroup=null;this.stopInterval();workspace.painting.selectShape(null);workspace.painting.removeShape(this)},bringToFront:function(){if(this.svgGroup.parentNode.childNodes.length>1)this.svgGroup.parentNode.appendChild(this.svgGroup);workspace.painting.changeShapePosition(this,workspace.painting.shapes.length-1)},sendToBack:function(){if(this.svgGroup.parentNode.childNodes.length>1)this.svgGroup.parentNode.insertBefore(this.svgGroup,
this.svgGroup.parentNode.firstChild);workspace.painting.changeShapePosition(this,0)},toString:function(typeOnly){var typeName="Unknown";switch(this.getType()){case ShapeTypes.Line:typeName="Line";break;case ShapeTypes.Rectangle:typeName="Rectangle";break;case ShapeTypes.Ellipse:typeName="Ellipse";break;case ShapeTypes.Polygon:typeName="Polygon";break;case ShapeTypes.Polyline:typeName="Polyline";break;case ShapeTypes.Freeline:typeName="Freeline";break;case ShapeTypes.Label:typeName="Label";break}if(typeOnly)return typeName;
else return"{0} [#{1}]".format(typeName,this.id)},toJsonObject:function(){var o={id:this.id,type:this.getType(),position:this.transFrame.getPosition(),boundary:this.transFrame.getBoundary(),rotation:this.transFrame.getRotation(),points:[],properties:[]};for(var i=0;i<this.anchorPoints.length;i++){var point=this.anchorPoints[i];var controller=point.bezierFirstCtrl;if(controller==null)o.points.push([point.x,point.y]);else o.points.push([point.x,point.y,controller.x,controller.y])}for(var i=0;i<this.propertyDict.length;i++){var property=
this.propertyDict[i];o.properties.push([property.key,property.value])}return o},isPathShape:function(){return this.getType()==ShapeTypes.Polyline||this.getType()==ShapeTypes.Polygon}};var BaseShape=Class.extend(base_shape_prototype);
BaseShape.fromJsonObject=function(o){var shape=null;var container=workspace.drawingBoard.shapeGroup;var id=o.id;var type=o.type;var points=o.points;var properties=o.properties;var position=o.position;var boundary=o.boundary;var rotation=o.rotation;var transformInfo={position:o.position,boundary:o.boundary,rotation:o.rotation};switch(type){case ShapeTypes.Line:shape=new Line(container,transformInfo,points,properties);break;case ShapeTypes.Rectangle:shape=new Rectangle(container,transformInfo,points,
properties);break;case ShapeTypes.Ellipse:shape=new Ellipse(container,transformInfo,points,properties);break;case ShapeTypes.Polygon:shape=new Polygon(container,transformInfo,points,properties);break;case ShapeTypes.Polyline:shape=new Polyline(container,transformInfo,points,properties);break;case ShapeTypes.Freeline:shape=new Freeline(container,transformInfo,points,properties);break;case ShapeTypes.Label:shape=new Label(container,transformInfo,points,properties);break;default:break}shape.committed=
true;return shape};
var ellipse_prototpye={getType:function(){return ShapeTypes.Ellipse},init:function(parent,transformInfo,pointsInArray,initialProperties){var that=this;this._super(parent,transformInfo,pointsInArray,initialProperties);this.render();this.transFrame.addEventListener("boundarychange",function(args){that.shapeElement.setAttribute("d",that.getPath())})},getPath:function(){var boundary=QStage.enhanceBoundary(this.transFrame.getBoundary(),true);var cx=boundary.cx;var cy=boundary.cy;var rx=boundary.rx;var ry=
boundary.ry;var ox=.5*rx;var oy=.6*ry;var d="";d+=QStage.buildPathCommand("M",[0+cx,ry+cy]);d+=QStage.buildPathCommand("C",[ox+cx,ry+cy,rx+cx,oy+cy,rx+cx,0+cy]);d+=QStage.buildPathCommand("C",[rx+cx,-oy+cy,ox+cx,-ry+cy,0+cx,-ry+cy]);d+=QStage.buildPathCommand("C",[-ox+cx,-ry+cy,-rx+cx,-oy+cy,-rx+cx,0+cy]);d+=QStage.buildPathCommand("C",[-rx+cx,oy+cy,-ox+cx,ry+cy,0+cx,ry+cy]);d+=QStage.buildPathCommand("Z");return d},render:function(){var that=this;this.shapeElement=this.svgGroup.createChildNS("path",
{"data-label":"Shape","fill":QStage.brushToRgba(this.prop("fill")),"stroke":QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width,"d":this.getPath()});this.renderComplete()}};var Ellipse=BaseShape.extend(ellipse_prototpye);
var freeline_prototype={getType:function(){return ShapeTypes.Freeline},init:function(parent,transformInfo,pointsInArray,initialProperties){var that=this;this._super(parent,transformInfo,pointsInArray,initialProperties);this.prop("applyFill",false);if(pointsInArray==null){this.addPoint(transformInfo.boundary.left,transformInfo.boundary.top,null);this.addPoint(transformInfo.boundary.right,transformInfo.boundary.bottom,null)}this.render()},render:function(){var that=this;this.shapeElement=this.svgGroup.createChildNS("path",
{"data-label":"Shape","d":this.getPathData(false),"fill":this.prop("applyFill")?QStage.brushToRgba(this.prop("fill")):"none","stroke":QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width});this.ghostElement=this.svgGroup.createChildNS("path",{"data-label":"Ghost","d":this.getPathData(false),"fill":this.prop("applyFill")?Config.Shape.ghostFill:"none","stroke":Config.Shape.ghostStroke,"stroke-width":Config.Shape.ghostWidth});this.renderComplete()}};var Freeline=BaseShape.extend(freeline_prototype);
var label_prototype={getType:function(){return ShapeTypes.Label},init:function(parent,transformInfo,pointsInArray,initialProperties){var that=this;this._super(parent,transformInfo,pointsInArray,initialProperties);this.prepareExtPropDict(initialProperties);this.render();this.transFrame.addEventListener("boundarychange",function(args){var boundary=QStage.enhanceBoundary(args.newBoundary,true);that.shapeElement.setAttribute("x",boundary.left);that.shapeElement.setAttribute("y",boundary.bottom);that.shapeElement.setAttribute("font-size",
boundary.height);that.shapeElement.setAttribute("textLength",boundary.width)})},prepareExtPropDict:function(initialProperties){this.addPropDictItem(initialProperties,{key:"text",value:"ABC",setter:function(owner,value){owner.shapeElement.textContent=value}});this.addPropDictItem(initialProperties,{key:"lengthAdjust",value:"spacingAndGlyphs",setter:function(owner,value){owner.shapeElement.setAttribute("lengthAdjust",value)},getOptions:function(){var optionArray=[];optionArray.push(["spacing","Spacing"]);
optionArray.push(["spacingAndGlyphs","SpacingAndGlyphs"]);return optionArray}})},render:function(){var boundary=QStage.enhanceBoundary(this.transFrame.getBoundary(),true);this.shapeElement=this.svgGroup.createChildNS("text",{"data-label":"Label","fill":QStage.brushToRgba(this.prop("fill")),"class":"no-select","x":boundary.left,"y":boundary.bottom,"font-size":boundary.height,"textLength":boundary.width,"lengthAdjust":this.prop("lengthAdjust")},this.prop("text"));this.renderComplete()}};var Label=BaseShape.extend(label_prototype);
var line_prototype={getType:function(){return ShapeTypes.Line},init:function(parent,transformInfo,pointsInArray,initialProperties){var that=this;this._super(parent,transformInfo,pointsInArray,initialProperties);if(pointsInArray==null){this.addPoint(transformInfo.boundary.left,transformInfo.boundary.top,null);this.addPoint(transformInfo.boundary.right,transformInfo.boundary.bottom,null)}this.render();this.transFrame.addEventListener("boundarychange",function(args){if(that.committed)return;var boundary=
that.transFrame.getBoundary();that.anchorPoints[0].movePointTo(boundary.left,boundary.top,false,false);that.anchorPoints[1].movePointTo(boundary.right,boundary.bottom,false,true)})},render:function(){var that=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape","d":this.getPathData(false),"fill":"none","stroke":QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width});this.ghostElement=this.svgGroup.createChildNS("path",{"data-label":"Ghost","d":this.getPathData(false),
"fill":"none","stroke":Config.Shape.ghostStroke,"stroke-width":Config.Shape.ghostWidth});var shapeEvent=workspace.getEventManager(this.ghostElement).addListener("capture",function(e,args){if(workspace.painting.toolType==ToolTypes.Picker)that.transFrame.saveStatus()}).addListener("drag",function(e,args){if(workspace.painting.toolType==ToolTypes.Picker)that.transFrame.move(args.begin.dx,args.begin.dy)});this.renderComplete();this.transFrame.setProperty("nilWidthAccepted",true);this.transFrame.setProperty("nilHeightAccepted",
true)}};var Line=BaseShape.extend(line_prototype);
var polygon_prototype={getType:function(){return ShapeTypes.Polygon},init:function(parent,transformInfo,pointsInArray,initialProperties){var that=this;this._super(parent,transformInfo,pointsInArray,initialProperties);this.prepareExtPropDict(initialProperties);this.prop("closePath",true);if(pointsInArray==null){this.addPoint(0,0,null);this.addPoint(0,0,null);this.addPoint(0,0,null);this.addPoint(0,0,null);this.addPoint(0,0,null)}this.render();this.transFrame.addEventListener("boundarychange",function(args){if(that.committed)return;
that.alignPointsToBoundary(args.newBoundary)})},prepareExtPropDict:function(initialProperties){this.addPropDictItem(initialProperties,{key:"vertexNumber",value:5,setter:function(owner,value){owner.setVertexNumber(value)},getOptions:function(){var optionArray=[];for(var i=3;i<=20;i++)optionArray.push([i,i]);return optionArray}})},setVertexNumber:function(number){if(this.anchorPoints.length==number)return;var count=Math.abs(number-this.anchorPoints.length);for(var i=0;i<count;i++)if(this.anchorPoints.length<
number)this.addAndRenderPoint(0,0,false);else{var point=this.anchorPoints.pop();point.svgGroup.parentNode.removeChild(point.svgGroup);point=null;delete point}this.alignPointsToBoundary(this.transFrame.getBoundary())},render:function(){var that=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape","d":this.getPathData(false),"fill":QStage.brushToRgba(this.prop("fill")),"stroke":QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width});this.renderComplete()},
alignPointsToBoundary:function(boundary){var enhancedNewBoundary=QStage.enhanceBoundary(boundary,false);var points=this.getPointsOnBoundary(enhancedNewBoundary,this.anchorPoints.length);for(var i=0;i<points.length;i++){var isLast=i==points.length-1;var point=points[i];this.anchorPoints[i].movePointTo(point.x,point.y,false,isLast)}},getPointOnCircle:function(x0,y0,rx,ry,vertexNumber,pointIndex){var unitAngle=2*Math.PI/vertexNumber;var baseAngle=-90/180*Math.PI;var radian=unitAngle*pointIndex+baseAngle;
var x=x0+rx*Math.cos(radian);var y=y0+ry*Math.sin(radian);return{x:x,y:y}},getPointsOnBoundary:function(enhancedBoundary,vertexNumber){var points=[];for(var i=0;i<vertexNumber;i++){var cx=enhancedBoundary.cx;var cy=enhancedBoundary.cy;var rx=enhancedBoundary.rx;var ry=enhancedBoundary.ry;points.push(this.getPointOnCircle(cx,cy,rx,ry,vertexNumber,i))}var enhancedPointBoundary=QStage.enhanceBoundary(this.getPointBoundary(points));this.transformPointsToBoundary(points,this.transFrame.getPosition(),enhancedPointBoundary,
enhancedBoundary);return points}};var Polygon=BaseShape.extend(polygon_prototype);
var polyline_prototype={getType:function(){return ShapeTypes.Polyline},init:function(parent,transformInfo,pointsInArray,initialProperties){var that=this;this._super(parent,transformInfo,pointsInArray,initialProperties);if(initialProperties==null)this.prop("applyFill",false);this.render()},render:function(){var that=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape","d":this.getPathData(false),"fill":this.prop("applyFill")?QStage.brushToRgba(this.prop("fill")):"none","stroke":QStage.brushToRgba(this.prop("stroke")),
"stroke-width":this.prop("stroke").width});this.ghostElement=this.svgGroup.createChildNS("path",{"data-label":"Ghost","d":this.getPathData(false),"fill":this.prop("applyFill")?Config.Shape.ghostFill:"none","stroke":Config.Shape.ghostStroke,"stroke-width":Config.Shape.ghostWidth});this.renderComplete();if(this.anchorPoints.length<=0)this.addAndRenderPoint(0,0,false)}};var Polyline=BaseShape.extend(polyline_prototype);
var rectangle_prototype={getType:function(){return ShapeTypes.Rectangle},init:function(parent,transformInfo,pointsInArray,initialProperties){var that=this;this._super(parent,transformInfo,pointsInArray,initialProperties);this.render();this.transFrame.addEventListener("boundarychange",function(args){that.shapeElement.setAttribute("d",that.getPath())})},getPath:function(){var boundary=QStage.enhanceBoundary(this.transFrame.getBoundary(),true);var d="";d+=QStage.buildPathCommand("M",[boundary.left,boundary.top]);
d+=QStage.buildPathCommand("H",[boundary.right]);d+=QStage.buildPathCommand("V",[boundary.bottom]);d+=QStage.buildPathCommand("H",[boundary.left]);d+=QStage.buildPathCommand("Z");return d},render:function(){var that=this;this.shapeElement=this.svgGroup.createChildNS("path",{"data-label":"Shape","fill":QStage.brushToRgba(this.prop("fill")),"stroke":QStage.brushToRgba(this.prop("stroke")),"stroke-width":this.prop("stroke").width,"d":this.getPath()});this.renderComplete()}};var Rectangle=BaseShape.extend(rectangle_prototype);
function StartPage(workspace){this.workspace=workspace;this.wrapper=null;this.width=0;this.height=0}
StartPage.prototype={renderInto:function(wrapper,width,height){var that=this;this.wrapper=wrapper;this.resize(width,height);var css3support=QStage.supportsTransitions();this.wrapper.style[css3support.prefixedProperty]="left 0.5s ease-in";this.wrapper.addEventListener(css3support.prefixedEventName,function(){});var title=this.wrapper.createChild("div",{class:"title"});var appIcon=title.createChild("div",{id:"app-icon"});this.renderAppIcon(appIcon);var appName=title.createChild("div",{id:"app-name"},
"QLike Stage");var menuWrapper=this.wrapper.createChild("div",{class:"menu"});this.renderMenuItem(menuWrapper,0);if(!Config.General.offlineMode)this.renderMenuItem(menuWrapper,1);this.renderMenuItem(menuWrapper,2);this.renderMenuItem(menuWrapper,3);this.wrapper.createChild("div",{class:"footer"},"By QLike.com");return this.wrapper},resize:function(width,height){this.width=width;this.height=height;this.wrapper.updateStyle("width",width+"px");this.wrapper.updateStyle("height",height+"px")},setDisplay:function(display){this.wrapper.updateStyle("left",
display?"0px":"-{0}px".format(this.width));this.workspace.stageWrapper.updateStyle("left",display?"{0}px".format(this.width):"0px");if(display){var selected=document.querySelectorAll(".item-selected");for(var i=0;i<selected.length;i++)selected[i].removeClassName("item-selected")}},openProject:function(id){var that=this;if(id&&id.length>0){this.workspace.reset();QStage.setUrlHash("id",id);this.workspace.loadProject(id,function(loaded){that.setDisplay(false)})}else{var newId=QStage.generateNewProjectId();
QStage.setUrlHash("id",newId);this.workspace.reset(true);this.setDisplay(false)}},renderMenuItem:function(wrapper,subId){var that=this;var label="";var subLabel="";switch(subId){case 0:label="New";subLabel="New Project";break;case 1:label="Retrieve";subLabel="Retrieve from Server";break;case 2:label="Upload";subLabel="Upload Project File";break;case 3:label="Recent";subLabel=Config.General.offlineMode===true?"Recent Projects":"Recent Projects on Server";break}var item=wrapper.createChild("div",{class:"item",
"data-id":subId});var title=item.createChild("div",{class:"label no-select"},label);title.addEventListener("click",function(){var item=this.parentNode;var items=item.parentNode.childNodes;for(var i=0;i<items.length;i++){if(items[i].nodeType!=1)continue;if(items[i].hasClassName("item-selected"))items[i].removeClassName("item-selected");else if(items[i]==item)items[i].addClassName("item-selected")}if(item.getAttribute("data-id")=="3")that.refreshProjectList()},false);var sub=item.createChild("div",
{class:"sub"});sub.createChild("div",{class:"sub-label"},subLabel);var subContent=sub.createChild("div",{class:"sub-content"});switch(subId){case 0:var line=subContent.createChild("div",{class:"sub-item"});line.createChild("div",{class:"link"},"Create a new project from scratch").addEventListener("click",function(){var id=QStage.generateNewProjectId();that.openProject(id)},false);break;case 1:var line=subContent.createChild("div",{class:"sub-item"});var form=line.createChild("form",{action:QStage.getAppUrl()});
var txtId=form.createChild("input",{type:"text",class:"text",placeholder:"Project ID",name:"id"});var btnGo=form.createChild("input",{type:"button",class:"button",value:"Retrieve"});btnGo.addEventListener("click",function(){if(QStage.isValidId(txtId.value))that.openProject(txtId.value)},false);break;case 2:if(Config.General.offlineMode===true){var line=subContent.createChild("div",{class:"sub-item"});var fileInput=line.createChild("input",{type:"file",class:"file",id:"fileToUpload",accept:".json"});
var handleFileUpload=function(){var file=fileInput.files[0];if(!file)return;var reader=new FileReader;reader.onload=function(e){try{var fileContent=e.target.result;var jsonObj=null;var projectId=null;try{jsonObj=JSON.parse(fileContent);var filename=file.name;var match=filename.match(/project_([^.]+)\.json/);if(match&&QStage.isValidId(match[1]))projectId=match[1];else projectId=QStage.generateNewProjectId()}catch(jsonError){fileContent=fileContent.replace(/^\xEF\xBB\xBF/,"");if(fileContent.length>=
32){projectId=fileContent.substring(0,32);var base64Payload=fileContent.substring(32);try{var decodedPayload=atob(base64Payload);jsonObj=JSON.parse(decodedPayload)}catch(decodeError){throw new Error("Failed to decode file. Invalid format.");}}else throw new Error("File format is invalid. File is too short.");}if(jsonObj&&projectId){that.workspace.reset();QStage.setUrlHash("id",projectId);QCache.setProject(projectId,jsonObj);that.workspace.painting.deserialize(jsonObj,"JSON");that.setDisplay(false);
fileInput.value=""}else throw new Error("Failed to parse project data.");}catch(error){alert("Error uploading file: "+error.message);fileInput.value=""}};reader.onerror=function(){alert("Error reading file.");fileInput.value=""};reader.readAsText(file)};fileInput.addEventListener("change",handleFileUpload,false)}else{var line=subContent.createChild("form",{class:"sub-item",action:"http://stage.qlike.com/repository/upload.php",method:"post",enctype:"multipart/form-data"});line.createChild("input",
{type:"file",class:"file",name:"fileToUpload",id:"fileToUpload",placeholder:"Project ID"});line.createChild("input",{type:"submit",class:"button",value:"Upload",name:"submit"})}break;case 3:var line=subContent.createChild("div",{id:"project-list"});break}},refreshProjectList:function(){var that=this;var subContent=QStage.$("project-list");while(subContent.childNodes.length>0)subContent.removeChild(subContent.firstChild);subContent.createChild("div",{class:"sub-item"},"Loading the list...");if(Config.General.offlineMode===
true)try{var projectIds=QCache.getAllProjectIds();projectIds.sort(function(a,b){return b.localeCompare(a)});while(subContent.childNodes.length>0)subContent.removeChild(subContent.firstChild);for(var i=0;i<projectIds.length;i++){var projectId=projectIds[i];var line=subContent.createChild("div",{class:"sub-item",style:"display: flex; align-items: center; justify-content: space-between;"});var linkDiv=line.createChild("div",{class:"link",title:projectId,"data-id":projectId,style:"flex: 1;"});linkDiv.textContent=
projectId;linkDiv.addEventListener("click",function(){that.openProject(this.getAttribute("data-id"))},false);var deleteBtn=line.createChild("button",{class:"button",style:"margin-left: 10px; padding: 4px 8px; font-size: 12px;","data-id":projectId});deleteBtn.textContent="Delete";deleteBtn.addEventListener("click",function(e){e.stopPropagation();var idToDelete=this.getAttribute("data-id");if(confirm("Are you sure you want to delete project: "+idToDelete+"?"))if(QCache.deleteProject(idToDelete))that.refreshProjectList();
else alert("Failed to delete project.")},false)}if(projectIds.length<=0)subContent.createChild("div",{class:"sub-item"},"No record")}catch(err){console.log(err);while(subContent.childNodes.length>0)subContent.removeChild(subContent.firstChild);subContent.createChild("div",{class:"sub-item"},"Error loading project list")}else{var url="http://stage.qlike.com/repository/?action=pull";QStage.sendPostRequest(url,null,function(responseText){try{while(subContent.childNodes.length>0)subContent.removeChild(subContent.firstChild);
var obj=JSON.parse(responseText);for(var i=0;i<obj.payload.length;i++){var line=subContent.createChild("div",{class:"sub-item"});line.createChild("div",{class:"link",title:obj.payload[i].id,"data-id":obj.payload[i].id},obj.payload[i].id).addEventListener("click",function(){that.openProject(this.getAttribute("data-id"))},false)}if(obj.payload.length<=0)subContent.createChild("div",{class:"sub-item"},"No record")}catch(err$0){console.log(err$0)}},function(errorCode){console.log(errorCode)})}},renderAppIcon:function(wrapper){var icon=
wrapper.createChildNS("svg",{width:32,height:32});var g=icon.createChildNS("g");var size=32;var padding=size*10/300;var path="M{0},{1} H{2} L {3},{4} H {0} Z".format(size/3+padding,padding,size*2/3,size-padding,size/3-padding);g.createChildNS("path",{fill:"#22CB20",stroke:"#22CB20","stroke-width":padding,"stroke-linejoin":"round",d:path});g.createChildNS("path",{fill:"#06ACD4",stroke:"#06ACD4","stroke-width":padding,"stroke-linejoin":"round",d:path,transform:"translate(0,0), rotate({1},{0},{0})".format(size/
2,1*90)});g.createChildNS("path",{fill:"#FFCC00",stroke:"#FFCC00","stroke-width":padding,"stroke-linejoin":"round",d:path,transform:"translate(0,0), rotate({1},{0},{0})".format(size/2,2*90)});g.createChildNS("path",{fill:"#FA5151",stroke:"#FA5151","stroke-width":padding,"stroke-linejoin":"round",d:path,transform:"translate(0,0), rotate({1},{0},{0})".format(size/2,3*90)});return icon}};
var transformable_frame_prototype={svgParent:null,position:null,boundary:null,rotation:null,renderred:null,enabled:null,savedStatus:null,properties:null,moveParent:null,handleCount:null,svgGroup:null,borderElement:null,handleElements:null,handleGhosts:null,eventHandlers:null,init:function(svgParent,transformInfo,moveParent){this.svgParent=svgParent;this.position={x:QStage.alignToGrid(transformInfo.position.x),y:QStage.alignToGrid(transformInfo.position.y)};this.boundary={left:QStage.alignToGrid(transformInfo.boundary.left),
top:QStage.alignToGrid(transformInfo.boundary.top),right:QStage.alignToGrid(transformInfo.boundary.right),bottom:QStage.alignToGrid(transformInfo.boundary.bottom)};this.rotation={cx:transformInfo.rotation.cx,cy:transformInfo.rotation.cy,angle:QStage.alignToGrid(transformInfo.rotation.angle)};this.moveParent=moveParent;this.renderred=false;this.enabled=false;this.savedStatus={position:clone(this.position),boundary:clone(this.boundary),rotation:clone(this.rotation)};this.properties={movable:true,resizable:true,
rotatable:true,borderColor:Config.FrameHandle.stroke,fillColor:"none",borderDashArray:Config.FrameHandle.borderDashArray,handleBorderColor:Config.FrameHandle.stroke,nilWidthAccepted:false,nilHeightAccepted:false};this.handleCount=9;this.svgGroup=null;this.borderElement=null;this.handleElements=[];this.handleGhosts=[];this.eventHandlers=[]},getBoundary:function(){return this.boundary},getPosition:function(){return this.position},getRotation:function(){return this.rotation},saveStatus:function(){var position=
this.getPosition();var boundary=this.getBoundary();var rotation=this.getRotation();this.savedStatus={position:{x:position.x,y:position.y},boundary:{left:boundary.left,top:boundary.top,right:boundary.right,bottom:boundary.bottom},rotation:{cx:rotation.cx,cy:rotation.cy,angle:rotation.angle}}},addEventListener:function(eventName,eventHandler){this.eventHandlers.push({eventName:eventName,eventHandler:eventHandler})},triggerEvent:function(eventName,args){for(var i=0;i<this.eventHandlers.length;i++){var event=
this.eventHandlers[i];if(event.eventName==eventName&&typeof event.eventHandler=="function")event.eventHandler(args)}},render:function(){var that=this;this.svgGroup=this.svgParent.createChildNS("g",{"data-label":"transformable-frame","display":"none"});var fill=this.properties["fillColor"];var borderDashArray=this.properties["borderDashArray"];var borderColor=this.properties["borderColor"];var handleBorderColor=this.properties["handleBorderColor"];this.borderElement=this.svgGroup.createChildNS("path",
{"d":"","fill":fill,"stroke-width":1,"stroke-dasharray":borderDashArray,"stroke":borderColor});for(var i=0;i<=this.handleCount;i++){var type=parseInt(i/4);var posIndex=i-type*4;var handleElement=this.svgGroup.createChildNS("path",{"d":"","fill":Config.FrameHandle.fill,"stroke-width":Config.FrameHandle.borderSize,"stroke":handleBorderColor,"stroke-linecap":"butt","stroke-linejoin":"miter"});var ghostElement=this.svgGroup.createChildNS("path",{"d":"","fill":Config.FrameHandle.ghostFill,"stroke-width":Config.FrameHandle.borderSize,
"stroke":Config.FrameHandle.ghostStroke,"data-type":type,"data-posIndex":posIndex});workspace.getEventManager(ghostElement).addListener("capture",function(e,args){var type=parseInt(args.sender.getAttribute("data-type"));var posIndex=parseInt(args.sender.getAttribute("data-posIndex"));that.captureHandle(type,posIndex,true)}).addListener("release",function(e,args){var type=parseInt(args.sender.getAttribute("data-type"));var posIndex=parseInt(args.sender.getAttribute("data-posIndex"));that.captureHandle(type,
posIndex,false)}).addListener("drag",function(e,args){that.processHandleDragging(e,args)});this.handleElements.push(handleElement);this.handleGhosts.push(ghostElement)}var x=this.position.x;var y=this.position.y;this.position={x:null,y:null};this.moveTo(x,y,true);var left=this.boundary.left;var top=this.boundary.top;var right=this.boundary.right;var bottom=this.boundary.bottom;this.boundary={left:null,top:null,right:null,bottom:null};this.transformTo(left,top,right,bottom,true);this.renderred=true;
for(var key in this.properties)this.setProperty(key,this.properties[key])},captureHandle:function(type,posIndex,captured){if(captured){this.saveStatus();this.selectHandle(type,posIndex,true)}else this.selectHandle(type,posIndex,false)},processHandleDragging:function(e,args){var that=this;var type=parseInt(args.sender.getAttribute("data-type"));var posIndex=parseInt(args.sender.getAttribute("data-posIndex"));that.updateCursor(type,posIndex);if(type==0||type==1){var dLeft=0;var dTop=0;var dRight=0;
var dBottom=0;var delta=that.getMappedOffset(args.begin,args.current);if(type==0)switch(posIndex){case 0:dLeft+=delta.x;dTop+=delta.y;break;case 1:dTop+=delta.y;dRight+=delta.x;break;case 2:dRight+=delta.x;dBottom+=delta.y;break;case 3:dLeft+=delta.x;dBottom+=delta.y;break}else if(type==1)switch(posIndex){case 0:dTop+=delta.y;break;case 1:dRight+=delta.x;break;case 2:dBottom+=delta.y;break;case 3:dLeft+=delta.x;break}var left=QStage.alignToGrid(that.savedStatus.boundary.left+dLeft);var top=QStage.alignToGrid(that.savedStatus.boundary.top+
dTop);var right=QStage.alignToGrid(that.savedStatus.boundary.right+dRight);var bottom=QStage.alignToGrid(that.savedStatus.boundary.bottom+dBottom);that.transformTo(left,top,right,bottom,true)}else switch(posIndex){case 0:var x=QStage.alignToGrid(that.savedStatus.position.x+args.begin.dx);var y=QStage.alignToGrid(that.savedStatus.position.y+args.begin.dy);that.moveTo(x,y,true);break;case 1:var eBoundary=QStage.enhanceBoundary(that.boundary,false);that.validRotationCenter(eBoundary);var position=that.getPosition();
var x0=eBoundary.cx;var y0=eBoundary.cy;var currentPoint=workspace.transformPoint({x:args.previous.x,y:args.previous.y});var x1=eBoundary.cx;var y1=eBoundary.top;var x2=currentPoint.x-position.x;var y2=currentPoint.y-position.y;var angle=that.getDeltaAngle({x:x0,y:y0},{x:x1,y:y1},{x:x2,y:y2});var newAngle=QStage.alignToGrid(angle/Math.PI*180);that.rotateTo(newAngle,x0,y0);break}},validRotationCenter:function(eBoundary){if(this.rotation.angle%360!=0)if(this.rotation.cx!=eBoundary.cx||this.rotation.cy!=
eBoundary.cy){if(eBoundary==null)eBoundary=QStage.enhanceBoundary(this.boundary);var newCenter={x:eBoundary.cx,y:eBoundary.cy};var oldCenter={x:this.rotation.cx,y:this.rotation.cy};var delta=this.getRotationOffset(oldCenter.x,oldCenter.y,newCenter.x,newCenter.y,this.rotation.angle);this.rotation.cx=newCenter.x;this.rotation.cy=newCenter.y;this.move(delta.x,delta.y,false)}},getMappedOffset:function(p1,p2){var delta={x:p2.x-p1.x,y:p2.y-p1.y};var angle=this.rotation.angle;if(angle%360!=0){var alpha=
Math.atan2(delta.y,delta.x)-angle/180*Math.PI;var m=Math.sqrt(Math.pow(delta.y,2)+Math.pow(delta.x,2));var dx=m*Math.cos(alpha);var dy=m*Math.sin(alpha);delta={x:QStage.round(dx),y:QStage.round(dy)}}return delta},getOriginalPoint:function(x,y){var angle=this.rotation.angle;if(angle%360==0)return{x:x,y:y};var o={x:this.rotation.cx,y:this.rotation.cy};var p={x:x,y:y};angle=angle%360;var d=angle/180*Math.PI;var c=d>Math.PI?-Math.cos(d):Math.cos(d);var m=Math.sqrt(Math.pow(p.x-o.x,2)+Math.pow(p.y-o.y,
2));var theta=0;if(p.y-o.y>0)theta=Math.acos(c)+Math.atan((p.x-o.x)/(p.y-o.y));else if(p.y-o.y<0)theta=Math.acos(c)+Math.atan((p.x-o.x)/(p.y-o.y))-Math.PI;else return{x:QStage.round(o.x+Math.abs(p.x-o.x)*Math.cos(d)),y:QStage.round(o.y-Math.abs(p.x-o.x)*Math.sin(d))};if(d<Math.PI)return{x:QStage.round(o.x+m*Math.sin(theta)),y:QStage.round(o.y+m*Math.cos(theta))};else return{x:QStage.round(o.x-m*Math.sin(theta)),y:QStage.round(o.y-m*Math.cos(theta))}},getDeltaAngle:function(p0,p1,p2){var alpha0=Math.atan2(p1.x-
p0.x,p1.y-p0.y);var alpha1=Math.atan2(p2.x-p0.x,p2.y-p0.y);return alpha0-alpha1},getRotationOffset:function(cx1,cy1,cx2,cy2,angle){var d=angle/180*Math.PI;var cos=Math.cos(d);var dx=cx2-cx1;var dy=cy2-cy1;var r=Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));var a=Math.pow(r,2);var b,c,resX1,resX2,resY1,resY2;if(cx1==cx2){b=-2*Math.pow(r,2)*(cx1*cos-cx2*cos+cx2);c=-Math.pow(r*(cy1-cy2),2)+Math.pow(r,4)*Math.pow(cos,2)+2*Math.pow(r,2)*cos*(cx1-cx2)*cx2+Math.pow(r*cx2,2);resX1=(-b+Math.sqrt(Math.pow(b,2)-
4*a*c))/(2*a);resX2=(-b-Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);resY1=(Math.pow(r,2)*cos+(cx1-cx2)*(cx2-resX1))/(cy1-cy2)+cy2;resY2=(Math.pow(r,2)*cos+(cx1-cx2)*(cx2-resX2))/(cy1-cy2)+cy2}else{b=-2*Math.pow(r,2)*(cy1*cos-cy2*cos+cy2);c=-Math.pow(r*(cx1-cx2),2)+Math.pow(r,4)*Math.pow(cos,2)+2*Math.pow(r,2)*cos*(cy1-cy2)*cy2+Math.pow(r*cy2,2);resY1=(-b+Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);resY2=(-b-Math.sqrt(Math.pow(b,2)-4*a*c))/(2*a);resX1=(Math.pow(r,2)*cos+(cy1-cy2)*(cy2-resY1))/(cx1-cx2)+cx2;resX2=
(Math.pow(r,2)*cos+(cy1-cy2)*(cy2-resY2))/(cx1-cx2)+cx2}var refAngle=this.getDeltaAngle({x:cx2,y:cy2},{x:cx1,y:cy1},{x:resX1,y:resY1})*Math.sin(d);var offset=null;if(refAngle>0)offset={x:QStage.round(cx1-resX1),y:QStage.round(cy1-resY1)};else offset={x:QStage.round(cx1-resX2),y:QStage.round(cy1-resY2)};return offset},getBorderPath:function(){var boundary=this.getBoundary();var left=boundary.left;var top=boundary.top;var right=boundary.right;var bottom=boundary.bottom;var hPadding=left<right?.5:-.5;
var vPadding=top<bottom?.5:-.5;left=Math.round(left)-hPadding;top=Math.round(top)-vPadding;right=Math.round(right)+hPadding;bottom=Math.round(bottom)+vPadding;var d="";var hcenter=(right-left)/2+left;d+="M {0},{1} ".format(hcenter,top);d+="V {0} ".format(top);d+="H {0} ".format(right);d+="V {0} ".format(bottom);d+="H {0} ".format(left);d+="V {0} ".format(top);d+="H {0} ".format(hcenter);if(this.properties["rotatable"])d+="V {0} ".format(top-2*(bottom-top>0?Config.FrameHandle.length:-Config.FrameHandle.length));
return d},getHandlePath:function(type,posIndex,forGhost){var boundary=QStage.enhanceBoundary(this.boundary,false);var left=boundary.left;var top=boundary.top;var right=boundary.right;var bottom=boundary.bottom;var width=boundary.width;var height=boundary.height;var absHLength,absVLength,absHWeight,absVWeight;if(Config.FrameHandle.length*2>Math.abs(width)){absHLength=Math.abs(width)/2;absHWeight=Config.FrameHandle.weight}else if(forGhost){absHLength=Config.FrameHandle.length*2;absHWeight=Config.FrameHandle.weight*
4}else{absHLength=Config.FrameHandle.length;absHWeight=Config.FrameHandle.weight}if(Config.FrameHandle.length*2>Math.abs(height)){absVLength=Math.abs(height)/2;absVWeight=Config.FrameHandle.weight}else if(forGhost){absVLength=Config.FrameHandle.length*2;absVWeight=Config.FrameHandle.weight*4}else{absVLength=Config.FrameHandle.length;absVWeight=Config.FrameHandle.weight}var hLength=width>0?absHLength:-absHLength;var vLength=height>0?absVLength:-absVLength;var hWeight=width>0?absHWeight:-absHWeight;
var vWeight=height>0?absVWeight:-absVWeight;var h={l:[left-hWeight/2,left+hWeight/2,left+hLength/2+hWeight/2],m:[(left+right)/2-hLength/2,(left+right)/2-hWeight/2,(left+right)/2+hWeight/2,(left+right)/2+hLength/2],r:[right-hWeight/2-hLength/2,right-hWeight/2,right+hWeight/2]};var v={t:[top-vWeight/2,top+vWeight/2,top+vLength/2+vWeight/2],m:[(top+bottom)/2-vLength/2,(top+bottom)/2-vWeight/2,(top+bottom)/2+vWeight/2,(top+bottom)/2+vLength/2],b:[bottom-vWeight/2-vLength/2,bottom-vWeight/2,bottom+vWeight/
2]};var hPadding=width>0?.5:-.5;var vPadding=height>0?.5:-.5;h.l[0]=Math.round(h.l[0])-hPadding;h.l[1]=Math.round(h.l[1])-hPadding;h.l[2]=Math.round(h.l[2])-hPadding;h.m[0]=Math.round(h.m[0])-hPadding;h.m[1]=Math.round(h.m[1])-hPadding;h.m[2]=Math.round(h.m[2])+hPadding;h.m[3]=Math.round(h.m[3])+hPadding;h.r[0]=Math.round(h.r[0])+hPadding;h.r[1]=Math.round(h.r[1])+hPadding;h.r[2]=Math.round(h.r[2])+hPadding;v.t[0]=Math.round(v.t[0])-vPadding;v.t[1]=Math.round(v.t[1])-vPadding;v.t[2]=Math.round(v.t[2])-
vPadding;v.m[0]=Math.round(v.m[0])-vPadding;v.m[1]=Math.round(v.m[1])-vPadding;v.m[2]=Math.round(v.m[2])+vPadding;v.m[3]=Math.round(v.m[3])+vPadding;v.b[0]=Math.round(v.b[0])+vPadding;v.b[1]=Math.round(v.b[1])+vPadding;v.b[2]=Math.round(v.b[2])+vPadding;var path="";if(type==0)switch(posIndex){case 0:path+=this.buildPathPattern("Mh0,v0 Hh2 Vv1 Hh1 Vv2 Hh0 Vv0 Z",h.l,v.t);break;case 1:path+=this.buildPathPattern("Mh2,v0 Vv2 Hh1 Vv1 Hh0 Vv0 Hh2 Z",h.r,v.t);break;case 2:path+=this.buildPathPattern("Mh2,v2 Hh0 Vv1 Hh1 Vv0 Hh2 Vv2 Z",
h.r,v.b);break;case 3:path+=this.buildPathPattern("Mh0,v2 Vv0 Hh1 Vv1 Hh2 Vv2 Hh0 Z",h.l,v.b);break}else if(type==1)switch(posIndex){case 0:path+=this.buildPathPattern("Mh0,v0 Hh3 Vv1 Hh0 Vv0 Z",h.m,v.t);break;case 1:path+=this.buildPathPattern("Mh2,v0 Vv3 Hh1 Vv0 Hh2 Z",h.r,v.m);break;case 2:path+=this.buildPathPattern("Mh3,v2 Hh0 Vv1 Hh3 Vv2 Z",h.m,v.b);break;case 3:path+=this.buildPathPattern("Mh0,v3 Vv0 Hh1 Vv3 Hh0 Z",h.l,v.m);break}else switch(posIndex){case 0:path+=this.buildPathPattern("Mh1,v0 Hh2 Vv1 Hh3 Vv2 Hh2 Vv3 Hh1 Vv2 Hh0 Vv1 Hh1 Vv0 Z",
h.m,v.m);break;case 1:var cx=(left+right)/2;var cy=top-2*(bottom>top?Config.FrameHandle.length:-Config.FrameHandle.length);var r=Config.FrameHandle.weight;if(forGhost)r*=4;path+="M{0},{1} m-{2},0 a{2},{2} 0 1,0 {3},0 a{2},{2} 0 1,0 -{3},0".format(cx,cy,r,2*r);break}return path},buildPathPattern:function(pattern,hArray,vArray){var p=pattern;p=p.replace(/h0/g,hArray[0]);p=p.replace(/h1/g,hArray[1]);p=p.replace(/h2/g,hArray[2]);if(hArray.length>3)p=p.replace(/h3/g,hArray[3]);p=p.replace(/v0/g,vArray[0]);
p=p.replace(/v1/g,vArray[1]);p=p.replace(/v2/g,vArray[2]);if(vArray.length>3)p=p.replace(/v3/g,vArray[3]);return p},transform:function(dLeft,dTop,dRight,dBottom,triggerCallback){var left=QStage.alignToGrid(this.savedStatus.boundary.left+dLeft);var top=QStage.alignToGrid(this.savedStatus.boundary.top+dTop);var right=QStage.alignToGrid(this.savedStatus.boundary.right+dRight);var bottom=QStage.alignToGrid(this.savedStatus.boundary.bottom+dBottom);this.transformTo(left,top,right,bottom,triggerCallback)},
transformTo:function(left,top,right,bottom,triggerCallback){if(left==right&&!this.properties["nilWidthAccepted"])right++;if(top==bottom&&!this.properties["nilHeightAccepted"])bottom++;if(this.boundary.left==left&&this.boundary.top==top&&this.boundary.right==right&&this.boundary.bottom==bottom)return;var oldBoundary={left:this.boundary.left,top:this.boundary.top,right:this.boundary.right,bottom:this.boundary.bottom};this.boundary.left=left;this.boundary.top=top;this.boundary.right=right;this.boundary.bottom=
bottom;if(triggerCallback)this.triggerEvent("boundarychange",{oldBoundary:oldBoundary,newBoundary:{left:left,top:top,right:right,bottom:bottom}});this.borderElement.setAttribute("d",this.getBorderPath());for(var i=0;i<=this.handleCount;i++){var type=parseInt(i/4);var posIndex=i-type*4;this.handleElements[i].setAttribute("d",this.getHandlePath(type,posIndex,false));this.handleGhosts[i].setAttribute("d",this.getHandlePath(type,posIndex,true))}},move:function(dX,dY,triggerCallback){var x=QStage.alignToGrid(this.savedStatus.position.x+
dX);var y=QStage.alignToGrid(this.savedStatus.position.y+dY);this.moveTo(x,y,triggerCallback)},moveTo:function(x,y,triggerCallback){if(this.position.x==x&&this.position.y==y)return;var oldPosition={x:this.position.x,y:this.position.y};this.position.x=x;this.position.y=y;if(triggerCallback)this.triggerEvent("positionchange",{oldPosition:oldPosition,newPosition:{x:x,y:y}});this.updateSvgTransform()},rotateTo:function(angle,cx,cy){if(this.rotation.angle==angle&&this.rotation.cx==cx&&this.rotation.cy==
cy)return;var oldPosition={cx:this.rotation.cx,cy:this.rotation.cy,angle:this.rotation.angle};this.rotation={cx:cx,cy:cy,angle:angle};this.triggerEvent("rotationchange",{oldRotation:oldPosition,newRotation:{cx:cx,cy:cy,angle:angle}});this.updateSvgTransform()},updateSvgTransform:function(){var translateInfo="";translateInfo+=" translate({0}, {1})".format(this.position.x,this.position.y);if(this.rotation%360!=0)translateInfo+=" rotate({0}, {1}, {2})".format(this.rotation.angle,this.rotation.cx,this.rotation.cy);
if(this.moveParent)this.svgParent.setAttribute("transform",translateInfo);else this.svgGroup.setAttribute("transform",translateInfo)},setProperty:function(key,value){this.properties[key]=value;if(this.renderred)switch(key){case "movable":var type=2;var posIndex=0;this.setHandleShowing(type,posIndex,value);break;case "resizable":for(var type=0;type<=1;type++)for(var posIndex=0;posIndex<=4;posIndex++)this.setHandleShowing(type,posIndex,value);break;case "rotatable":var type=2;var posIndex=1;this.setHandleShowing(type,
posIndex,value);this.borderElement.setAttribute("d",this.getBorderPath());break;case "borderColor":this.borderElement.setAttribute("stroke",this.properties[key]);break;case "borderDashArray":this.borderElement.setAttribute("borderDashArray",this.properties[key]);break;case "handleBorderColor":for(var i=0;i<=this.handleCount;i++)this.handleElements[i].setAttribute("stroke",this.properties[key]);break}},setEnabled:function(enabled){if(!this.renderred)return;this.enabled=enabled;this.svgGroup.updateStyle("display",
enabled?"block":"none")},setHandlesShowing:function(show){if(!this.renderred)return;for(var type=0;type<=1;type++)for(var posIndex=0;posIndex<=4;posIndex++)this.setHandleShowing(type,posIndex,value);this.setHandleShowing(2,0,value);this.setHandleShowing(2,1,value)},setHandleShowing:function(type,posIndex,show){if(!this.renderred)return;var index=type*4+posIndex;this.handleElements[index].updateStyle("display",show?"block":"none");this.handleGhosts[index].updateStyle("display",show?"block":"none")},
setBorderShowing:function(show){if(!this.renderred)return;this.borderElement.updateStyle("display",show?"block":"none")},selectHandle:function(type,posIndex,selected){var index=type*4+posIndex;for(var i=0;i<=this.handleCount;i++){var handle=this.handleElements[i];var ghost=this.handleGhosts[i];if(i==index){handle.setAttribute("fill",selected?Config.FrameHandle.capturedFill:Config.FrameHandle.fill);handle.setAttribute("stroke",selected?Config.FrameHandle.capturedStroke:Config.FrameHandle.stroke);if(selected)this.updateCursor(type,
posIndex);else ghost.updateStyle("cursor","default")}else{handle.setAttribute("fill",selected?Config.FrameHandle.highlightedFill:Config.FrameHandle.fill);handle.setAttribute("stroke",selected?Config.FrameHandle.highlightedStroke:Config.FrameHandle.stroke)}}},updateCursor:function(type,posIndex){return;var ghost=this.handleGhosts[type*4+posIndex];var oldCursor=ghost.getStyle("cursor");var width=this.boundary.width;var height=this.boundary.height;var cursor="default";if(type==0)switch(posIndex){case 0:case 2:cursor=
width*height>0?"se-resize":"ne-resize";break;case 1:case 3:cursor="ne-resize";break}else if(type==1)switch(posIndex){case 0:case 2:cursor="s-resize";break;case 1:case 3:cursor="w-resize";break}else cursor="move";if(oldCursor!=cursor)ghost.updateStyle("cursor",cursor)}};var TransformableFrame=Class.extend(transformable_frame_prototype);
function Workspace(){this.painting=null;this.eventManager=null;this.drawingBoard=null;this.scaleplate=null;this.slidePane=null;this.objectManager=null;this.textPanel=null;this.promptDialog=null;this.startPage=null;this.width=0;this.height=0;this.stageWrapper=null;this.startWrapper=null;this.scrimWrapper=null;this.autoSaveEnabled=false;this.init()}
Workspace.prototype={init:function(){this.painting=new Painting(this);this.eventManager=new EventManager(this);this.drawingBoard=new DrawingBoard(this);this.scaleplate=new Scaleplate(this,0,0);this.slidePane=new SlidePane(this);this.objectManager=new ObjectManager(this);this.textPanel=new TextPanel(this);this.promptDialog=new PromptDialog(this)},reset:function(enableAutoSave){this.drawingBoard.reset();this.slidePane.reset();this.painting.reset();if(enableAutoSave)this.autoSaveEnabled=true},showStartPage:function(show){if(show)if(this.startPage==
null){this.startPage=new StartPage(this);this.startPage.renderInto(this.startWrapper,this.width,this.height);this.stageWrapper.updateStyle("left","{0}px".format(this.width))}else this.startPage.setDisplay(true);else if(this.startPage!=null)this.startPage.setDisplay(false)},render:function(){var that=this;this.width=document.documentElement.clientWidth-2*Config.Workspace.margin;this.height=document.documentElement.clientHeight-2*Config.Workspace.margin;var rootElement=document.body;this.stageWrapper=
rootElement.createChild("div",{id:"workspace"});this.startWrapper=rootElement.createChild("div",{id:"start-page"});this.scrimWrapper=rootElement.createChild("div",{class:"scrim",style:"display: none"});var css3support=QStage.supportsTransitions();this.stageWrapper.style[css3support.prefixedProperty]="left 0.5s ease-in";this.stageWrapper.addEventListener(css3support.prefixedEventName,function(){});this.slidePane.renderIntoWorkspace();this.scaleplate.renderIntoWorkspace();this.drawingBoard.renderIntoWorkspace();
this.objectManager.renderIntoWorkspace();this.textPanel.renderIntoWorkspace();this.promptDialog.renderIntoWorkspace();this.sizeChanged();this.painting.onShapeChanged=function(newShape){if(newShape!=null&&newShape.committed){that.slidePane.showPropertyMenu(newShape);that.painting.setFill(newShape.prop("fill").color,newShape.prop("fill").opacity);that.painting.setStroke(newShape.prop("stroke").color,newShape.prop("stroke").opacity,newShape.prop("stroke").width)}else that.slidePane.showPropertyMenu(null);
if(newShape!=null)that.objectManager.selectShapes([newShape]);else that.objectManager.selectShapes([])};this.painting.onFillChanged=function(color,opacity){that.slidePane.setFill(color,opacity)};this.painting.onStrokeChanged=function(color,opacity,width){that.slidePane.setStroke(color,opacity,width)};this.painting.onShapeAppended=function(appendedShape){that.objectManager.appendShape(appendedShape)};this.painting.onShapeRemoved=function(removedShape,removedIndex){that.objectManager.removeShape(removedShape,
removedIndex)};this.painting.onShapeSorted=function(shape,oldIndex,newIndex){that.objectManager.sortShape(shape,oldIndex,newIndex)};this.painting.onToolChanged=function(oldToolType,newToolType){that.slidePane.selectToolType(newToolType);if(newToolType==ToolTypes.Pen&&that.painting.selectedShape!=null&&that.painting.selectedShape.isPathShape()){that.painting.selectedShape.switchPathEditing(true);that.slidePane.showPropertyMenu(null)}else this.selectShape(null);if(oldToolType==ToolTypes.Crop)that.drawingBoard.canvasFrame.setEnabled(false);
if(newToolType==ToolTypes.Crop)that.drawingBoard.canvasFrame.setEnabled(true)};this.painting.onProjectChanged=function(){that.autoSave()};this.drawingBoard.onBoardMoved=function(offsetX,offsetY){that.scaleplate.changeOffset(offsetX,offsetY)};this.drawingBoard.onCaptured=function(){that.slidePane.selectMenuItem(null)};this.slidePane.fillMenu.onColorChanged=function(color,opacity,width){var shape=that.painting.selectedShape;if(shape!=null)shape.prop("fill",{color:color,opacity:opacity});that.painting.setFill(color,
opacity)};this.slidePane.strokeMenu.onColorChanged=function(color,opacity,width){var shape=that.painting.selectedShape;if(shape!=null)shape.prop("stroke",{color:color,opacity:opacity,width:width});that.painting.setStroke(color,opacity,width)};function checkWindowsize(){var nWidth=document.documentElement.clientWidth-2*Config.Workspace.margin;var nHeight=document.documentElement.clientHeight-2*Config.Workspace.margin;if(nWidth!=that.width||nHeight!=that.height){that.width=nWidth;that.height=nHeight;
that.sizeChanged()}}setInterval(checkWindowsize,200);var animationNum=QStage.getQueryStringByName("animation");if(animationNum!=null&&animationNum>0){var addIcon=function(){stage.addIcon();if(stage.icons.length<animationNum)setTimeout(addIcon,1E3)};if(animationNum>10)animationNum=10;var containerGroup=this.drawingBoard.underGroup;var svgWidth=this.drawingBoard.svgSize.width;var svgHeight=this.drawingBoard.svgSize.height;var stage=new Stage(containerGroup,svgWidth,svgHeight);addIcon();this.slidePane.wrapper.updateStyle("display",
"none")}this.autoLoad()},saveToCache:function(){if(!Config.General.offlineMode)return false;var projectId=QStage.getUrlHash("id");if(!projectId||projectId.length===0)return false;var jsonObj=this.painting.serialize("JSON");var saved=QCache.setProject(projectId,jsonObj);return saved},getWrapper:function(){return this.stageWrapper},isSmallScreen:function(){return this.width<=480||this.height<=480},isLandscape:function(){return this.width>this.height},switchDeveloperMode:function(devMode){if(Config.General.developerMode==
devMode)return;Config.General.developerMode=devMode;var displayStyle=devMode?null:"none";QStage.$("hidden_map_tools").updateStyle("display",displayStyle);QStage.$("hidden_sample_menu").updateStyle("display",displayStyle)},sizeChanged:function(){this.stageWrapper.updateStyle("width",this.width);this.stageWrapper.updateStyle("height",this.height);this.stageWrapper.updateStyle("margin","{0}px 0px 0px {0}px".format(Config.Workspace.margin));if(this.startPage!=null)this.startPage.resize(this.width,this.height);
this.textPanel.resize(this.width,this.height);this.promptDialog.resize(this.width,this.height);var objMgrLeft=this.width-Config.ObjectManager.marginRight-Config.ObjectManager.width;this.objectManager.moveWindowTo(objMgrLeft,Config.ObjectManager.marginTop);this.resizeDrawingBoard(this.width,this.height);this.scaleplate.resize(this.width,this.height);this.slidePane.resize(this.width,this.height);if(this.scrimWrapper!=null){this.scrimWrapper.updateStyle("width",this.width+"px");this.scrimWrapper.updateStyle("height",
this.height+"px");this.scrimWrapper.updateStyle("padding-top",this.height/2+"px")}},resizeDrawingBoard:function(workspaceWidth,workspaceHeight){var scaleplateSize=Config.General.showScale?Config.Scaleplate.size:0;var boardWidth=workspaceWidth-scaleplateSize;var boardHeight=workspaceHeight-scaleplateSize;this.drawingBoard.resize(boardWidth,boardHeight)},transformPoint:function(point){return this.drawingBoard.transformPoint(point)},showGhost:function(d){return this.drawingBoard.showGhost(d)},getEventManager:function(owner){return this.eventManager.getRegistration(owner)},
selectShapeById:function(id){this.painting.selectShapeById(id)},showScalePlate:function(show){this.scaleplate.setShowing(show);this.resizeDrawingBoard(this.width,this.height);var scaleplateSize=Config.General.showScale?Config.Scaleplate.size:0;this.slidePane.setMargin(scaleplateSize,scaleplateSize)},showScrim:function(show,msg){this.scrimWrapper.updateStyle("display",show?null:"none");if(msg!=null)this.scrimWrapper.textContent=msg;else this.scrimWrapper.textContent=""},autoSave:function(){if(!this.autoSaveEnabled)return;
if(Config.General.offlineMode)this.saveToCache()},loadProject:function(id,callback){var that=this;if(Config.General.offlineMode===true){var cachedObj=QCache.getProject(id);if(cachedObj!=null){console.log("loaded from localStorage");that.painting.deserialize(cachedObj,"JSON");if(typeof callback=="function")callback(true)}else{console.log("project not found in localStorage");if(typeof callback=="function")callback(false)}}else{this.showScrim(true,"Loading... Please Wait...");this.loadFromServer(id,
function(obj){if(obj!=null){console.log("loaded from server");that.painting.deserialize(obj,"JSON");if(typeof callback=="function")callback(true)}else{console.log("nothing loaded from server");if(typeof callback=="function")callback(false)}that.showScrim(false)})}},autoLoad:function(callback){var that=this;var urlId=QStage.getUrlHash("id");if(Config.General.offlineMode===true){if(urlId&&urlId.length>0){var cachedObj=QCache.getProject(urlId);if(cachedObj!=null){console.log("auto-loaded from localStorage with ID:",
urlId);this.painting.deserialize(cachedObj,"JSON")}else{console.log("project not found in localStorage with ID:",urlId);this.autoSaveEnabled=true}}}else if(QStage.isValidId(urlId))this.loadProject(urlId,function(success){if(!success)that.autoSaveEnabled=true})},loadFromServer:function(id,callback){var that=this;var xmlhttp=new XMLHttpRequest;var url="http://stage.qlike.com/repository/?action=pull";var params="id="+id;xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4)if(typeof callback==
"function")if(xmlhttp.status==200)try{var o=JSON.parse(xmlhttp.responseText);if(o.payload.length>0){var projectJson=o.payload[0].json_string;callback(JSON.parse(projectJson))}else callback(null)}catch(err){console.log(xmlhttp.responseText);callback(null)}else callback(null)};xmlhttp.open("POST",url,true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send(params)},sendToServer:function(callback){var that=this;this.showScrim(true,"Sending to server...");var xmlhttp=
new XMLHttpRequest;var url="http://stage.qlike.com/repository/";var urlId=QStage.getUrlHash("id");if(QStage.isValidId(urlId))url+="?action=push&id="+urlId;else url+="?action=push";var params="payload="+this.painting.serialize("STRING");function processResponse(o){if(o!=null&&o.id&&o.rows>0){if(typeof callback=="function")callback(o.id)}else callback(null);that.showScrim(false);that.painting.modified=false}xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4)if(xmlhttp.status==200){var o=
JSON.parse(xmlhttp.responseText);processResponse(o)}else processResponse(null)};xmlhttp.open("POST",url,true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send(params)},needToBeSaved:function(){var urlId=QStage.getUrlHash("id");return!QStage.isValidId(urlId)||this.painting.modified}};var workspace=null;addEventListener("load",function(){workspace=new Workspace;workspace.render();var id=QStage.getUrlHash("id");if(id==null)workspace.showStartPage(true)});
