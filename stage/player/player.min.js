(function(){var Player={extend:function(obj){for(var key in obj){if(!obj.hasOwnProperty(key))continue;this[key]=obj[key]}},localStorageKey:"q-stage",localStorageSubKey:"player-cache",group:null,canvas:null,shapes:null,fps:20,projectId:null};Player.extend({play:function(stageObj){var that=this;var rootElement=document.body;var wrapper=document.createElement("div");rootElement.appendChild(wrapper);if(stageObj==null){var loading=document.createElement("div");loading.setAttribute("style","font-size: 16px; color: #ff3300; ");
loading.textContent="Loading... Please Wait...";wrapper.appendChild(loading);var tryLoadFromCache=function(id){var cachedObj=that.loadFromCache();if(cachedObj!=null){console.log("Loaded from cache");if(id!=null)that.projectId=id;wrapper.removeChild(loading);that.play(cachedObj);return true}return false};var id=this.getQueryStringByName("id");if(id!=null)this.loadFromServer(id,function(obj){if(obj!=null){console.log("Loaded from server");that.projectId=id;wrapper.removeChild(loading);that.play(obj)}else{console.log("Nothing loaded from server, trying local storage");
if(!tryLoadFromCache(id))loading.textContent="No project data found."}});else if(!tryLoadFromCache(null))loading.textContent="No project data found in local storage.";return}this.canvas=stageObj.canvas;this.shapes=stageObj.shapes;var eBoundary=this.getEnhancedBoundary(this.canvas.boundary);var svg=wrapper.createChildNS("svg",{width:eBoundary.width,height:eBoundary.height,style:"background-color: #EEEEEE"});var baseLeft=-this.canvas.position.x-eBoundary.left;var baseTop=-this.canvas.position.y-eBoundary.top;
this.group=svg.createChildNS("g",{transform:" translate({0}, {1})".format(baseLeft,baseTop)});if(this.shapes.length>0)this.renderShape(0);if(this.projectId!=null){var footer=document.createElement("div");footer.setAttribute("style","margin: 10px 0px");wrapper.appendChild(footer);var targetFile="../";if(this.isLocal())targetFile+="index.html";targetFile+="#id="+this.projectId;var link=document.createElement("a");link.setAttribute("href",targetFile);link.setAttribute("target","_blank");link.textContent=
"[Modify This Project]";footer.appendChild(link)}},loadFromServer:function(id,callback){var that=this;var xmlhttp=new XMLHttpRequest;var url="http://stage.qlike.com/repository/?action=pull";var params="id="+id;xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4)if(typeof callback=="function")if(xmlhttp.status==200)try{var o=JSON.parse(xmlhttp.responseText);if(o.payload.length>0){var projectJson=o.payload[0].json_string;callback(JSON.parse(projectJson))}else callback(null)}catch(err){console.log(xmlhttp.responseText);
callback(null)}else callback(null)};xmlhttp.open("POST",url,true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send(params)},loadFromCache:function(){if(!localStorage){console.log("Local storage not supported");return null}var json=localStorage.getItem(this.localStorageKey);if(json!=null)try{var object=JSON.parse(json);if(!object.hasOwnProperty(this.localStorageSubKey))return null;else return object[this.localStorageSubKey]}catch(err){console.log("Error to parse json string");
return null}else{console.log("No content in local storage");return null}},renderShape:function(index){var that=this;var shape=this.shapes[index];var subGroup=this.group.createChildNS("g",{transform:this.getTransForm(shape.position,shape.rotation)});var eBoundary=this.getEnhancedBoundary(shape.boundary);var properties=shape.properties;var element=null;switch(shape.type){case ShapeTypes.Line:element=subGroup.createChildNS("path",{d:this.getPathData(shape.points,properties.getByKey("closePath")),fill:"none",
stroke:this.brushToRgba(properties.getByKey("stroke")),"stroke-width":properties.getByKey("stroke").width});break;case ShapeTypes.Rectangle:var d="";d+=this.buildPathCommand("M",[eBoundary.left,eBoundary.top]);d+=this.buildPathCommand("H",[eBoundary.right]);d+=this.buildPathCommand("V",[eBoundary.bottom]);d+=this.buildPathCommand("H",[eBoundary.left]);d+=this.buildPathCommand("Z");element=subGroup.createChildNS("path",{fill:this.brushToRgba(properties.getByKey("fill")),stroke:this.brushToRgba(properties.getByKey("stroke")),
"stroke-width":properties.getByKey("stroke").width,d:d});break;case ShapeTypes.Ellipse:var cx=eBoundary.cx;var cy=eBoundary.cy;var rx=eBoundary.rx;var ry=eBoundary.ry;var ox=.5*rx;var oy=.6*ry;var d="";d+=this.buildPathCommand("M",[0+cx,ry+cy]);d+=this.buildPathCommand("C",[ox+cx,ry+cy,rx+cx,oy+cy,rx+cx,0+cy]);d+=this.buildPathCommand("C",[rx+cx,-oy+cy,ox+cx,-ry+cy,0+cx,-ry+cy]);d+=this.buildPathCommand("C",[-ox+cx,-ry+cy,-rx+cx,-oy+cy,-rx+cx,0+cy]);d+=this.buildPathCommand("C",[-rx+cx,oy+cy,-ox+
cx,ry+cy,0+cx,ry+cy]);d+=this.buildPathCommand("Z");element=subGroup.createChildNS("path",{fill:this.brushToRgba(properties.getByKey("fill")),stroke:this.brushToRgba(properties.getByKey("stroke")),"stroke-width":properties.getByKey("stroke").width,d:d});break;case ShapeTypes.Polygon:case ShapeTypes.Polyline:case ShapeTypes.Freeline:element=subGroup.createChildNS("path",{d:this.getPathData(shape.points,properties.getByKey("closePath")),fill:properties.getByKey("applyFill")?this.brushToRgba(properties.getByKey("fill")):
"none",stroke:this.brushToRgba(properties.getByKey("stroke")),"stroke-width":properties.getByKey("stroke").width});break;break;case ShapeTypes.Label:element=subGroup.createChildNS("text",{fill:this.brushToRgba(properties.getByKey("fill")),class:"no-select",x:eBoundary.left,y:eBoundary.bottom,"font-size":eBoundary.height,textLength:eBoundary.width,lengthAdjust:properties.getByKey("lengthAdjust")},properties.getByKey("text"));break}element.setAttribute("stroke-linecap",properties.getByKey("strokeLinecap"));
element.setAttribute("stroke-linejoin",properties.getByKey("strokeLinejoin"));element.setAttribute("fill","none");this.playStrokeAnimation(element,properties.getByKey("strokeAnimation"),function(){var applyFill=properties.getByKey("applyFill");var duration=properties.getByKey("fillAnimation");var fill=properties.getByKey("fill");that.playFillAnimation(element,applyFill,duration,fill,function(){index++;if(index<that.shapes.length)that.renderShape(index)})})},playStrokeAnimation:function(element,duration,
callback){var that=this;if(element.getTotalLength){var strokePercentage=1;var pathLength=element.getTotalLength();var step=function(){element.updateStyle("stroke-dasharray",pathLength);element.updateStyle("stroke-dashoffset",pathLength*strokePercentage);if(strokePercentage>0){strokePercentage-=1/that.fps/duration;setTimeout(step,1E3/that.fps)}else{element.updateStyle("stroke-dasharray",null);element.updateStyle("stroke-dashoffset",null);if(typeof callback=="function")callback()}};step()}else if(typeof callback==
"function")callback()},playFillAnimation:function(element,applyFill,duration,fill,callback){var that=this;if(applyFill){var fillPercentage=1;var step=function(){var fillOpacity=fill.opacity*(1-fillPercentage);element.setAttribute("fill",that.brushToRgba({color:fill.color,opacity:fillOpacity}));if(fillPercentage>0){fillPercentage-=1/that.fps/duration;setTimeout(step,1E3/that.fps)}else if(typeof callback=="function")callback()};step()}else if(typeof callback=="function")callback()},getQueryStringByName:function(name,
url){if(url==null)url=location.search;var result=url.match(new RegExp("[?&]"+name+"=([^&]+)","i"));if(result==null||result.length<1)return null;else return result[1]},getTransForm:function(position,rotation){var translateInfo="";translateInfo+=" translate({0}, {1})".format(position.x,position.y);if(rotation!=null&&rotation%360!=0)translateInfo+=" rotate({0}, {1}, {2})".format(rotation.angle,rotation.cx,rotation.cy);return translateInfo},buildPathCommand:function(cmd,args){var str=cmd;if(args==null||
args.length==0)str+=" ";else if(args.length==1)str+="{0} ".format(args[0]);else for(var i=0;i<args.length;i+=2){var x=args[i];var y=args[i+1];str+="{0},{1} ".format(x,y)}return str},getPathCommand:function(points,index){var point=null;var point=index==-1?points[0]:points[index];var x=point[0];var y=point[1];var path="";if(index==0)path+="M{0} {1}".format(x,y);else{var previousCtrl=null,currentCtrl=null;if(point.length==4)currentCtrl={x:point[2]+x,y:point[3]+y};var prevIndex=index>0?index-1:points.length-
1;if(points[prevIndex].length==4)previousCtrl={x:-points[prevIndex][2]+points[prevIndex][0],y:-points[prevIndex][3]+points[prevIndex][1]};if(currentCtrl!=null)if(previousCtrl!=null)path+=" C{0} {1}, {2} {3}, {4} {5}".format(previousCtrl.x,previousCtrl.y,currentCtrl.x,currentCtrl.y,x,y);else path+=" Q{0} {1}, {2} {3}".format(currentCtrl.x,currentCtrl.y,x,y);else if(previousCtrl!=null)path+=" Q{0} {1}, {2} {3}".format(previousCtrl.x,previousCtrl.y,x,y);else path+=" L{0} {1}".format(x,y)}return path},
getPathData:function(points,closePath){var path="";for(var i=0;i<points.length;i++)path+=this.getPathCommand(points,i);if(closePath){path+=this.getPathCommand(points,-1);path+=" Z"}return path},brushToRgba:function(brush){var sColor=brush.color.toLowerCase();var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1)sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));sColor=sColorNew}var sColorChange=[];for(var i=1;i<
7;i+=2)sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));return"RGBA("+sColorChange.join(",")+","+brush.opacity+")"}else return sColor},getEnhancedBoundary:function(boundary){var left=boundary.left;var top=boundary.top;var right=boundary.right;var bottom=boundary.bottom;var width=right-left;var height=bottom-top;if(width<0){width*=-1;left=right;right=left+width}if(height<0){height*=-1;top=bottom;bottom=top+height}return{left:left,top:top,right:right,bottom:bottom,width:width,height:height,cx:left+
width/2,cy:top+height/2,rx:width/2,ry:height/2}},isLocal:function(){var protocol=document.location.protocol;return protocol!="https:"&&protocol!="http:"}});window.Player=Player})();var ShapeTypes={Other:0,Line:1,Rectangle:2,Ellipse:4,Polygon:8,Polyline:16,Freeline:32,Label:64};Array.prototype.getByKey=function(key){for(var i=0;i<this.length;i++){var item=this[i];if(item[0]==key)return item[1]}return null};
Element.prototype.createChildNS=function(tag,param,textContent,addToFirst){var svgns="http://www.w3.org/2000/svg";var element=document.createElementNS(svgns,tag);if(addToFirst&&this.hasChildNodes())this.insertBefore(element,this.firstChild);else this.appendChild(element);if(param)for(var key in param)element.setAttribute(key,param[key]);if(textContent)element.textContent=textContent;return element};
Element.prototype.updateStyle=function(key,value){var oldStyle=this.getAttribute("style");var keyExisting=false;var newStyle="";if(oldStyle!=null&&oldStyle.trim().length>0){var keyValuePairs=oldStyle.split(";");for(var i=0;i<keyValuePairs.length&&keyValuePairs[i].trim().length>0;i++){var keyAndValue=keyValuePairs[i].split(":");if(keyAndValue.length!=2)continue;if(key==keyAndValue[0].trim()){keyExisting=true;if(value!=null)newStyle+=key+": "+value+"; ";else;}else newStyle+=keyAndValue[0].trim()+": "+
keyAndValue[1].trim()+"; "}}if(!keyExisting)newStyle+=key+": "+value+"; ";this.setAttribute("style",newStyle)};String.prototype.format=function(){var args=arguments;return this.replace(/\{(\d+)\}/g,function(m,i){return args[i]})};
